name: Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  quality-gate:
    name: Comprehensive Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: loyalty
          POSTGRES_PASSWORD: loyalty_pass
          POSTGRES_DB: loyalty_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
            frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: ðŸ” TypeScript Type Checking
        run: |
          echo "ðŸ” Running TypeScript checks..."
          npm run typecheck

      - name: ðŸ§¹ ESLint Code Quality
        run: |
          echo "ðŸ§¹ Running ESLint checks..."
          npm run lint

      - name: ðŸ—ï¸ Build Verification
        run: |
          echo "ðŸ—ï¸ Verifying builds..."
          npm run build

      - name: ðŸ§ª Unit Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          cd backend && npm run test:unit
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://loyalty:loyalty_pass@localhost:5432/loyalty_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-minimum-32-characters-long
          JWT_REFRESH_SECRET: test-refresh-secret-key-minimum-32-characters-long
          SESSION_SECRET: test-session-secret-key-minimum-32-characters-long

      - name: ðŸ”— Integration Tests
        run: |
          echo "ðŸ”— Running integration tests..."
          cd backend && npm run test:integration
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://loyalty:loyalty_pass@localhost:5432/loyalty_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-minimum-32-characters-long
          JWT_REFRESH_SECRET: test-refresh-secret-key-minimum-32-characters-long
          SESSION_SECRET: test-session-secret-key-minimum-32-characters-long

      - name: ðŸ›¡ï¸ Security Audit
        run: |
          echo "ðŸ›¡ï¸ Running security audit..."
          npm audit --audit-level=moderate
          cd backend && npm audit --audit-level=moderate
          cd ../frontend && npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ“Š Test Coverage
        run: |
          echo "ðŸ“Š Generating test coverage..."
          cd backend && npm run test:coverage
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://loyalty:loyalty_pass@localhost:5432/loyalty_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-minimum-32-characters-long
          JWT_REFRESH_SECRET: test-refresh-secret-key-minimum-32-characters-long
          SESSION_SECRET: test-session-secret-key-minimum-32-characters-long

      - name: ðŸ“ˆ Upload Coverage Reports
        if: success()
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: unittests
          name: backend-coverage
          fail_ci_if_error: false

      - name: âœ… Quality Gate Summary
        if: success()
        run: |
          echo "ðŸŽ‰ Quality Gate PASSED!"
          echo "âœ… TypeScript compilation successful"
          echo "âœ… ESLint checks passed"
          echo "âœ… Build verification successful"
          echo "âœ… Unit tests passed"
          echo "âœ… Integration tests passed"
          echo "âœ… Security audit completed"
          echo "âœ… Test coverage generated"

      - name: âŒ Quality Gate Failed
        if: failure()
        run: |
          echo "âŒ Quality Gate FAILED!"
          echo "Please fix the issues above before merging."
          exit 1

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-gate
    if: github.event_name != 'pull_request' || github.base_ref == 'main'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: loyalty
          POSTGRES_PASSWORD: loyalty_pass
          POSTGRES_DB: loyalty_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
            frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸš€ Start Application
        run: |
          # Start backend
          cd backend && npm start &
          BACKEND_PID=$!
          
          # Start frontend
          cd ../frontend && npm run preview &
          FRONTEND_PID=$!
          
          # Wait for services to be ready
          sleep 10
          
          # Check if services are running
          curl -f http://localhost:4000/api/health || exit 1
          
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
        env:
          NODE_ENV: production
          DATABASE_URL: postgresql://loyalty:loyalty_pass@localhost:5432/loyalty_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-minimum-32-characters-long
          JWT_REFRESH_SECRET: test-refresh-secret-key-minimum-32-characters-long
          SESSION_SECRET: test-session-secret-key-minimum-32-characters-long

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install chromium

      - name: ðŸ§ª Run E2E Tests
        run: npm run test:e2e
        continue-on-error: true

      - name: ðŸ“¸ Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          # Kill background processes
          [[ -n "$BACKEND_PID" ]] && kill $BACKEND_PID || true
          [[ -n "$FRONTEND_PID" ]] && kill $FRONTEND_PID || true