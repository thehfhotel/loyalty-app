name: Claude Auto-Fix Pipeline Issues

on:
  workflow_run:
    workflows: ["Optimized CI/CD Pipeline with Security & Testing"]
    types: [completed]
    branches-ignore:
      - main

# SECURITY: Top-level permissions set to minimal read-only
# Write permissions granted at job-level (principle of least privilege)
permissions:
  contents: read
  actions: read
  pull-requests: read
  checks: read

env:
  MAX_RETRIES: 2

jobs:
  # =============================================================================
  # Detect if there are issues to fix (failures or warnings)
  # =============================================================================
  detect-issues:
    name: "üîç Detect Issues"
    runs-on: self-hosted
    if: "!startsWith(github.event.workflow_run.head_commit.message, '[claude-fix]')"
    outputs:
      has-failures: ${{ steps.check.outputs.has-failures }}
      has-warnings: ${{ steps.check.outputs.has-warnings }}
      should-fix: ${{ steps.check.outputs.should-fix }}
      issue-type: ${{ steps.check.outputs.issue-type }}

    steps:
      - name: "üîç Check for failures and warnings"
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          CHECK_SUITE_ID: ${{ github.event.workflow_run.check_suite_id }}
        run: |
          echo "Run ID: $WORKFLOW_RUN_ID"
          echo "Conclusion: $WORKFLOW_CONCLUSION"

          # Check for failures
          if [ "$WORKFLOW_CONCLUSION" == "failure" ]; then
            echo "has-failures=true" >> $GITHUB_OUTPUT
          else
            echo "has-failures=false" >> $GITHUB_OUTPUT
          fi

          # Check for warnings via annotations API
          WARNINGS=$(gh api "repos/${{ github.repository }}/check-runs?check_suite_id=$CHECK_SUITE_ID" \
            --jq '[.check_runs[].output.annotations[]? | select(.annotation_level == "warning")] | length' 2>/dev/null || echo "0")

          echo "Warning count: $WARNINGS"

          if [ "$WARNINGS" -gt 0 ]; then
            echo "has-warnings=true" >> $GITHUB_OUTPUT
          else
            echo "has-warnings=false" >> $GITHUB_OUTPUT
          fi

          # Determine if we should fix
          if [ "$WORKFLOW_CONCLUSION" == "failure" ]; then
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "issue-type=failure" >> $GITHUB_OUTPUT
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "issue-type=warnings" >> $GITHUB_OUTPUT
          else
            echo "should-fix=false" >> $GITHUB_OUTPUT
            echo "issue-type=none" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # Auto-fix failures and warnings
  # =============================================================================
  auto-fix:
    name: "ü§ñ Claude Auto-Fix"
    runs-on: self-hosted
    needs: detect-issues
    if: needs.detect-issues.outputs.should-fix == 'true'
    permissions:
      contents: write      # For pushing code fixes
      actions: write       # For workflow management
      pull-requests: write # For PR comments

    steps:
      # =========================================================================
      # SECURITY: Validate this is from a trusted source before processing
      # This mitigates "untrusted code checkout" vulnerability (CWE-829)
      # Ref: https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/
      # =========================================================================
      - name: "üîí Validate trusted author"
        id: validate-author
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          ACTOR: ${{ github.event.workflow_run.actor.login }}
          TRIGGERING_ACTOR: ${{ github.event.workflow_run.triggering_actor.login }}
        run: |
          echo "Validating author: $ACTOR (triggered by: $TRIGGERING_ACTOR)"

          # Get the repository owner
          REPO_OWNER="${{ github.repository_owner }}"

          # Check if the actor is the repository owner
          if [ "$ACTOR" == "$REPO_OWNER" ]; then
            echo "‚úÖ Author is repository owner"
            echo "trusted=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if the actor is a collaborator with write access
          PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/$ACTOR/permission" \
            --jq '.permission' 2>/dev/null || echo "none")

          echo "Author permission level: $PERMISSION"

          if [ "$PERMISSION" == "admin" ] || [ "$PERMISSION" == "write" ]; then
            echo "‚úÖ Author is a trusted collaborator with $PERMISSION access"
            echo "trusted=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Author is not a trusted collaborator (permission: $PERMISSION)"
            echo "‚ö†Ô∏è Skipping auto-fix for security reasons"
            echo "trusted=false" >> $GITHUB_OUTPUT
          fi

      - name: "üîç Check if branch still exists"
        if: steps.validate-author.outputs.trusted == 'true'
        id: check-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Check if the branch still exists (might have been merged/deleted)
          if gh api "repos/${{ github.repository }}/branches/$HEAD_BRANCH" --silent 2>/dev/null; then
            echo "Branch $HEAD_BRANCH exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Branch $HEAD_BRANCH no longer exists (likely merged/deleted)"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # =========================================================================
      # SECURITY: Checkout trusted main branch first, then fetch the PR branch
      # This avoids the "untrusted code checkout" pattern flagged by Scorecard
      # by not using untrusted refs directly in actions/checkout
      # =========================================================================
      - name: "üì• Checkout trusted base"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          ref: main
          fetch-depth: 0

      - name: "üîÄ Fetch and switch to PR branch"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'true'
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Fetch the PR branch (already validated as trusted)
          git fetch origin "$HEAD_BRANCH"
          # Switch to the PR branch
          git checkout -B "$HEAD_BRANCH" "origin/$HEAD_BRANCH"
          echo "‚úÖ Now on branch: $(git branch --show-current)"

      - name: "üìã Check retry count"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'true'
        id: check-retry
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Count consecutive [claude-fix] commits at HEAD
          RETRY_COUNT=0
          for i in $(seq 0 ${{ env.MAX_RETRIES }}); do
            COMMIT_MSG=$(git log -1 --skip=$i --format="%s" 2>/dev/null || echo "")
            if [[ "$COMMIT_MSG" == "[claude-fix]"* ]]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
            else
              break
            fi
          done

          echo "Consecutive [claude-fix] commits: $RETRY_COUNT"

          if [ "$RETRY_COUNT" -ge "${{ env.MAX_RETRIES }}" ]; then
            echo "‚ùå Max retries (${{ env.MAX_RETRIES }}) reached for branch: $HEAD_BRANCH"
            echo "should-fix=false" >> $GITHUB_OUTPUT
          else
            NEW_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $NEW_COUNT of ${{ env.MAX_RETRIES }}"
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "attempt=$NEW_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: "üìú Get workflow logs and annotations"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'true' && steps.check-retry.outputs.should-fix == 'true'
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          CHECK_SUITE_ID: ${{ github.event.workflow_run.check_suite_id }}
          ISSUE_TYPE: ${{ needs.detect-issues.outputs.issue-type }}
        run: |
          echo "Fetching logs for run: $WORKFLOW_RUN_ID (issue type: $ISSUE_TYPE)"

          # Get failed job logs if failure
          if [ "$ISSUE_TYPE" == "failure" ]; then
            gh run view "$WORKFLOW_RUN_ID" --log-failed > /tmp/failed-logs.txt 2>&1 || true

            gh run view "$WORKFLOW_RUN_ID" --json jobs \
              --jq '.jobs[] | select(.conclusion == "failure") | {name: .name, conclusion: .conclusion}' \
              > /tmp/failed-jobs.json 2>&1 || true
          fi

          # Get all logs for context
          gh run view "$WORKFLOW_RUN_ID" --log > /tmp/full-logs.txt 2>&1 || true

          # Get annotations (warnings and errors)
          gh api "repos/${{ github.repository }}/check-runs?check_suite_id=$CHECK_SUITE_ID" \
            --jq '.check_runs[].output.annotations[]? | select(.annotation_level == "warning" or .annotation_level == "failure") | {level: .annotation_level, path: .path, line: .start_line, message: .message}' \
            > /tmp/annotations.json 2>&1 || true

          echo "=== Annotations ==="
          cat /tmp/annotations.json || echo "No annotations"

          # Extract error/warning context from logs
          if [ -f /tmp/failed-logs.txt ] && [ -s /tmp/failed-logs.txt ]; then
            grep -A 50 -B 5 -i "error\|failed\|Error:\|FAIL\|TypeError\|SyntaxError" /tmp/failed-logs.txt | tail -1000 > /tmp/error-context.txt || true
          fi

          # Also grep warnings from full logs
          grep -i "warning\|warn\|‚ö†" /tmp/full-logs.txt | tail -200 > /tmp/warning-context.txt 2>/dev/null || true

          # Combine contexts
          cat /tmp/error-context.txt /tmp/warning-context.txt > /tmp/combined-context.txt 2>/dev/null || true

          if [ ! -s /tmp/combined-context.txt ]; then
            tail -500 /tmp/full-logs.txt > /tmp/combined-context.txt 2>/dev/null || true
          fi

          echo "logs-ready=true" >> $GITHUB_OUTPUT

      - name: "ü§ñ Claude analyzes and fixes"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-retry.outputs.should-fix == 'true' && steps.get-logs.outputs.logs-ready == 'true'
        id: claude-fix
        env:
          ISSUE_TYPE: ${{ needs.detect-issues.outputs.issue-type }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          ATTEMPT: ${{ steps.check-retry.outputs.attempt }}
        run: |
          # Prepare context
          FAILED_JOBS=$(cat /tmp/failed-jobs.json 2>/dev/null || echo "N/A")
          ANNOTATIONS=$(cat /tmp/annotations.json 2>/dev/null || echo "No annotations")
          LOGS=$(cat /tmp/combined-context.txt 2>/dev/null | head -800 || echo "No logs available")

          echo "ü§ñ Running Claude to analyze and fix pipeline issues..."
          echo "Issue type: $ISSUE_TYPE"
          echo "Branch: $HEAD_BRANCH"
          echo "Attempt: $ATTEMPT of ${{ env.MAX_RETRIES }}"

          # Create prompt
          cat > /tmp/claude-prompt.txt << 'PROMPT_END'
          You are fixing CI/CD pipeline issues. Analyze the errors/warnings and fix them.

          ISSUE TYPE: ISSUE_TYPE_PLACEHOLDER

          IMPORTANT RULES:
          - Only modify files that are directly related to the errors/warnings
          - NEVER modify .github/workflows/*.yml files (no permission to push workflow changes)
          - Do not skip tests or add test.skip()
          - Do not add meaningless assertions like expect(true).toBe(true)
          - Do not modify unrelated code
          - Make minimal, focused fixes
          - Fix ALL warnings shown in annotations, not just errors
          - If the issue is in workflow files, explain what needs to be changed but do not edit them

          BRANCH: BRANCH_PLACEHOLDER
          ATTEMPT: ATTEMPT_PLACEHOLDER of MAX_RETRIES_PLACEHOLDER

          ANNOTATIONS (warnings and errors from GitHub):
          ANNOTATIONS_PLACEHOLDER

          FAILED JOBS:
          FAILED_JOBS_PLACEHOLDER

          LOG CONTEXT:
          PROMPT_END

          # Replace placeholders
          sed -i "s|ISSUE_TYPE_PLACEHOLDER|$ISSUE_TYPE|g" /tmp/claude-prompt.txt
          sed -i "s|BRANCH_PLACEHOLDER|$HEAD_BRANCH|g" /tmp/claude-prompt.txt
          sed -i "s|ATTEMPT_PLACEHOLDER|$ATTEMPT|g" /tmp/claude-prompt.txt
          sed -i "s|MAX_RETRIES_PLACEHOLDER|${{ env.MAX_RETRIES }}|g" /tmp/claude-prompt.txt

          # Append data (avoid sed issues with special chars)
          echo "" >> /tmp/claude-prompt.txt
          echo "ANNOTATIONS:" >> /tmp/claude-prompt.txt
          cat /tmp/annotations.json >> /tmp/claude-prompt.txt 2>/dev/null || echo "None"
          echo "" >> /tmp/claude-prompt.txt
          echo "FAILED JOBS:" >> /tmp/claude-prompt.txt
          echo "$FAILED_JOBS" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "LOG CONTEXT:" >> /tmp/claude-prompt.txt
          cat /tmp/combined-context.txt >> /tmp/claude-prompt.txt 2>/dev/null || true

          # Run Claude
          # SECURITY: Only allow file read/write operations, NO script execution
          # This prevents execution of potentially malicious npm scripts from untrusted checkouts
          # Ref: https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/
          CLAUDE_OUTPUT=$(claude -p "$(cat /tmp/claude-prompt.txt)" \
            --allowedTools "Read,Edit,Write,Glob,Grep" \
            2>&1) || true

          echo "Claude output:"
          echo "$CLAUDE_OUTPUT" | tail -100

          # Check if any files were modified
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes made by Claude"
            echo "changes-made=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changes-made=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: "üìù Commit and push fix"
        if: steps.validate-author.outputs.trusted == 'true' && steps.claude-fix.outputs.changes-made == 'true'
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          ATTEMPT: ${{ steps.check-retry.outputs.attempt }}
          ISSUE_TYPE: ${{ needs.detect-issues.outputs.issue-type }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          git config user.name "Claude Auto-Fix"
          git config user.email "claude-fix@github-actions"

          if [ "$ISSUE_TYPE" == "failure" ]; then
            COMMIT_MSG="[claude-fix] Auto-fix pipeline failure (attempt $ATTEMPT/${{ env.MAX_RETRIES }})"
          else
            COMMIT_MSG="[claude-fix] Auto-fix pipeline warnings (attempt $ATTEMPT/${{ env.MAX_RETRIES }})"
          fi

          git add -A
          git commit -m "$COMMIT_MSG

          Automated fix for workflow run: $WORKFLOW_RUN_ID
          Issue type: $ISSUE_TYPE
          Branch: $HEAD_BRANCH

          ü§ñ Generated with Claude Code" || echo "Nothing to commit"

          git push origin "$HEAD_BRANCH"

          echo "‚úÖ Fix committed and pushed to $HEAD_BRANCH"

      - name: "üí¨ Notify PR about fix (CI won't auto-trigger)"
        if: steps.validate-author.outputs.trusted == 'true' && steps.claude-fix.outputs.changes-made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          REPO_NAME: ${{ github.repository }}
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)

          # Find PR for this branch
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$PR_NUMBER" ]; then
            # Write comment to temp file to avoid YAML escaping issues
            {
              echo "## ü§ñ Claude Auto-Fix Applied"
              echo ""
              echo "A fix has been pushed to this branch: \`$SHORT_SHA\`"
              echo ""
              echo "### ‚ö†Ô∏è Action Required: Trigger CI Pipeline"
              echo ""
              echo "GitHub Actions cannot trigger workflows from GITHUB_TOKEN commits. Manually trigger CI:"
              echo ""
              echo "**Option 1:** Push an empty commit"
              echo "\`\`\`"
              echo "git pull && git commit --allow-empty -m 'chore: trigger CI' && git push"
              echo "\`\`\`"
              echo ""
              echo "**Option 2:** Re-run from [Actions](https://github.com/$REPO_NAME/actions) page"
            } > /tmp/pr-comment.md

            gh pr comment "$PR_NUMBER" --body-file /tmp/pr-comment.md
            echo "‚úÖ Posted notification to PR #$PR_NUMBER"
          else
            echo "‚ö†Ô∏è No PR found for branch $HEAD_BRANCH - skipping notification"
          fi

      - name: "üîí Report: Untrusted author"
        if: steps.validate-author.outputs.trusted == 'false'
        env:
          ACTOR: ${{ github.event.workflow_run.actor.login }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          echo "üîí Security: Skipping auto-fix for untrusted author"
          echo ""
          echo "ü§ñ Claude Auto-Fix Report"
          echo "========================="
          echo "‚ö†Ô∏è Auto-fix skipped for security reasons"
          echo "Author: $ACTOR (not a trusted collaborator)"
          echo "Branch: $HEAD_BRANCH"
          echo "Run: $WORKFLOW_RUN_ID"
          echo ""
          echo "Only repository owners and collaborators with write access can trigger auto-fix."
          echo "This prevents potential code injection from untrusted pull requests."
          echo "Ref: https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/"

      - name: "üìä Report: Branch no longer exists"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'false'
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          echo "‚ÑπÔ∏è Branch no longer exists - nothing to fix"
          echo ""
          echo "ü§ñ Claude Auto-Fix Report"
          echo "========================="
          echo "Branch: $HEAD_BRANCH (deleted/merged)"
          echo "Triggering run: $WORKFLOW_RUN_ID"
          echo ""
          echo "The branch was likely merged or deleted before auto-fix could run."
          echo "No action needed."

      - name: "üìä Report: No fix possible"
        if: steps.validate-author.outputs.trusted == 'true' && steps.check-branch.outputs.exists == 'true' && (steps.claude-fix.outputs.changes-made == 'false' || steps.check-retry.outputs.should-fix == 'false')
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          ISSUE_TYPE: ${{ needs.detect-issues.outputs.issue-type }}
          SHOULD_FIX: ${{ steps.check-retry.outputs.should-fix }}
        run: |
          if [ "$SHOULD_FIX" == "false" ]; then
            echo "‚ùå Max retries reached. Manual intervention required."
            echo ""
            echo "ü§ñ Claude Auto-Fix Report"
            echo "========================="
            echo "‚ùå Max retries (${{ env.MAX_RETRIES }}) reached for branch: $HEAD_BRANCH"
            echo "Issue type: $ISSUE_TYPE"
            echo "Manual intervention required."
            echo "Failed run: $WORKFLOW_RUN_ID"
          else
            echo "‚ùå Claude could not automatically fix this issue."
            echo ""
            echo "ü§ñ Claude Auto-Fix Report"
            echo "========================="
            echo "‚ö†Ô∏è Could not automatically fix the pipeline $ISSUE_TYPE."
            echo "Branch: $HEAD_BRANCH"
            echo "Please review the run manually: $WORKFLOW_RUN_ID"
          fi
