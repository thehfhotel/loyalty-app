name: Claude Auto-Fix Pipeline Issues

on:
  workflow_run:
    workflows: ["Optimized CI/CD Pipeline with Security & Testing"]
    types: [completed]
    branches-ignore:
      - main

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: read

env:
  MAX_RETRIES: 2

jobs:
  # =============================================================================
  # Detect if there are issues to fix (failures or warnings)
  # =============================================================================
  detect-issues:
    name: "üîç Detect Issues"
    runs-on: self-hosted
    if: "!startsWith(github.event.workflow_run.head_commit.message, '[claude-fix]')"
    outputs:
      has-failures: ${{ steps.check.outputs.has-failures }}
      has-warnings: ${{ steps.check.outputs.has-warnings }}
      should-fix: ${{ steps.check.outputs.should-fix }}
      issue-type: ${{ steps.check.outputs.issue-type }}

    steps:
      - name: "üîç Check for failures and warnings"
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Run ID: $RUN_ID"
          echo "Conclusion: $CONCLUSION"

          # Check for failures
          if [ "$CONCLUSION" == "failure" ]; then
            echo "has-failures=true" >> $GITHUB_OUTPUT
          else
            echo "has-failures=false" >> $GITHUB_OUTPUT
          fi

          # Check for warnings via annotations API
          WARNINGS=$(gh api "repos/${{ github.repository }}/check-runs?check_suite_id=${{ github.event.workflow_run.check_suite_id }}" \
            --jq '[.check_runs[].output.annotations[]? | select(.annotation_level == "warning")] | length' 2>/dev/null || echo "0")

          echo "Warning count: $WARNINGS"

          if [ "$WARNINGS" -gt 0 ]; then
            echo "has-warnings=true" >> $GITHUB_OUTPUT
          else
            echo "has-warnings=false" >> $GITHUB_OUTPUT
          fi

          # Determine if we should fix
          if [ "$CONCLUSION" == "failure" ]; then
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "issue-type=failure" >> $GITHUB_OUTPUT
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "issue-type=warnings" >> $GITHUB_OUTPUT
          else
            echo "should-fix=false" >> $GITHUB_OUTPUT
            echo "issue-type=none" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # Auto-fix failures and warnings
  # =============================================================================
  auto-fix:
    name: "ü§ñ Claude Auto-Fix"
    runs-on: self-hosted
    needs: detect-issues
    if: needs.detect-issues.outputs.should-fix == 'true'

    steps:
      - name: "üì• Checkout branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 20

      - name: "üìã Check retry count"
        id: check-retry
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          # Count consecutive [claude-fix] commits at HEAD
          RETRY_COUNT=0
          for i in $(seq 0 ${{ env.MAX_RETRIES }}); do
            COMMIT_MSG=$(git log -1 --skip=$i --format="%s" 2>/dev/null || echo "")
            if [[ "$COMMIT_MSG" == "[claude-fix]"* ]]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
            else
              break
            fi
          done

          echo "Consecutive [claude-fix] commits: $RETRY_COUNT"

          if [ "$RETRY_COUNT" -ge "${{ env.MAX_RETRIES }}" ]; then
            echo "‚ùå Max retries (${{ env.MAX_RETRIES }}) reached for branch: $BRANCH"
            echo "should-fix=false" >> $GITHUB_OUTPUT
          else
            NEW_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $NEW_COUNT of ${{ env.MAX_RETRIES }}"
            echo "should-fix=true" >> $GITHUB_OUTPUT
            echo "attempt=$NEW_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: "üìú Get workflow logs and annotations"
        if: steps.check-retry.outputs.should-fix == 'true'
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          ISSUE_TYPE="${{ needs.detect-issues.outputs.issue-type }}"

          echo "Fetching logs for run: $RUN_ID (issue type: $ISSUE_TYPE)"

          # Get failed job logs if failure
          if [ "$ISSUE_TYPE" == "failure" ]; then
            gh run view "$RUN_ID" --log-failed > /tmp/failed-logs.txt 2>&1 || true

            gh run view "$RUN_ID" --json jobs \
              --jq '.jobs[] | select(.conclusion == "failure") | {name: .name, conclusion: .conclusion}' \
              > /tmp/failed-jobs.json 2>&1 || true
          fi

          # Get all logs for context
          gh run view "$RUN_ID" --log > /tmp/full-logs.txt 2>&1 || true

          # Get annotations (warnings and errors)
          gh api "repos/${{ github.repository }}/check-runs?check_suite_id=${{ github.event.workflow_run.check_suite_id }}" \
            --jq '.check_runs[].output.annotations[]? | select(.annotation_level == "warning" or .annotation_level == "failure") | {level: .annotation_level, path: .path, line: .start_line, message: .message}' \
            > /tmp/annotations.json 2>&1 || true

          echo "=== Annotations ==="
          cat /tmp/annotations.json || echo "No annotations"

          # Extract error/warning context from logs
          if [ -f /tmp/failed-logs.txt ] && [ -s /tmp/failed-logs.txt ]; then
            grep -A 50 -B 5 -i "error\|failed\|Error:\|FAIL\|TypeError\|SyntaxError" /tmp/failed-logs.txt | tail -1000 > /tmp/error-context.txt || true
          fi

          # Also grep warnings from full logs
          grep -i "warning\|warn\|‚ö†" /tmp/full-logs.txt | tail -200 > /tmp/warning-context.txt 2>/dev/null || true

          # Combine contexts
          cat /tmp/error-context.txt /tmp/warning-context.txt > /tmp/combined-context.txt 2>/dev/null || true

          if [ ! -s /tmp/combined-context.txt ]; then
            tail -500 /tmp/full-logs.txt > /tmp/combined-context.txt 2>/dev/null || true
          fi

          echo "logs-ready=true" >> $GITHUB_OUTPUT

      - name: "ü§ñ Claude analyzes and fixes"
        if: steps.check-retry.outputs.should-fix == 'true' && steps.get-logs.outputs.logs-ready == 'true'
        id: claude-fix
        run: |
          ISSUE_TYPE="${{ needs.detect-issues.outputs.issue-type }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ATTEMPT="${{ steps.check-retry.outputs.attempt }}"

          # Prepare context
          FAILED_JOBS=$(cat /tmp/failed-jobs.json 2>/dev/null || echo "N/A")
          ANNOTATIONS=$(cat /tmp/annotations.json 2>/dev/null || echo "No annotations")
          LOGS=$(cat /tmp/combined-context.txt 2>/dev/null | head -800 || echo "No logs available")

          echo "ü§ñ Running Claude to analyze and fix pipeline issues..."
          echo "Issue type: $ISSUE_TYPE"
          echo "Branch: $BRANCH"
          echo "Attempt: $ATTEMPT of ${{ env.MAX_RETRIES }}"

          # Create prompt
          cat > /tmp/claude-prompt.txt << 'PROMPT_END'
          You are fixing CI/CD pipeline issues. Analyze the errors/warnings and fix them.

          ISSUE TYPE: ISSUE_TYPE_PLACEHOLDER

          IMPORTANT RULES:
          - Only modify files that are directly related to the errors/warnings
          - NEVER modify .github/workflows/*.yml files (no permission to push workflow changes)
          - Do not skip tests or add test.skip()
          - Do not add meaningless assertions like expect(true).toBe(true)
          - Do not modify unrelated code
          - Make minimal, focused fixes
          - Fix ALL warnings shown in annotations, not just errors
          - If the issue is in workflow files, explain what needs to be changed but do not edit them

          BRANCH: BRANCH_PLACEHOLDER
          ATTEMPT: ATTEMPT_PLACEHOLDER of MAX_RETRIES_PLACEHOLDER

          ANNOTATIONS (warnings and errors from GitHub):
          ANNOTATIONS_PLACEHOLDER

          FAILED JOBS:
          FAILED_JOBS_PLACEHOLDER

          LOG CONTEXT:
          PROMPT_END

          # Replace placeholders
          sed -i "s|ISSUE_TYPE_PLACEHOLDER|$ISSUE_TYPE|g" /tmp/claude-prompt.txt
          sed -i "s|BRANCH_PLACEHOLDER|$BRANCH|g" /tmp/claude-prompt.txt
          sed -i "s|ATTEMPT_PLACEHOLDER|$ATTEMPT|g" /tmp/claude-prompt.txt
          sed -i "s|MAX_RETRIES_PLACEHOLDER|${{ env.MAX_RETRIES }}|g" /tmp/claude-prompt.txt

          # Append data (avoid sed issues with special chars)
          echo "" >> /tmp/claude-prompt.txt
          echo "ANNOTATIONS:" >> /tmp/claude-prompt.txt
          cat /tmp/annotations.json >> /tmp/claude-prompt.txt 2>/dev/null || echo "None"
          echo "" >> /tmp/claude-prompt.txt
          echo "FAILED JOBS:" >> /tmp/claude-prompt.txt
          echo "$FAILED_JOBS" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "LOG CONTEXT:" >> /tmp/claude-prompt.txt
          cat /tmp/combined-context.txt >> /tmp/claude-prompt.txt 2>/dev/null || true

          # Run Claude
          CLAUDE_OUTPUT=$(claude -p "$(cat /tmp/claude-prompt.txt)" \
            --allowedTools "Read,Edit,Write,Glob,Grep,Bash(npm run lint:*),Bash(npm run typecheck:*),Bash(npm test:*)" \
            2>&1) || true

          echo "Claude output:"
          echo "$CLAUDE_OUTPUT" | tail -100

          # Check if any files were modified
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes made by Claude"
            echo "changes-made=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changes-made=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: "üìù Commit and push fix"
        if: steps.claude-fix.outputs.changes-made == 'true'
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ATTEMPT="${{ steps.check-retry.outputs.attempt }}"
          ISSUE_TYPE="${{ needs.detect-issues.outputs.issue-type }}"

          git config user.name "Claude Auto-Fix"
          git config user.email "claude-fix@github-actions"

          if [ "$ISSUE_TYPE" == "failure" ]; then
            COMMIT_MSG="[claude-fix] Auto-fix pipeline failure (attempt $ATTEMPT/${{ env.MAX_RETRIES }})"
          else
            COMMIT_MSG="[claude-fix] Auto-fix pipeline warnings (attempt $ATTEMPT/${{ env.MAX_RETRIES }})"
          fi

          git add -A
          git commit -m "$COMMIT_MSG

          Automated fix for workflow run: ${{ github.event.workflow_run.id }}
          Issue type: $ISSUE_TYPE
          Branch: $BRANCH

          ü§ñ Generated with Claude Code" || echo "Nothing to commit"

          git push origin "$BRANCH"

          echo "‚úÖ Fix committed and pushed to $BRANCH"

      - name: "üí¨ Notify PR about fix (CI won't auto-trigger)"
        if: steps.claude-fix.outputs.changes-made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)

          # Find PR for this branch
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$PR_NUMBER" ]; then
            COMMENT_BODY="## ü§ñ Claude Auto-Fix Applied

A fix has been pushed to this branch: \`$SHORT_SHA\`

### ‚ö†Ô∏è Action Required: Trigger CI Pipeline

GitHub's security feature prevents workflows from triggering other workflows when using \`GITHUB_TOKEN\`. You need to manually trigger the CI:

**Option 1: Push an empty commit** (recommended)
\`\`\`bash
git pull
git commit --allow-empty -m \"chore: trigger CI\"
git push
\`\`\`

**Option 2: Re-run from GitHub UI**
1. Go to [Actions](/${{ github.repository }}/actions)
2. Find the failed workflow run
3. Click \"Re-run all jobs\" (make sure to select the latest commit)

---
*This message was generated because commits pushed by GitHub Actions cannot trigger other workflows.*"

            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
            echo "‚úÖ Posted notification to PR #$PR_NUMBER"
          else
            echo "‚ö†Ô∏è No PR found for branch $BRANCH - skipping notification"
          fi

      - name: "üìä Report: No fix possible"
        if: steps.claude-fix.outputs.changes-made == 'false' || steps.check-retry.outputs.should-fix == 'false'
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          ISSUE_TYPE="${{ needs.detect-issues.outputs.issue-type }}"

          if [ "${{ steps.check-retry.outputs.should-fix }}" == "false" ]; then
            echo "‚ùå Max retries reached. Manual intervention required."
            echo ""
            echo "ü§ñ Claude Auto-Fix Report"
            echo "========================="
            echo "‚ùå Max retries (${{ env.MAX_RETRIES }}) reached for branch: $BRANCH"
            echo "Issue type: $ISSUE_TYPE"
            echo "Manual intervention required."
            echo "Failed run: $RUN_ID"
          else
            echo "‚ùå Claude could not automatically fix this issue."
            echo ""
            echo "ü§ñ Claude Auto-Fix Report"
            echo "========================="
            echo "‚ö†Ô∏è Could not automatically fix the pipeline $ISSUE_TYPE."
            echo "Branch: $BRANCH"
            echo "Please review the run manually: $RUN_ID"
          fi
