name: Claude PR Assistant

on:
  issue_comment:
    types: [created]

# SECURITY: Top-level permissions set to minimal read-only
# Write permissions granted at job-level (principle of least privilege)
permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  claude-assist:
    name: "ü§ñ Claude PR Assistant"
    runs-on: self-hosted
    permissions:
      contents: write      # For pushing code changes
      pull-requests: write # For PR comments and reactions
      issues: write        # For issue reactions
    # Only run on PR comments (not issue comments) that mention @claude
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')

    steps:
      - name: "üîê Check permissions"
        id: check-permission
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          # Get commenter's permission level
          PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/$COMMENT_USER/permission" --jq '.permission' 2>/dev/null || echo "none")

          echo "User: $COMMENT_USER"
          echo "Permission: $PERMISSION"

          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" || "$PERMISSION" == "maintain" ]]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "‚ùå User does not have write permission"
          fi

      - name: "üëÄ React to comment"
        if: steps.check-permission.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          # Add eyes reaction to show we're processing
          gh api "repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions" \
            -f content='eyes' || true

      - name: "üì• Get PR details"
        if: steps.check-permission.outputs.allowed == 'true'
        id: pr-details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get PR branch info
          PR_DATA=$(gh pr view "$ISSUE_NUMBER" --json headRefName,headRepository,headRepositoryOwner,baseRefName)
          HEAD_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.baseRefName')

          echo "pr-number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "head-branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
          echo "base-branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

          echo "PR #$ISSUE_NUMBER: $HEAD_BRANCH -> $BASE_BRANCH"

      - name: "üì• Checkout PR branch"
        if: steps.check-permission.outputs.allowed == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          ref: ${{ steps.pr-details.outputs.head-branch }}
          fetch-depth: 50

      - name: "üìú Get PR context"
        if: steps.check-permission.outputs.allowed == 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-details.outputs.pr-number }}
          BASE_BRANCH: ${{ steps.pr-details.outputs.base-branch }}
        run: |
          # Get PR diff
          gh pr diff "$PR_NUMBER" > /tmp/pr-diff.txt 2>/dev/null || true

          # Get PR description
          gh pr view "$PR_NUMBER" --json body --jq '.body' > /tmp/pr-body.txt 2>/dev/null || true

          # Get changed files list
          gh pr view "$PR_NUMBER" --json files --jq '.files[].path' > /tmp/changed-files.txt 2>/dev/null || true

          echo "Context gathered for PR #$PR_NUMBER"

      - name: "ü§ñ Run Claude"
        if: steps.check-permission.outputs.allowed == 'true'
        id: claude
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ steps.pr-details.outputs.pr-number }}
          HEAD_BRANCH: ${{ steps.pr-details.outputs.head-branch }}
          BASE_BRANCH: ${{ steps.pr-details.outputs.base-branch }}
        run: |
          # Extract the instruction from the comment (everything after @claude)
          INSTRUCTION=$(echo "$COMMENT_BODY" | sed 's/.*@claude//' | xargs)

          echo "Instruction: $INSTRUCTION"

          # Prepare context
          PR_DIFF=$(cat /tmp/pr-diff.txt 2>/dev/null | head -500 || echo "No diff available")
          PR_BODY=$(cat /tmp/pr-body.txt 2>/dev/null || echo "No description")
          CHANGED_FILES=$(cat /tmp/changed-files.txt 2>/dev/null || echo "Unknown")

          # Create prompt using heredoc with quoted delimiter to prevent variable expansion
          cat > /tmp/claude-prompt.txt << 'PROMPT_END'
          You are assisting with a Pull Request. A collaborator has asked you to help.

          INSTRUCTION FROM USER:
          INSTRUCTION_PLACEHOLDER

          IMPORTANT RULES:
          - Follow the user's instruction precisely
          - Only modify files relevant to the request
          - NEVER modify .github/workflows/*.yml files (no permission)
          - Do not skip tests or add test.skip()
          - Make minimal, focused changes
          - If asked to review, provide constructive feedback
          - If asked to fix something, make the fix and explain what you changed

          PR DETAILS:
          - PR Number: #PR_NUMBER_PLACEHOLDER
          - Branch: HEAD_BRANCH_PLACEHOLDER -> BASE_BRANCH_PLACEHOLDER

          CHANGED FILES:
          CHANGED_FILES_PLACEHOLDER

          PR DESCRIPTION:
          PR_BODY_PLACEHOLDER

          PR DIFF (truncated):
          PR_DIFF_PLACEHOLDER
          PROMPT_END

          # Replace placeholders safely using sed
          sed -i "s|INSTRUCTION_PLACEHOLDER|$INSTRUCTION|g" /tmp/claude-prompt.txt
          sed -i "s|PR_NUMBER_PLACEHOLDER|$PR_NUMBER|g" /tmp/claude-prompt.txt
          sed -i "s|HEAD_BRANCH_PLACEHOLDER|$HEAD_BRANCH|g" /tmp/claude-prompt.txt
          sed -i "s|BASE_BRANCH_PLACEHOLDER|$BASE_BRANCH|g" /tmp/claude-prompt.txt

          # Append data to file to avoid sed issues with special characters
          echo "" >> /tmp/claude-prompt.txt
          echo "CHANGED FILES:" >> /tmp/claude-prompt.txt
          echo "$CHANGED_FILES" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "PR DESCRIPTION:" >> /tmp/claude-prompt.txt
          echo "$PR_BODY" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "PR DIFF:" >> /tmp/claude-prompt.txt
          echo "$PR_DIFF" >> /tmp/claude-prompt.txt

          # Determine if this is a review request or code change request
          if echo "$INSTRUCTION" | grep -qi "review\|explain\|describe\|what\|why\|how"; then
            # Review mode - don't allow edits
            echo "Mode: Review/Explain (read-only)"
            CLAUDE_OUTPUT=$(claude -p "$(cat /tmp/claude-prompt.txt)" \
              --allowedTools "Read,Glob,Grep" \
              --output-format text 2>&1) || true
            echo "changes-made=false" >> $GITHUB_OUTPUT
          else
            # Edit mode - allow changes
            echo "Mode: Edit (can modify files)"
            CLAUDE_OUTPUT=$(claude -p "$(cat /tmp/claude-prompt.txt)" \
              --allowedTools "Read,Edit,Write,Glob,Grep,Bash(npm run lint:*),Bash(npm run typecheck:*)" \
              2>&1) || true

            # Check if files were modified
            if git diff --quiet && git diff --cached --quiet; then
              echo "changes-made=false" >> $GITHUB_OUTPUT
            else
              echo "changes-made=true" >> $GITHUB_OUTPUT
            fi
          fi

          # Save output for comment (truncate if too long)
          echo "$CLAUDE_OUTPUT" | tail -200 > /tmp/claude-output.txt

          echo "Claude completed"

      - name: "üìù Commit changes"
        if: steps.check-permission.outputs.allowed == 'true' && steps.claude.outputs.changes-made == 'true'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          HEAD_BRANCH: ${{ steps.pr-details.outputs.head-branch }}
        run: |
          git config user.name "Claude PR Assistant"
          git config user.email "claude-pr@github-actions"

          # Safely truncate comment body for commit message
          COMMIT_SUMMARY=$(echo "$COMMENT_BODY" | sed 's/@claude//' | head -c 50)

          git add -A
          git commit -m "[claude-pr] $COMMENT_USER: ${COMMIT_SUMMARY}...

          Requested by: @$COMMENT_USER
          Comment: $COMMENT_URL

          ü§ñ Generated with Claude Code" || echo "Nothing to commit"

          git push origin "$HEAD_BRANCH"

          echo "‚úÖ Changes pushed to $HEAD_BRANCH"

      - name: "üí¨ Post response comment"
        if: steps.check-permission.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-details.outputs.pr-number }}
          CHANGES_MADE: ${{ steps.claude.outputs.changes-made }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          # Build response
          CLAUDE_RESPONSE=$(cat /tmp/claude-output.txt 2>/dev/null || echo "No output captured")

          if [ "$CHANGES_MADE" == "true" ]; then
            STATUS="‚úÖ **Changes committed and pushed**"
          else
            STATUS="‚ÑπÔ∏è **No code changes made**"
          fi

          # Create comment body using heredoc with quoted delimiter
          cat > /tmp/response.md << 'RESPONSE_EOF'
          ## ü§ñ Claude Response

          STATUS_PLACEHOLDER

          <details>
          <summary>Claude's output</summary>

          ```
          CLAUDE_RESPONSE_PLACEHOLDER
          ```

          </details>

          ---
          *Triggered by @COMMENT_USER_PLACEHOLDER*
          RESPONSE_EOF

          # Replace placeholders
          sed -i "s|STATUS_PLACEHOLDER|$STATUS|g" /tmp/response.md
          sed -i "s|COMMENT_USER_PLACEHOLDER|$COMMENT_USER|g" /tmp/response.md
          # Use perl for multiline replacement of Claude response
          perl -i -pe "s|CLAUDE_RESPONSE_PLACEHOLDER|$CLAUDE_RESPONSE|g" /tmp/response.md 2>/dev/null || \
            sed -i "s|CLAUDE_RESPONSE_PLACEHOLDER|See workflow logs for full output|g" /tmp/response.md

          # Post comment
          gh pr comment "$PR_NUMBER" --body-file /tmp/response.md

      - name: "‚úÖ Add reaction"
        if: steps.check-permission.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          # Add rocket reaction to show completion
          gh api "repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions" \
            -f content='rocket' || true

      - name: "‚ùå Permission denied response"
        if: steps.check-permission.outputs.allowed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          gh pr comment "$ISSUE_NUMBER" \
            --body "‚ùå Sorry @$COMMENT_USER, you need write permission to use Claude on this repository."
