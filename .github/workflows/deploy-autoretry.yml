name: Deploy Workflow Auto-Retry

on:
  workflow_run:
    workflows: ["Optimized CI/CD Pipeline with Security & Testing"]
    types:
      - completed

permissions:
  actions: write
  contents: read

jobs:
  retry-once:
    name: "ðŸ” Retry deploy workflow (once)"
    runs-on: ubuntu-latest
    # Only retry on transient failures, NOT on:
    # - cancelled: User intentionally stopped the workflow
    # - action_required: Workflow waiting for approval/rejected
    # - skipped: Workflow conditions not met
    # - success: Already passed
    if: >
      github.event.workflow_run.run_attempt == 1 &&
      contains(fromJson('["failure","timed_out","startup_failure"]'), github.event.workflow_run.conclusion)

    steps:
      - name: "ðŸ” Request rerun"
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const attempt = context.payload.workflow_run.run_attempt;
            const conclusion = context.payload.workflow_run.conclusion;
            const createdAt = new Date(context.payload.workflow_run.created_at);
            const now = new Date();
            const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);

            core.info(`Workflow run ${runId}: attempt ${attempt}, conclusion ${conclusion}, age ${ageInDays.toFixed(1)} days`);

            // GitHub doesn't allow re-running workflows older than 30 days
            if (ageInDays >= 30) {
              core.warning(`Skipping rerun: workflow run ${runId} is ${ageInDays.toFixed(1)} days old (max 30 days)`);
              core.summary
                .addHeading('â­ï¸ Rerun skipped - workflow too old')
                .addRaw(`Run ID: ${runId} | Age: ${ageInDays.toFixed(1)} days | GitHub only allows reruns within 30 days`, true);
              await core.summary.write();
              return;
            }

            // Check if failure was due to rejected deployment approval
            // When deployment is rejected, the "Confirm" job fails but it's intentional
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRunAttempt({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
              attempt_number: attempt,
            });

            const rejectedDeployment = jobs.jobs.find(job =>
              job.name.toLowerCase().includes('confirm') &&
              job.conclusion === 'failure'
            );

            if (rejectedDeployment) {
              core.warning(`Skipping rerun: deployment was rejected (job: ${rejectedDeployment.name})`);
              core.summary
                .addHeading('â­ï¸ Rerun skipped - deployment rejected')
                .addRaw(`Run ID: ${runId} | Job "${rejectedDeployment.name}" was rejected - not a transient failure`, true);
              await core.summary.write();
              return;
            }

            await github.rest.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            core.summary
              .addHeading('Deploy workflow retry requested')
              .addRaw(`Run ID: ${runId} | Attempt: ${attempt} | Conclusion: ${conclusion} -> rerun requested`, true);
            await core.summary.write();
