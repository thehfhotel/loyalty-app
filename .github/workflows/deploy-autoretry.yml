name: Deploy Workflow Auto-Retry

on:
  workflow_run:
    workflows: ["Optimized CI/CD Pipeline with Security & Testing"]
    types:
      - completed

permissions:
  actions: write
  contents: read

jobs:
  retry-once:
    name: "ðŸ” Retry deploy workflow (once)"
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.run_attempt == 1 &&
      contains(fromJson('["failure","timed_out","startup_failure"]'), github.event.workflow_run.conclusion)

    steps:
      - name: "ðŸ” Request rerun"
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const attempt = context.payload.workflow_run.run_attempt;
            const conclusion = context.payload.workflow_run.conclusion;

            core.info(`Requesting rerun for workflow_run ${runId} (attempt ${attempt}, conclusion ${conclusion})`);

            await github.rest.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            core.summary
              .addHeading('Deploy workflow retry requested')
              .addRaw(`Run ID: ${runId} | Attempt: ${attempt} | Conclusion: ${conclusion} -> rerun requested`, true);
            await core.summary.write();
