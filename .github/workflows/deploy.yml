name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: ~/loyalty-app  # Path on your server

jobs:
  deploy:
    runs-on: self-hosted  # Will run on your server
    environment: production  # Use production environment for secrets
    
    steps:
      - name: Clean workspace
        run: |
          # Clean any leftover files with permission issues
          find . -name "logs" -type d -exec chmod -R 755 {} + 2>/dev/null || true
          rm -rf logs/ 2>/dev/null || true
          
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0

      - name: Set production environment variables
        run: |
          # Export all secrets as environment variables for Docker Compose
          # This eliminates the need for .env files in production
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
          echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> $GITHUB_ENV
          echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> $GITHUB_ENV
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}" >> $GITHUB_ENV
          echo "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" >> $GITHUB_ENV
          echo "FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}" >> $GITHUB_ENV
          echo "FACEBOOK_CALLBACK_URL=${{ secrets.FACEBOOK_CALLBACK_URL }}" >> $GITHUB_ENV
          echo "LINE_CHANNEL_ID=${{ secrets.LINE_CHANNEL_ID }}" >> $GITHUB_ENV
          echo "LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}" >> $GITHUB_ENV
          echo "LINE_CALLBACK_URL=${{ secrets.LINE_CALLBACK_URL }}" >> $GITHUB_ENV
          echo "AZURE_TRANSLATION_TEXT_URI=${{ secrets.AZURE_TRANSLATION_TEXT_URI }}" >> $GITHUB_ENV
          echo "AZURE_TRANSLATION_KEY_1=${{ secrets.AZURE_TRANSLATION_KEY_1 }}" >> $GITHUB_ENV
          echo "AZURE_TRANSLATION_KEY_2=${{ secrets.AZURE_TRANSLATION_KEY_2 }}" >> $GITHUB_ENV
          echo "AZURE_TRANSLATION_REGION=${{ secrets.AZURE_TRANSLATION_REGION }}" >> $GITHUB_ENV
          echo "LOYALTY_USERNAME=${{ secrets.LOYALTY_USERNAME }}" >> $GITHUB_ENV
          echo "LOYALTY_PASSWORD=${{ secrets.LOYALTY_PASSWORD }}" >> $GITHUB_ENV
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> $GITHUB_ENV
          echo "BACKEND_URL=${{ secrets.BACKEND_URL }}" >> $GITHUB_ENV
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> $GITHUB_ENV

      - name: Stop existing containers
        run: |
          echo "üõë Stopping existing containers..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true
          sleep 5

      - name: Backup database
        run: |
          echo "üíæ Backing up database..."
          timestamp=$(date +%Y%m%d_%H%M%S)
          docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T postgres pg_dump -U loyalty -d loyalty_db > backups/backup_${timestamp}.sql 2>/dev/null || true
          
          # Keep only last 5 backups
          ls -t backups/backup_*.sql 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true

      - name: Pull and build containers
        run: |
          echo "üî® Building containers..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml pull
          docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

      - name: Start new containers
        run: |
          echo "üöÄ Starting containers..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          
          # Wait for containers to be healthy
          sleep 15

      - name: Run database migrations
        run: |
          echo "üìä Running database migrations..."
          
          # Check if consolidated schema needs to be applied
          if ! docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T postgres psql -U loyalty -d loyalty_db -c "SELECT 1 FROM users LIMIT 1" &>/dev/null; then
            echo "Applying consolidated schema..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T postgres psql -U loyalty -d loyalty_db -f /docker-entrypoint-initdb.d/consolidated_schema.sql
          fi
          
          # Apply any new migrations
          for migration in database/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying migration: $(basename $migration)"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T postgres psql -U loyalty -d loyalty_db -f "/docker-entrypoint-initdb.d/migrations/$(basename $migration)" 2>/dev/null || true
            fi
          done

      - name: Health check
        run: |
          echo "üè• Running health checks..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:4001/health 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting for backend... (attempt $attempt/$max_attempts)"
            sleep 2
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Backend health check failed!"
            docker compose -f docker-compose.yml -f docker-compose.prod.yml logs backend
            exit 1
          fi

      - name: Cleanup
        run: |
          echo "üßπ Cleaning up..."
          docker image prune -f
          docker volume prune -f
          
      - name: Deployment summary
        if: always()
        run: |
          echo "=============================="
          echo "üìã Deployment Status"
          echo "=============================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
          echo "=============================="
          docker compose -f docker-compose.yml -f docker-compose.prod.yml ps