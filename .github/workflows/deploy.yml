name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: ~/loyalty-app  # Path on your server

jobs:
  deploy:
    runs-on: self-hosted  # Will run on your server
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0

      - name: Create environment file
        run: |
          # Copy production environment file
          if [ -f .env.production ]; then
            cp .env.production .env
          fi
          
          # Add secrets from GitHub (optional)
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env

      - name: Stop existing containers
        run: |
          echo "üõë Stopping existing containers..."
          docker compose down || true
          sleep 5

      - name: Backup database
        run: |
          echo "üíæ Backing up database..."
          timestamp=$(date +%Y%m%d_%H%M%S)
          docker compose exec -T postgres pg_dump -U loyalty -d loyalty_db > backups/backup_${timestamp}.sql 2>/dev/null || true
          
          # Keep only last 5 backups
          ls -t backups/backup_*.sql 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true

      - name: Pull and build containers
        run: |
          echo "üî® Building containers..."
          docker compose pull
          docker compose build --no-cache

      - name: Start new containers
        run: |
          echo "üöÄ Starting containers..."
          docker compose up -d
          
          # Wait for containers to be healthy
          sleep 15

      - name: Run database migrations
        run: |
          echo "üìä Running database migrations..."
          
          # Check if consolidated schema needs to be applied
          if ! docker compose exec -T postgres psql -U loyalty -d loyalty_db -c "SELECT 1 FROM users LIMIT 1" &>/dev/null; then
            echo "Applying consolidated schema..."
            docker compose exec -T postgres psql -U loyalty -d loyalty_db -f /docker-entrypoint-initdb.d/consolidated_schema.sql
          fi
          
          # Apply any new migrations
          for migration in database/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying migration: $(basename $migration)"
              docker compose exec -T postgres psql -U loyalty -d loyalty_db -f "/docker-entrypoint-initdb.d/migrations/$(basename $migration)" 2>/dev/null || true
            fi
          done

      - name: Health check
        run: |
          echo "üè• Running health checks..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:4001/health 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting for backend... (attempt $attempt/$max_attempts)"
            sleep 2
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Backend health check failed!"
            docker compose logs backend
            exit 1
          fi

      - name: Cleanup
        run: |
          echo "üßπ Cleaning up..."
          docker image prune -f
          docker volume prune -f
          
      - name: Deployment summary
        if: always()
        run: |
          echo "=============================="
          echo "üìã Deployment Status"
          echo "=============================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
          echo "=============================="
          docker compose ps