name: Actions Reliability Metrics

on:
  workflow_run:
    workflows: ["Optimized CI/CD Pipeline with Security & Testing"]
    types:
      - completed
  schedule:
    # Daily at 23:59 UTC
    - cron: "59 23 * * *"

permissions:
  actions: read
  contents: read

jobs:
  metrics:
    name: "ðŸ“ˆ Reliability Metrics"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'main')
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 1

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 20

      - name: "ðŸ“Š Compute reliability metrics (last 30 days, main)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/metrics/actions-metrics.js \
            --days 30 \
            --branch main \
            --event push \
            --repo "$GITHUB_REPOSITORY" \
            --workflow "Optimized CI/CD Pipeline with Security & Testing" | tee -a "$GITHUB_STEP_SUMMARY"
