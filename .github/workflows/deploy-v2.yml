name: CI/CD Pipeline v2 (GHCR + GitHub-hosted)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: 'false'
        type: boolean

# Workflow-level concurrency: cancel outdated runs, keep latest
concurrency:
  group: ${{ github.actor == 'dependabot[bot]' && 'dependabot-ci' || format('ci-v2-{0}', github.ref) }}
  cancel-in-progress: true

# Top-level permissions set to minimal read-only
# Write permissions are granted at job-level only where needed
permissions:
  contents: read
  actions: read
  pull-requests: read

env:
  NODE_VERSION: '24'
  RUST_VERSION: '1.93'
  REGISTRY: ghcr.io
  IMAGE_OWNER: thehfhotel
  IMAGE_REPO: loyalty-app
  # sccache configuration for distributed Rust compilation caching
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  # =============================================================================
  # PHASE 0: WORKSPACE PREPARATION (Node.js only)
  # =============================================================================

  prepare:
    name: "Prepare Workspace"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      frontend-cache-key: ${{ steps.cache-keys.outputs.frontend }}
      backend-node-cache-key: ${{ steps.cache-keys.outputs.backend-node }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate cache keys
        id: cache-keys
        run: |
          echo "frontend=frontend-deps-${{ hashFiles('frontend/package-lock.json') }}" >> $GITHUB_OUTPUT
          echo "backend-node=backend-node-deps-${{ hashFiles('backend/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ steps.cache-keys.outputs.frontend }}
          restore-keys: |
            frontend-deps-

      - name: Cache backend Node.js dependencies (for tRPC types)
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ steps.cache-keys.outputs.backend-node }}
          restore-keys: |
            backend-node-deps-

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install backend Node.js dependencies (for tRPC types)
        working-directory: ./backend
        run: npm ci

  # =============================================================================
  # PHASE 1: PARALLEL VALIDATION & TESTING
  # =============================================================================

  # ---------------------------------------------------------------------------
  # Rust Backend: Single job for lint + unit tests + integration tests
  # Compiles once (via sccache), runs all checks sequentially.
  # Starts immediately (no dependency on prepare).
  # ---------------------------------------------------------------------------
  validate-backend:
    name: "Validate Backend (Rust)"
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: loyalty_test
          POSTGRES_PASSWORD: loyalty_test_pass
          POSTGRES_DB: loyalty_test_db
        ports:
          - 5438:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6383:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-registry-${{ hashFiles('backend-rust/Cargo.lock') }}
          restore-keys: |
            cargo-registry-

      - name: Check formatting
        working-directory: ./backend-rust
        run: cargo fmt --all -- --check

      - name: Run clippy (lints)
        working-directory: ./backend-rust
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run unit tests
        working-directory: ./backend-rust
        run: cargo test --lib --bins
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

      - name: Run database migrations
        run: |
          PGPASSWORD=loyalty_test_pass psql -h localhost -p 5438 -U loyalty_test -d loyalty_test_db -f backend-rust/migrations/20240101000000_init.sql
        env:
          PGPASSWORD: loyalty_test_pass

      - name: Verify database schema
        run: |
          TABLE_COUNT=$(PGPASSWORD=loyalty_test_pass psql -h localhost -p 5438 -U loyalty_test -d loyalty_test_db -t -c \
            "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          TABLE_COUNT=$(echo "$TABLE_COUNT" | tr -d ' ')
          echo "Tables created: $TABLE_COUNT"
          if [ "$TABLE_COUNT" -lt 25 ]; then
            echo "::error::Expected 25+ tables, found $TABLE_COUNT. Migration may have failed."
            PGPASSWORD=loyalty_test_pass psql -h localhost -p 5438 -U loyalty_test -d loyalty_test_db -c \
              "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name;"
            exit 1
          fi

          # Verify stored procedures exist
          FUNC_COUNT=$(PGPASSWORD=loyalty_test_pass psql -h localhost -p 5438 -U loyalty_test -d loyalty_test_db -t -c \
            "SELECT count(*) FROM information_schema.routines WHERE routine_schema = 'public' AND routine_type = 'FUNCTION';")
          FUNC_COUNT=$(echo "$FUNC_COUNT" | tr -d ' ')
          echo "Stored procedures/functions: $FUNC_COUNT"
          if [ "$FUNC_COUNT" -lt 5 ]; then
            echo "::error::Expected 5+ stored procedures, found $FUNC_COUNT."
            exit 1
          fi

          echo "Database schema verification passed"
        env:
          PGPASSWORD: loyalty_test_pass

      - name: Seed test data
        run: |
          PGPASSWORD=loyalty_test_pass psql -h localhost -p 5438 -U loyalty_test -d loyalty_test_db -c "
            INSERT INTO tiers (name, min_points, min_nights, benefits, color, sort_order, is_active)
            VALUES
              ('Bronze', 0, 0, '{\"discount\": 0}', '#CD7F32', 1, true),
              ('Silver', 0, 1, '{\"discount\": 5}', '#C0C0C0', 2, true),
              ('Gold', 0, 10, '{\"discount\": 10}', '#FFD700', 3, true),
              ('Platinum', 0, 20, '{\"discount\": 15}', '#E5E4E2', 4, true)
            ON CONFLICT (name) DO NOTHING;

            INSERT INTO membership_id_sequence (id, current_user_count)
            VALUES (1, 0)
            ON CONFLICT (id) DO NOTHING;
          "
          echo "Test data seeded successfully"
        env:
          PGPASSWORD: loyalty_test_pass

      - name: Run integration tests
        working-directory: ./backend-rust
        run: cargo test --test '*' -- --test-threads=1
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug
          TEST_DATABASE_URL: postgresql://loyalty_test:loyalty_test_pass@localhost:5438/loyalty_test_db
          TEST_REDIS_URL: redis://localhost:6383
          JWT_SECRET: test-jwt-secret-for-ci-minimum-32-characters-long
          JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci-minimum-32-chars
          SESSION_SECRET: test-session-secret-for-ci-minimum-32-chars
          GOOGLE_CLIENT_ID: test-google-client-id
          GOOGLE_CLIENT_SECRET: test-google-client-secret
          GOOGLE_CALLBACK_URL: http://localhost:4001/api/oauth/google/callback
          LINE_CLIENT_ID: test-line-channel-id
          LINE_CLIENT_SECRET: test-line-channel-secret
          LINE_CALLBACK_URL: http://localhost:4001/api/oauth/line/callback
          FRONTEND_URL: http://localhost:3000

      - name: Check for security vulnerabilities
        working-directory: ./backend-rust
        run: |
          cargo install cargo-audit --locked || true
          cargo audit || echo "Some vulnerabilities found - review output"
        continue-on-error: true

      - name: Show sccache stats
        run: sccache --show-stats

  # ---------------------------------------------------------------------------
  # Rust Backend: Release binary build (runs in parallel with validate-backend)
  # Uses rust:1.93-bookworm container to ensure glibc compatibility with the
  # debian:bookworm-slim production runner image.
  # ---------------------------------------------------------------------------
  build-backend-binary:
    name: "Build Backend Binary"
    runs-on: ubuntu-latest
    container:
      image: rust:1.93-bookworm
    timeout-minutes: 25

    steps:
      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends pkg-config libssl-dev libpq-dev

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/cargo/registry/index/
            /usr/local/cargo/registry/cache/
            /usr/local/cargo/git/db/
          key: cargo-registry-container-${{ hashFiles('backend-rust/Cargo.lock') }}
          restore-keys: |
            cargo-registry-container-

      - name: Build release binary
        working-directory: ./backend-rust
        run: cargo build --release --bin loyalty-backend

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: loyalty-backend-binary
          path: backend-rust/target/release/loyalty-backend
          retention-days: 1

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  lint-frontend:
    name: "Lint Frontend"
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore frontend dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ needs.prepare.outputs.frontend-cache-key }}
          fail-on-cache-miss: true

      - name: Restore backend Node.js dependencies (for tRPC types)
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ needs.prepare.outputs.backend-node-cache-key }}
          fail-on-cache-miss: true

      - name: Generate Prisma client (for tRPC types)
        working-directory: ./backend
        run: npx prisma generate

      - name: TypeScript check
        working-directory: ./frontend
        run: npm run typecheck

      - name: ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: npm audit
        working-directory: ./frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

  test-frontend-unit:
    name: "Frontend Unit Tests"
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore frontend dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ needs.prepare.outputs.frontend-cache-key }}
          fail-on-cache-miss: true

      - name: Run unit tests
        working-directory: ./frontend
        run: npm run test
        env:
          NODE_ENV: test
          CI: true

  # =============================================================================
  # PHASE 2: BUILD AND PUSH TO GHCR
  # =============================================================================

  build-and-push:
    name: "Build & Push to GHCR"
    runs-on: ubuntu-latest
    needs: [validate-backend, build-backend-binary, lint-frontend, test-frontend-unit]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      image-tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------------------------------
      # Backend Image (Rust) - uses pre-built binary from build-backend-binary
      # -------------------------------------------------------------------------
      - name: Download backend binary
        uses: actions/download-artifact@v4
        with:
          name: loyalty-backend-binary
          path: ./backend-binary

      - name: Extract backend metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/backend
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend-binary
          file: ./backend-rust/Dockerfile.ci
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha,scope=backend-ci
          cache-to: type=gha,mode=max,scope=backend-ci
          platforms: linux/amd64

      # -------------------------------------------------------------------------
      # Frontend Image
      # -------------------------------------------------------------------------
      - name: Extract frontend metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/frontend
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          target: production
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            VITE_API_URL=${{ vars.VITE_API_URL || 'https://loyalty.saichon.com/api' }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          platforms: linux/amd64

      - name: Summary
        run: |
          echo "## Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend (Rust)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-backend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-frontend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PHASE 3: E2E TESTS (using GHCR images)
  # =============================================================================

  e2e-tests:
    name: "E2E Tests"
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      (github.ref == 'refs/heads/main' || github.base_ref == 'main') &&
      github.event.inputs.skip_e2e != 'true'
    timeout-minutes: 20
    # E2E tests run sequentially to prevent port conflicts
    concurrency:
      group: e2e-tests
      cancel-in-progress: false

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: loyalty_e2e
          POSTGRES_PASSWORD: loyalty_e2e_pass
          POSTGRES_DB: loyalty_e2e_db
        ports:
          - 5436:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6381:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies (Playwright)
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull backend image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/backend:${{ github.sha }}

      - name: Pull frontend image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/frontend:${{ github.sha }}

      # Note: Rust backend runs migrations automatically on startup
      # No separate migration step needed

      - name: Start backend container
        run: |
          docker run -d --name backend --network host \
            -e RUST_ENV=development \
            -e NODE_ENV=development \
            -e PORT=4202 \
            -e DATABASE_URL=postgresql://loyalty_e2e:loyalty_e2e_pass@localhost:5436/loyalty_e2e_db \
            -e REDIS_URL=redis://localhost:6381 \
            -e JWT_SECRET=e2e-jwt-secret-for-testing-minimum-64-characters-long-secure-token-string \
            -e JWT_REFRESH_SECRET=e2e-jwt-refresh-secret-for-testing-minimum-64-characters-long-string \
            -e SESSION_SECRET=e2e-session-secret-for-testing-minimum-64-characters-long-secure-string \
            -e GOOGLE_CLIENT_ID=e2e-google-client-id \
            -e GOOGLE_CLIENT_SECRET=e2e-google-client-secret \
            -e GOOGLE_CALLBACK_URL=http://localhost:4202/api/oauth/google/callback \
            -e LINE_CLIENT_ID=e2e-line-channel-id \
            -e LINE_CLIENT_SECRET=e2e-line-channel-secret \
            -e LINE_CALLBACK_URL=http://localhost:4202/api/oauth/line/callback \
            -e FRONTEND_URL=http://localhost:3201 \
            -e RUST_LOG=info \
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/backend:${{ github.sha }}

      - name: Start frontend container
        run: |
          docker run -d --name frontend \
            --add-host=host.docker.internal:host-gateway \
            -v ${{ github.workspace }}/frontend/nginx.e2e.conf:/etc/nginx/nginx.conf:ro \
            -p 3201:80 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/frontend:${{ github.sha }}

      - name: Wait for services
        run: |
          echo "Waiting for backend..."
          for i in {1..30}; do
            if curl -sf http://localhost:4202/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Backend failed to start"
              docker logs backend
              exit 1
            fi
            sleep 2
          done

          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -sf http://localhost:3201 > /dev/null 2>&1; then
              echo "Frontend is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Frontend failed to start"
              docker logs frontend
              exit 1
            fi
            sleep 2
          done

      - name: Seed E2E test users
        run: |
          echo "Creating E2E test users..."
          # Create test user 1
          curl -sf -X POST http://localhost:4202/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"e2e-browser@test.com","password":"E2ETestPassword123!","firstName":"E2E","lastName":"Browser"}' \
            && echo "Created e2e-browser@test.com" \
            || echo "User may already exist"

          # Create test user 2
          curl -sf -X POST http://localhost:4202/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"e2e-browser-2@test.com","password":"E2ETestPassword123!","firstName":"E2E","lastName":"Browser2"}' \
            && echo "Created e2e-browser-2@test.com" \
            || echo "User may already exist"

          # Create admin test user (email is in admins.e2e.json)
          curl -sf -X POST http://localhost:4202/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"e2e-admin@test.local","password":"AdminPassword123!","firstName":"E2E","lastName":"Admin"}' \
            && echo "Created e2e-admin@test.local" \
            || echo "User may already exist"

          echo "E2E test users seeded"

      - name: Run Playwright E2E tests
        run: npx playwright test
        env:
          E2E_BASE_URL: http://localhost:3201
          E2E_API_URL: http://localhost:4202/api

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Cleanup containers
        if: always()
        run: |
          docker stop backend frontend 2>/dev/null || true
          docker rm backend frontend 2>/dev/null || true

  # =============================================================================
  # PHASE 4: DEPLOY TO STAGING (main branch, no approval needed)
  # =============================================================================

  deploy-staging:
    name: "Deploy to Staging"
    runs-on: [self-hosted, deploy]
    needs: [build-and-push, e2e-tests]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10
    environment:
      name: development
      url: http://loyalty-dev.saichon.com

    steps:
      - name: Checkout config files
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.yml
            docker-compose.ghcr.yml
            docker-compose.staging.yml
            nginx/nginx.conf
          sparse-checkout-cone-mode: false

      - name: Create .env file
        working-directory: /home/nut/loyalty-app-develop
        run: |
          cat > .env << 'ENVEOF'
          RUST_ENV=staging
          NODE_ENV=staging
          JWT_SECRET=${{ secrets.DEV_JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.DEV_JWT_REFRESH_SECRET }}
          SESSION_SECRET=${{ secrets.DEV_SESSION_SECRET }}
          DATABASE_URL=postgresql://loyalty_dev:loyalty_dev_pass@postgres:5432/loyalty_dev_db
          REDIS_URL=redis://redis:6379
          FRONTEND_URL=${{ vars.FRONTEND_URL }}
          BACKEND_URL=${{ vars.BACKEND_URL }}
          VITE_API_URL=${{ vars.VITE_API_URL }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_CALLBACK_URL=${{ vars.GOOGLE_CALLBACK_URL }}
          LINE_CHANNEL_ID=${{ secrets.LINE_CHANNEL_ID }}
          LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}
          LINE_CALLBACK_URL=${{ vars.LINE_CALLBACK_URL }}
          RUST_LOG=info
          ENVEOF
          chmod 600 .env

      - name: Copy config files
        run: |
          DEPLOY_PATH="/home/nut/loyalty-app-develop"
          cp docker-compose.yml "$DEPLOY_PATH/"
          cp docker-compose.ghcr.yml "$DEPLOY_PATH/"
          cp docker-compose.staging.yml "$DEPLOY_PATH/"
          mkdir -p "$DEPLOY_PATH/nginx"
          cp nginx/nginx.conf "$DEPLOY_PATH/nginx/"

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u thehfhotel --password-stdin

      - name: Deploy services
        working-directory: /home/nut/loyalty-app-develop
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          COMPOSE_OVERRIDE="docker-compose.staging.yml"

          # Export environment variables from .env file
          set -a && source .env && set +a
          export IMAGE_TAG

          # Pull images
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" pull backend frontend

          # Start database services
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" up -d postgres redis

          # Wait for postgres
          sleep 10

          # Note: Rust backend runs migrations automatically on startup
          # No separate migration step needed

          # Deploy all services
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" up -d --remove-orphans

          # Restart nginx to refresh DNS cache for new backend container IP
          docker restart loyalty_nginx_dev || true

      - name: Health check
        run: |
          sleep 15
          for i in {1..30}; do
            if curl -sf http://localhost:5001/api/health > /dev/null 2>&1; then
              echo "Deployment successful!"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed"
          cd /home/nut/loyalty-app-develop
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f docker-compose.staging.yml logs --tail=50 backend
          exit 1

  # =============================================================================
  # PHASE 5: DEPLOY TO PRODUCTION (main branch, requires approval)
  # =============================================================================

  deploy-production:
    name: "Deploy to Production"
    runs-on: [self-hosted, deploy]
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10
    environment:
      name: production
      url: https://loyalty.saichon.com

    steps:
      - name: Checkout config files
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.yml
            docker-compose.ghcr.yml
            docker-compose.prod.yml
            nginx/nginx.conf
          sparse-checkout-cone-mode: false

      - name: Create .env file
        working-directory: /home/nut/loyalty-app-production
        run: |
          cat > .env << 'ENVEOF'
          RUST_ENV=production
          NODE_ENV=production
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          REDIS_URL=redis://redis:6379
          FRONTEND_URL=${{ vars.FRONTEND_URL }}
          BACKEND_URL=${{ vars.BACKEND_URL }}
          VITE_API_URL=${{ vars.VITE_API_URL }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_CALLBACK_URL=${{ vars.GOOGLE_CALLBACK_URL }}
          LINE_CHANNEL_ID=${{ secrets.LINE_CHANNEL_ID }}
          LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}
          LINE_CALLBACK_URL=${{ vars.LINE_CALLBACK_URL }}
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          IMAP_HOST=${{ secrets.IMAP_HOST }}
          IMAP_PORT=${{ secrets.IMAP_PORT }}
          IMAP_USER=${{ secrets.IMAP_USER }}
          IMAP_PASS=${{ secrets.IMAP_PASS }}
          RUST_LOG=info
          ENVEOF
          chmod 600 .env

      - name: Copy config files
        run: |
          DEPLOY_PATH="/home/nut/loyalty-app-production"
          cp docker-compose.yml "$DEPLOY_PATH/"
          cp docker-compose.ghcr.yml "$DEPLOY_PATH/"
          cp docker-compose.prod.yml "$DEPLOY_PATH/"
          mkdir -p "$DEPLOY_PATH/nginx"
          cp nginx/nginx.conf "$DEPLOY_PATH/nginx/"

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u thehfhotel --password-stdin

      - name: Deploy services
        working-directory: /home/nut/loyalty-app-production
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          COMPOSE_OVERRIDE="docker-compose.prod.yml"

          # Export environment variables from .env file
          set -a && source .env && set +a
          export IMAGE_TAG

          # Pull images
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" pull backend frontend

          # Start database services
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" up -d postgres redis

          # Wait for postgres
          sleep 10

          # Note: Rust backend runs migrations automatically on startup
          # No separate migration step needed

          # Deploy all services
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f "$COMPOSE_OVERRIDE" up -d --remove-orphans

          # Restart nginx to refresh DNS cache for new backend container IP
          docker restart loyalty_nginx_production || true

      - name: Health check
        run: |
          sleep 15
          for i in {1..30}; do
            if curl -sf http://localhost:4001/api/health > /dev/null 2>&1; then
              echo "Deployment successful!"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed"
          cd /home/nut/loyalty-app-production
          docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f docker-compose.prod.yml logs --tail=50 backend
          exit 1

      - name: Deployment Summary
        run: |
          echo "## Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://loyalty.saichon.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: Rust (loyalty-backend)" >> $GITHUB_STEP_SUMMARY
