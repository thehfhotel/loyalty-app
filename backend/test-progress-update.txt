
> loyalty-backend@4.0.1 test
> jest

PASS src/__tests__/unit/services/authService.test.ts (5.242 s)
  AuthService
    Password Security
      ‚úì should hash passwords securely (89 ms)
      ‚úì should verify passwords correctly (201 ms)
      ‚úì should not store plain text passwords
    JWT Token Management
      ‚úì should generate valid JWT tokens (4 ms)
      ‚úì should verify JWT tokens correctly (2 ms)
      ‚úì should reject invalid JWT tokens (20 ms)
      ‚úì should reject expired JWT tokens (2 ms)
      ‚úì should handle different JWT secrets (1 ms)
    User Role Management
      ‚úì should handle customer role
      ‚úì should support different user roles
    User Data Validation
      ‚úì should require valid email format (2 ms)
      ‚úì should enforce email uniqueness
      ‚úì should validate required user fields (1 ms)
    Security Features
      ‚úì should handle password reset token generation
      ‚úì should generate secure membership IDs (2 ms)
      ‚úì should handle session management data
    User Profile Management
      ‚úì should maintain complete user profile data
      ‚úì should handle optional profile fields (1 ms)
      ‚úì should support user metadata (1 ms)
    Error Handling
      ‚úì should handle database constraint violations gracefully (1 ms)
      ‚úì should validate data types (1 ms)
      ‚úì should handle missing required relationships
    Performance and Scalability
      ‚úì should efficiently query user data (1 ms)
      ‚úì should handle batch user operations

PASS src/__tests__/unit/services/storageService.test.ts (5.382 s)
  StorageService
    Storage Initialization
      ‚úì should initialize storage service with backup scheduling (8 ms)
      ‚úì should schedule backup for 2 AM next day (6 ms)
    Backup Operations
      ‚úì should perform backup successfully (1 ms)
      ‚úì should log backup duration (1 ms)
      ‚úì should handle backup errors gracefully (33 ms)
      ‚úì should continue operations after backup failure (3 ms)
    Storage Reports
      ‚úì should generate storage report with all metrics (2 ms)
      ‚úì should calculate usage percentage correctly (1 ms)
      ‚úì should handle zero files scenario (2 ms)
      ‚úì should handle maximum storage usage (1 ms)
      ‚úì should return consistent data structure (1 ms)
      ‚úì should handle getStorageStats errors (1 ms)
    Storage Metrics Validation
      ‚úì should calculate average size correctly (1 ms)
      ‚úì should handle large file counts
      ‚úì should handle very small files (1 ms)
    Storage Limits
      ‚úì should warn when approaching storage limit (1 ms)
      ‚úì should detect storage overflow
    Backup Scheduling
      ‚úì should schedule daily backups (2 ms)
      ‚úì should calculate correct time until next backup (1 ms)
    Error Recovery
      ‚úì should recover from temporary storage errors (2 ms)
      ‚úì should handle concurrent report requests (1 ms)
    Performance
      ‚úì should generate report quickly (1 ms)
      ‚úì should handle rapid successive calls (1 ms)

PASS src/__tests__/unit/middleware/auth.test.ts (5.391 s)
  Auth Middleware
    authenticate
      ‚úì should authenticate valid Bearer token (13 ms)
      ‚úì should reject request without authorization header (4 ms)
      ‚úì should reject request with malformed authorization header (1 ms)
      ‚úì should handle invalid token (3 ms)
      ‚úì should handle expired token (2 ms)
      ‚úì should handle token verification service errors (1 ms)
      ‚úì should trim Bearer prefix correctly (2 ms)
    authorize
      ‚úì should allow access for user with correct role (2 ms)
      ‚úì should deny access for user with insufficient role (1 ms)
      ‚úì should deny access for unauthenticated user
      ‚úì should allow super_admin access to admin routes
      ‚úì should handle single role authorization (3 ms)
      ‚úì should handle multiple allowed roles (1 ms)
    requireRole
      ‚úì should allow access for user with required role (1 ms)
      ‚úì should deny access for user without required role
      ‚úì should deny access for unauthenticated user (1 ms)
      ‚úì should work with single role in array
      ‚úì should handle role hierarchy correctly (1 ms)
    middleware integration
      ‚úì should chain authenticate and authorize correctly (1 ms)
      ‚úì should prevent unauthorized access after failed authentication (1 ms)
    error handling
      ‚úì should pass errors to next middleware (2 ms)
      ‚úì should handle undefined user gracefully in authorize (1 ms)
      ‚úì should handle undefined user gracefully in requireRole

PASS src/__tests__/unit/services/notificationService.test.ts (5.536 s)
  NotificationService
    createNotification
      ‚úì should create a new notification successfully (8 ms)
      ‚úì should create notification with data and expiry (3 ms)
      ‚úì should throw error if notification creation fails (26 ms)
    getUserNotifications
      ‚úì should get user notifications with pagination (1 ms)
      ‚úì should filter unread notifications only (1 ms)
      ‚úì should return empty result if no notifications (1 ms)
      ‚úì should handle pagination correctly
    getUnreadCount
      ‚úì should get unread notification count
      ‚úì should return 0 if no result (1 ms)
    markNotificationsRead
      ‚úì should mark specific notifications as read (1 ms)
      ‚úì should return 0 if no notifications provided (1 ms)
      ‚úì should handle empty update result (1 ms)
    markAllNotificationsRead
      ‚úì should mark all notifications as read (1 ms)
      ‚úì should return 0 if no notifications marked
    deleteNotification
      ‚úì should delete notification successfully (1 ms)
      ‚úì should return false if notification not found
    cleanupExpiredNotifications
      ‚úì should cleanup expired notifications
      ‚úì should return 0 if no expired notifications (1 ms)
    getUserPreferences
      ‚úì should get user notification preferences (1 ms)
      ‚úì should return empty array if no preferences
    updateUserPreferences
      ‚úì should update user preferences successfully (1 ms)
      ‚úì should handle empty preferences array (1 ms)
    createProfileCompletionNotification
      ‚úì should create profile completion notification with points (1 ms)
    createCouponNotification
      ‚úì should create coupon notification
    createPointsNotification
      ‚úì should create points notification (1 ms)
    createBulkNotifications
      ‚úì should create multiple notifications at once (1 ms)
      ‚úì should return 0 if no notifications provided
    error handling
      ‚úì should handle database connection errors (1 ms)
      ‚úì should handle invalid user ID gracefully
    notification types
      ‚úì should support different notification types (1 ms)

PASS src/__tests__/unit/middleware/requestLogger.test.ts
  RequestLogger Middleware
    Basic Logging
      ‚úì should call next middleware (2 ms)
      ‚úì should register finish event listener (1 ms)
      ‚úì should log successful request (1 ms)
      ‚úì should include request method in log (1 ms)
      ‚úì should include request URL in log
    Status Code Handling
      ‚úì should log info for 2xx status codes
      ‚úì should log info for 3xx status codes
      ‚úì should log warn for 4xx status codes (1 ms)
      ‚úì should log warn for 5xx status codes (1 ms)
    Performance Tracking
      ‚úì should track request duration
      ‚úì should include duration in log data
      ‚úì should handle very fast requests (1 ms)
      ‚úì should handle slow requests
    Request Metadata
      ‚úì should log IP address (1 ms)
      ‚úì should log user agent (1 ms)
      ‚úì should handle missing user agent (1 ms)
      ‚úì should handle missing IP address
    Different HTTP Methods
      ‚úì should log GET requests (1 ms)
      ‚úì should log POST requests (1 ms)
      ‚úì should log PUT requests
      ‚úì should log DELETE requests
      ‚úì should log PATCH requests (1 ms)
    Different Routes
      ‚úì should log API routes
      ‚úì should log health check routes (1 ms)
      ‚úì should log routes with query parameters (1 ms)
      ‚úì should log routes with URL parameters
    Error Scenarios
      ‚úì should continue logging even if finish event fails
      ‚úì should handle malformed requests

2025-11-12 09:21:44 [[32minfo[39m]: Prisma client initialized
FAIL src/__tests__/unit/middleware/security.test.ts (5.526 s)
  Security Middleware
    Rate Limiter Creation
      ‚úï should create basic rate limiter (6 ms)
      ‚úï should create API rate limiter (1 ms)
      ‚úï should create user-specific rate limiter (1 ms)
      ‚úì should create authentication rate limiter (4 ms)
    Security Headers
      ‚úì should apply security headers middleware (1 ms)
      ‚úï should set custom security headers
      ‚úï should set HSTS header with correct max-age (1 ms)
    Input Sanitization
      ‚úì should sanitize request body (2 ms)
      ‚úì should sanitize query parameters (1 ms)
      ‚úì should sanitize URL parameters (1 ms)
      ‚úì should handle empty request objects
      ‚úì should handle nested objects in body (1 ms)
    File Upload Security
      ‚úï should validate file upload requests (4 ms)
      ‚úï should handle requests without files (1 ms)
      ‚úï should validate file types (1 ms)
      ‚úï should handle multiple file uploads (1 ms)
    Security Monitoring
      ‚úì should monitor requests (2 ms)
      ‚úì should track request metadata (1 ms)
      ‚úì should handle requests without IP (1 ms)
      ‚úì should monitor different HTTP methods (2 ms)
    Production Security
      ‚úï should apply production security (2 ms)
      ‚úï should work in development mode (2 ms)
      ‚úï should handle missing NODE_ENV (1 ms)
    XSS Protection
      ‚úì should sanitize script tags (1 ms)
      ‚úì should sanitize event handlers (1 ms)
      ‚úì should sanitize javascript: URLs (1 ms)
      ‚úì should preserve safe HTML (1 ms)
    SQL Injection Protection
      ‚úì should handle SQL-like inputs in query (1 ms)
      ‚úì should handle SQL-like inputs in body (2 ms)
      ‚úì should handle UNION attacks (1 ms)
    CSRF Protection Headers
      ‚úï should set CSRF protection headers
      ‚úï should prevent clickjacking (3 ms)
      ‚úï should prevent MIME sniffing
    Error Scenarios
      ‚úï should handle sanitization errors gracefully (17 ms)
      ‚úì should handle malformed headers (1 ms)
      ‚úï should continue on setHeader errors (1 ms)

  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create basic rate limiter

    TypeError: Cannot read properties of undefined (reading 'rateLimitWindowMs')

      13 | export const createRateLimiter = () => {
      14 |   return rateLimit({
    > 15 |     windowMs: securityConfig.rateLimitWindowMs, // 15 minutes
         |                              ^
      16 |     max: securityConfig.rateLimitMaxRequests, // limit each IP to 100 requests per windowMs
      17 |     message: {
      18 |       error: 'Too many requests',

      at createRateLimiter (src/middleware/security.ts:15:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:83:44)

  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create API rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      54 |   };
      55 |   
    > 56 |   const limits = isProduction() ? productionLimits : developmentLimits;
         |                              ^
      57 |   
      58 |   return rateLimit({
      59 |     windowMs: limits.windowMs,

      at createApiRateLimiter (src/middleware/security.ts:56:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:89:46)

  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create user-specific rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      111 |   };
      112 |   
    > 113 |   const limits = isProduction() ? productionLimits : developmentLimits;
          |                              ^
      114 |   
      115 |   return rateLimit({
      116 |     windowMs: limits.windowMs,

      at createUserRateLimiter (src/middleware/security.ts:113:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:95:48)

  ‚óè Security Middleware ‚Ä∫ Security Headers ‚Ä∫ should set custom security headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:114:28)

  ‚óè Security Middleware ‚Ä∫ Security Headers ‚Ä∫ should set HSTS header with correct max-age

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:124:28)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should validate file upload requests

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:199:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should handle requests without files

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:206:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should validate file types

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:220:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should handle multiple file uploads

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:243:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should apply production security

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:290:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should work in development mode

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:296:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should handle missing NODE_ENV

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:302:25)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should set CSRF protection headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:357:28)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should prevent clickjacking

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:362:28)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should prevent MIME sniffing

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:367:28)

  ‚óè Security Middleware ‚Ä∫ Error Scenarios ‚Ä∫ should handle sanitization errors gracefully

    RangeError: Maximum call stack size exceeded

      258 |         .trim();
      259 |     }
    > 260 |     if (Array.isArray(value)) {
          |     ^
      261 |       return value.map(sanitizeValue);
      262 |     }
      263 |     if (value && typeof value === 'object' && value !== null) {

      at sanitizeValue (src/middleware/security.ts:260:5)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)

  ‚óè Security Middleware ‚Ä∫ Error Scenarios ‚Ä∫ should continue on setHeader errors

    Header error

      394 |     test('should continue on setHeader errors', () => {
      395 |       (mockRes.setHeader as jest.Mock).mockImplementation(() => {
    > 396 |         throw new Error('Header error');
          |               ^
      397 |       });
      398 |
      399 |       // The middleware should continue even if setHeader throws

      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:396:15)
      at customSecurityHeaders (src/middleware/security.ts:227:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:400:28)

PASS src/__tests__/unit/services/userService.test.ts
  UserService
    getProfile
      ‚úì should return user profile successfully (3 ms)
      ‚úì should throw error if profile not found (15 ms)
    updateProfile
      ‚úì should update profile fields successfully (2 ms)
      ‚úì should handle partial profile updates (1 ms)
      ‚úì should handle emoji avatar updates (1 ms)
    getAllUsers
      ‚úì should return paginated users list (1 ms)
      ‚úì should apply search filter (1 ms)
    deleteUser
      ‚úì should delete user successfully (1 ms)
      ‚úì should not throw error if user not found (idempotent delete) (1 ms)
      ‚úì should handle cascade deletion (1 ms)
    updateUserRole
      ‚úì should update user role successfully (1 ms)
      ‚úì should validate role enum (2 ms)
    updateUserStatus
      ‚úì should activate inactive user (1 ms)
      ‚úì should deactivate active user (1 ms)
    getUserStats
      ‚úì should return user statistics (1 ms)
    completeProfile
      ‚úì should mark profile as completed (1 ms)
      ‚úì should handle profile updates with rewards
    error handling
      ‚úì should handle database connection errors (1 ms)
      ‚úì should handle invalid data format (2 ms)

PASS src/__tests__/unit/services/surveyService.test.ts
  SurveyService
    Survey Basic Operations
      ‚úì should be properly instantiated (2 ms)
      ‚úì should have required methods (1 ms)
    getSurveyById
      ‚úì should return survey data for valid ID (5 ms)
      ‚úì should return null for non-existent survey
    getSurveyAnalytics
      ‚úì should return analytics for valid survey (38 ms)
      ‚úì should return null for non-existent survey analytics (1 ms)
    Error Handling
      ‚úì should handle database connection errors (8 ms)
      ‚úì should handle SQL errors (1 ms)
    Survey Response Handling
      ‚úì should handle survey submission responses (1 ms)
    Survey Coupon Assignment
      ‚úì should handle coupon assignment structure (1 ms)
    Survey Question Types
      ‚úì should support all question types (2 ms)

FAIL src/__tests__/unit/services/membershipIdService.test.ts
  MembershipIdService
    generateUniqueMembershipId
      ‚úì should generate an 8-digit membership ID starting with 269 (2 ms)
      ‚úï should generate sequential IDs within block boundaries (3 ms)
      ‚úì should handle block boundaries correctly (5 ms)
      ‚úì should retry with fallback block if primary block is full (1 ms)
      ‚úì should throw error when all fallback blocks are exhausted (8 ms)
      ‚úì should handle database errors gracefully (1 ms)
    getUserByMembershipId
      ‚úì should return user data for valid membership ID (2 ms)
      ‚úì should throw error for non-existent membership ID (1 ms)
      ‚úì should validate membership ID format (7 ms)
    getMembershipIdByUserId
      ‚úì should return membership ID for valid user ID (1 ms)
      ‚úì should return null for user with null membership ID (1 ms)
      ‚úì should handle empty result for non-existent user (1 ms)
    regenerateMembershipId
      ‚úì should generate new membership ID for existing user (1 ms)
      ‚úì should throw error for non-existent user (1 ms)
      ‚úì should handle database errors during regeneration (3 ms)
    getMembershipIdStats
      ‚úì should return comprehensive membership ID statistics (1 ms)
      ‚úì should handle zero users correctly (1 ms)
      ‚úì should handle missing sequence information (1 ms)
      ‚úì should calculate block boundaries correctly for different user counts (2 ms)
    Error Handling
      ‚úì should handle malformed database responses (1 ms)
      ‚úì should handle database connection errors (2 ms)
      ‚úì should handle SQL syntax errors (1 ms)

  ‚óè MembershipIdService ‚Ä∫ generateUniqueMembershipId ‚Ä∫ should generate sequential IDs within block boundaries

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not "26900067"

      65 |       expect(firstId).toMatch(/^269\d{5}$/);
      66 |       expect(secondId).toMatch(/^269\d{5}$/);
    > 67 |       expect(firstId).not.toBe(secondId);  // Should be different
         |                           ^
      68 |     });
      69 |
      70 |     test('should handle block boundaries correctly', async () => {

      at Object.<anonymous> (src/__tests__/unit/services/membershipIdService.test.ts:67:27)

PASS src/__tests__/unit/services/couponService.test.ts
  CouponService
    createCoupon
      ‚úì should create a new coupon successfully (2 ms)
      ‚úì should throw error if coupon code already exists (12 ms)
      ‚úì should rollback transaction on error (46 ms)
      ‚úì should handle different coupon types (1 ms)
    getCouponById
      ‚úì should retrieve coupon by ID (1 ms)
      ‚úì should return null if coupon not found
    getCouponByCode
      ‚úì should retrieve coupon by code (1 ms)
      ‚úì should return null if code not found (1 ms)
      ‚úì should be case-sensitive for coupon codes
    listCoupons
      ‚úì should list coupons with pagination
      ‚úì should filter by status (1 ms)
      ‚úì should filter by type (1 ms)
      ‚úì should search by code or name
    assignCouponToUsers
      ‚úì should assign coupon to multiple users (1 ms)
      ‚úì should handle error if coupon not found
      ‚úì should handle error if coupon not active (1 ms)
    redeemCoupon
      ‚úì should redeem coupon successfully (1 ms)
      ‚úì should throw error if user coupon not found (1 ms)
      ‚úì should throw error if coupon already used
      ‚úì should handle fixed amount discount
    getUserActiveCoupons
      ‚úì should get user active coupons (2 ms)
      ‚úì should return empty array if no active coupons
    getCouponStats
      ‚úì should return coupon statistics (2 ms)
    deleteCoupon
      ‚úì should soft delete a coupon
      ‚úì should return false if coupon not found (1 ms)
    revokeUserCoupon
      ‚úì should revoke user coupon successfully (2 ms)
      ‚úì should return false if user coupon not found
      ‚úì should return false if coupon already used
    error handling
      ‚úì should handle database connection errors (3 ms)
      ‚úì should handle transaction errors with rollback (1 ms)
    business logic validation
      ‚úì should validate coupon expiry dates (1 ms)
      ‚úì should validate usage limits

PASS src/__tests__/unit/services/analyticsService.test.ts
  AnalyticsService
    Coupon Usage Tracking
      ‚úì should track coupon view event (2 ms)
      ‚úì should track coupon assignment event (1 ms)
      ‚úì should track coupon redemption attempt
      ‚úì should track successful redemption
      ‚úì should track failed redemption (1 ms)
      ‚úì should track coupon expiration
      ‚úì should track coupon revocation (1 ms)
      ‚úì should store event metadata (1 ms)
      ‚úì should handle database errors gracefully
    Profile Change Tracking
      ‚úì should track single profile change (1 ms)
      ‚úì should track email change (1 ms)
      ‚úì should track phone number change
      ‚úì should track date of birth change (1 ms)
      ‚úì should track gender change
      ‚úì should track avatar URL change (1 ms)
      ‚úì should track multiple profile changes (1 ms)
      ‚úì should handle profile change with metadata
      ‚úì should handle empty changes array (1 ms)
    Event Querying
      ‚úì should query events by user (1 ms)
      ‚úì should query events by coupon
      ‚úì should query events by type (1 ms)
    Error Handling
      ‚úì should handle invalid user ID
      ‚úì should handle invalid coupon ID
      ‚úì should handle database connection errors (1 ms)
    Performance
      ‚úì should handle bulk event tracking (1 ms)
      ‚úì should handle concurrent tracking requests

PASS src/__tests__/unit/middleware/errorHandler.test.ts
  ErrorHandler Middleware
    AppError class
      ‚úì should create AppError with status code and message (42 ms)
      ‚úì should set isOperational flag (2 ms)
      ‚úì should maintain proper prototype chain (1 ms)
      ‚úì should have error message accessible (2 ms)
    ZodError handling
      ‚úì should handle ZodError with validation details (7 ms)
      ‚úì should format ZodError details correctly (3 ms)
      ‚úì should handle multiple validation errors (2 ms)
      ‚úì should handle nested field validation errors (1 ms)
    AppError handling
      ‚úì should handle 401 Unauthorized error (2 ms)
      ‚úì should handle 403 Forbidden error (1 ms)
      ‚úì should handle 404 Not Found error (1 ms)
      ‚úì should handle 409 Conflict error (1 ms)
      ‚úì should handle custom status codes (1 ms)
    unexpected error handling
      ‚úì should log unexpected errors (15 ms)
      ‚úì should include stack trace in logs (1 ms)
      ‚úì should return 500 for unexpected errors (2 ms)
      ‚úì should hide error details in production (1 ms)
      ‚úì should expose error details in development (2 ms)
    error type precedence
      ‚úì should handle ZodError before generic Error (1 ms)
      ‚úì should handle AppError before generic Error (1 ms)
    edge cases
      ‚úì should handle errors without message (1 ms)
      ‚úì should handle errors without stack trace (1 ms)
      ‚úì should handle null or undefined request properties (1 ms)
      ‚úì should not call next function (terminal middleware) (1 ms)
    response consistency
      ‚úì should always return JSON responses (2 ms)
      ‚úì should include error field in all responses (4 ms)
      ‚úì should return appropriate HTTP status codes (3 ms)

PASS src/__tests__/unit/services/loyaltyService.test.ts
  LoyaltyService
    User Loyalty Initialization
      ‚úì should create user with zero points initially (2 ms)
      ‚úì should have valid user structure (1 ms)
    Points Management
      ‚úì should award points correctly (1 ms)
      ‚úì should handle negative points (deductions) (1 ms)
      ‚úì should calculate total points correctly from transactions
    Transaction Types
      ‚úì should support earned_stay transactions (1 ms)
      ‚úì should support bonus transactions
      ‚úì should support admin transactions (1 ms)
      ‚úì should support redemption transactions
    Data Integrity
      ‚úì should require valid user ID for transactions (10 ms)
      ‚úì should require transaction type (2 ms)
      ‚úì should validate points as number (1 ms)
    Edge Cases
      ‚úì should handle zero points transaction (1 ms)
      ‚úì should handle very large point values (1 ms)
      ‚úì should handle transactions without description
    Query Performance
      ‚úì should efficiently query user transactions (1 ms)
      ‚úì should efficiently calculate user total points (1 ms)
    Business Logic Validation
      ‚úì should support different transaction types with correct semantics (3 ms)
      ‚úì should maintain transaction chronological order (8 ms)

PASS src/__tests__/unit/middleware/validateRequest.test.ts
  validateRequest Middleware
    single schema validation (backward compatibility)
      ‚úì should validate valid request body (3 ms)
      ‚úì should reject invalid email format (2 ms)
      ‚úì should reject password too short (2 ms)
      ‚úì should reject missing required fields (1 ms)
      ‚úì should allow optional fields (1 ms)
    multi-part validation (body, params, query)
      ‚úì should validate request body (1 ms)
      ‚úì should validate request params (1 ms)
      ‚úì should validate request query (1 ms)
      ‚úì should validate all parts simultaneously (1 ms)
      ‚úì should reject invalid params (1 ms)
      ‚úì should reject invalid query parameters (1 ms)
    complex validation scenarios
      ‚úì should validate nested objects (1 ms)
      ‚úì should validate arrays (1 ms)
      ‚úì should reject arrays with invalid items (1 ms)
      ‚úì should validate enums (1 ms)
      ‚úì should reject invalid enum values (1 ms)
      ‚úì should validate dates (1 ms)
      ‚úì should validate numbers with constraints
    error logging
      ‚úì should log validation errors with request details (1 ms)
      ‚úì should include error details in log
      ‚úì should log params and query in validation errors
    edge cases
      ‚úì should handle empty body validation
      ‚úì should reject extra fields in strict mode (1 ms)
      ‚úì should allow extra fields in non-strict mode (1 ms)
      ‚úì should handle undefined body gracefully (1 ms)
      ‚úì should handle null values

PASS src/__tests__/integration/database/schema.test.ts
  Database Schema Integration
    User Table Constraints
      ‚úì should enforce email uniqueness (18 ms)
      ‚úì should enforce membership ID uniqueness (1 ms)
      ‚úì should require valid email format in application layer (6 ms)
      ‚úì should have proper timestamps (2 ms)
    Loyalty Transaction Relationships
      ‚úì should enforce foreign key constraint to users (3 ms)
      ‚úì should allow multiple transactions per user (2 ms)
      ‚úì should maintain transaction integrity during user deletion (1 ms)
    Coupon Relationships
      ‚úì should enforce foreign key constraint to users (2 ms)
      ‚úì should enforce QR code uniqueness (2 ms)
      ‚úì should support different coupon statuses (2 ms)
    Data Integrity Constraints
      ‚úì should prevent negative loyalty points in business logic (1 ms)
      ‚úì should handle concurrent user creation (3 ms)
      ‚úì should handle transaction rollback on constraint violation (2 ms)
    Database Performance
      ‚úì should efficiently query users by email (1 ms)
      ‚úì should efficiently query loyalty transactions by user (1 ms)
      ‚úì should efficiently aggregate loyalty points (1 ms)
    Schema Evolution
      ‚úì should support adding new fields without breaking existing data (1 ms)
      ‚úì should handle nullable fields appropriately (1 ms)

FAIL src/__tests__/unit/services/oauthService.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/user.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/translation.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m29[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m29[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m464[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m464[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/unit/services/translationService.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m37[0m:[93m42[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m37[0m       query: jest.fn().mockResolvedValue({ rows: [] } as any)
    [7m  [0m [91m                                         ~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m187[0m:[93m57[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m187[0m       const mockPoolQuery = jest.fn().mockResolvedValue({ rows: [] } as any);
    [7m   [0m [91m                                                        ~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m209[0m:[93m57[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m209[0m       const mockPoolQuery = jest.fn().mockResolvedValue({ rows: [] } as any);
    [7m   [0m [91m                                                        ~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/storage.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m35[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m39[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m39[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m128[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m128[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m149[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m149[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m345[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m345[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m365[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m365[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/notifications.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m282[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m282[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/oauth.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m51[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m51[0m       req.session = {
    [7m  [0m [91m      ~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m331[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m331[0m         req.session = {
    [7m   [0m [91m        ~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/loyalty.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/membership.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m15[0m - [91merror[0m[90m TS6133: [0m'roles' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m              ~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m45[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                            ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m67[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                                  ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m340[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m340[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/auth.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/analyticsRoutes.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m27[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m31[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m31[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m37[0m:[93m7[0m - [91merror[0m[90m TS6133: [0m'mockAuthorizeMiddleware' is declared but its value is never read.

    [7m37[0m const mockAuthorizeMiddleware = (...allowedRoles: string[]) => {
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m19[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                  ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m41[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                        ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m327[0m:[93m15[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m327[0m       app.use((req, res, next) => {
    [7m   [0m [91m              ~~~~~~~~~~~~~~~~~~~~~[0m

2025-11-12 09:21:54 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"received":"invalid_type","code":"invalid_enum_value","options":["multiple_choice","single_choice","text","textarea","rating_5","rating_10","yes_no"],"path":["questions",0,"type"],"message":"Invalid enum value. Expected 'multiple_choice' | 'single_choice' | 'text' | 'textarea' | 'rating_5' | 'rating_10' | 'yes_no', received 'invalid_type'"}],"requestBody":{"title":"Invalid Survey","questions":[{"id":"q1","type":"invalid_type","text":"Question","required":true,"order":1}],"access_type":"public"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:21:54 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"code":"too_small","minimum":1,"type":"array","inclusive":true,"exact":false,"message":"Array must contain at least 1 element(s)","path":["questions"]}],"requestBody":{"title":"Empty Survey","questions":[],"access_type":"public"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:22:44 [[31merror[39m]: Validation Error Details: {"url":"/redeem","method":"POST","errors":[{"code":"invalid_type","expected":"number","received":"undefined","path":["originalAmount"],"message":"Required"}],"requestBody":{"qrCode":"QR-CODE-123"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:22:44 [[31merror[39m]: Validation Error Details: {"url":"/redeem","method":"POST","errors":[{"code":"too_small","minimum":0.01,"type":"number","inclusive":true,"exact":false,"message":"Number must be greater than or equal to 0.01","path":["originalAmount"]}],"requestBody":{"qrCode":"QR-CODE-123","originalAmount":0},"requestParams":{},"requestQuery":{}}
2025-11-12 09:22:54 [[31merror[39m]: Validation Error Details: {"url":"/survey-123","method":"PUT","errors":[{"received":"invalid_status","code":"invalid_enum_value","options":["draft","active","paused","completed","archived"],"path":["status"],"message":"Invalid enum value. Expected 'draft' | 'active' | 'paused' | 'completed' | 'archived', received 'invalid_status'"}],"requestBody":{"status":"invalid_status"},"requestParams":{"id":"survey-123"},"requestQuery":{}}
2025-11-12 09:23:14 [[31merror[39m]: Validation Error Details: {"url":"/responses","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["survey_id"]}],"requestBody":{"survey_id":"not-a-uuid","answers":{"q1":"answer"}},"requestParams":{},"requestQuery":{}}
2025-11-12 09:23:44 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"validation":"regex","code":"invalid_string","message":"Code must contain only uppercase letters, numbers, underscores, and hyphens","path":["code"]}],"requestBody":{"code":"invalid code","name":"Invalid Coupon","type":"percentage","value":10},"requestParams":{},"requestQuery":{}}
2025-11-12 09:23:44 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"code":"invalid_type","expected":"string","received":"undefined","path":["name"],"message":"Required"},{"expected":"'percentage' | 'fixed_amount' | 'bogo' | 'free_upgrade' | 'free_service'","received":"undefined","code":"invalid_type","path":["type"],"message":"Required"}],"requestBody":{"code":"INCOMPLETE"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:23:54 [[31merror[39m]: Validation Error Details: {"url":"/coupon-123","method":"PUT","errors":[{"validation":"regex","code":"invalid_string","message":"Invalid","path":["code"]}],"requestBody":{"code":"invalid code"},"requestParams":{"couponId":"coupon-123"},"requestQuery":{}}
2025-11-12 09:24:14 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["couponId"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",1]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",2]}],"requestBody":{"couponId":"coupon-uuid","userIds":["user-1","user-2","user-3"],"assignedReason":"Loyalty reward"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:24:14 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["couponId"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]}],"requestBody":{"couponId":"not-a-uuid","userIds":["user-1"]},"requestParams":{},"requestQuery":{}}
2025-11-12 09:24:14 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"code":"too_big","maximum":100,"type":"array","inclusive":true,"exact":false,"message":"Array must contain at most 100 element(s)","path":["userIds"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",1]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",2]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",3]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",4]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",5]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",6]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",7]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",8]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",9]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",10]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",11]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",12]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",13]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",14]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",15]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",16]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",17]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",18]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",19]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",20]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",21]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",22]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",23]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",24]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",25]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",26]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",27]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",28]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",29]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",30]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",31]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",32]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",33]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",34]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",35]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",36]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",37]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",38]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",39]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",40]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",41]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",42]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",43]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",44]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",45]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",46]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",47]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",48]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",49]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",50]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",51]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",52]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",53]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",54]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",55]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",56]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",57]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",58]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",59]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",60]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",61]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",62]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",63]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",64]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",65]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",66]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",67]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",68]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",69]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",70]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",71]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",72]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",73]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",74]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",75]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",76]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",77]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",78]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",79]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",80]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",81]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",82]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",83]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",84]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",85]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",86]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",87]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",88]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",89]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",90]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",91]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",92]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",93]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",94]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",95]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",96]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",97]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",98]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",99]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",100]}],"requestBody":{"couponId":"550e8400-e29b-41d4-a716-446655440000","userIds":["user-0","user-1","user-2","user-3","user-4","user-5","user-6","user-7","user-8","user-9","user-10","user-11","user-12","user-13","user-14","user-15","user-16","user-17","user-18","user-19","user-20","user-21","user-22","user-23","user-24","user-25","user-26","user-27","user-28","user-29","user-30","user-31","user-32","user-33","user-34","user-35","user-36","user-37","user-38","user-39","user-40","user-41","user-42","user-43","user-44","user-45","user-46","user-47","user-48","user-49","user-50","user-51","user-52","user-53","user-54","user-55","user-56","user-57","user-58","user-59","user-60","user-61","user-62","user-63","user-64","user-65","user-66","user-67","user-68","user-69","user-70","user-71","user-72","user-73","user-74","user-75","user-76","user-77","user-78","user-79","user-80","user-81","user-82","user-83","user-84","user-85","user-86","user-87","user-88","user-89","user-90","user-91","user-92","user-93","user-94","user-95","user-96","user-97","user-98","user-99","user-100"]},"requestParams":{},"requestQuery":{}}
FAIL src/__tests__/integration/routes/coupon.test.ts (215.554 s)
  Coupon Routes Integration Tests
    GET /api/coupons/validate/:qrCode
      ‚úï should validate coupon by QR code (public route) (10003 ms)
      ‚úï should return invalid for expired coupon (10000 ms)
      ‚úï should return invalid for already used coupon (10000 ms)
    GET /api/coupons/my-coupons
      ‚úï should get user coupons (10007 ms)
      ‚úï should return empty array for user with no coupons (10003 ms)
    POST /api/coupons/redeem
      ‚úï should redeem coupon with valid QR code (9999 ms)
      ‚úì should reject redemption with missing required fields (13 ms)
      ‚úì should reject redemption with invalid amount (5 ms)
      ‚úï should handle redemption of percentage discount coupon (10000 ms)
    GET /api/coupons
      ‚úï should list all active coupons (10000 ms)
      ‚úï should support pagination for coupon list (10000 ms)
    GET /api/coupons/:couponId
      ‚úï should get specific coupon details (10000 ms)
      ‚úï should handle coupon not found (10001 ms)
    POST /api/coupons (Admin)
      ‚úï should create coupon with valid data (10000 ms)
      ‚úì should reject invalid coupon code format (9 ms)
      ‚úì should reject missing required fields (4 ms)
    PUT /api/coupons/:couponId (Admin)
      ‚úï should update coupon (10001 ms)
      ‚úì should reject invalid update data (5 ms)
    DELETE /api/coupons/:couponId (Admin)
      ‚úï should delete coupon (10000 ms)
      ‚úï should handle deletion of non-existent coupon (10002 ms)
    POST /api/coupons/assign (Admin)
      ‚úï should assign coupon to users (7 ms)
      ‚úì should reject assignment with invalid coupon ID (4 ms)
      ‚úì should reject assignment with too many users (8 ms)
    POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)
      ‚úï should revoke user coupon (10000 ms)
      ‚úï should revoke coupon without reason (9999 ms)
    GET /api/coupons/analytics/stats (Admin)
      ‚úï should get coupon statistics (10000 ms)
    GET /api/coupons/analytics/data (Admin)
      ‚úï should get coupon analytics data (10001 ms)
    GET /api/coupons/:couponId/redemptions (Admin)
      ‚úï should get coupon redemption history (10001 ms)
    GET /api/coupons/:couponId/assignments (Admin)
      ‚úï should get coupon assignment history (10001 ms)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should validate coupon by QR code (public route)

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('GET /api/coupons/validate/:qrCode', () => {
    > 54 |     it('should validate coupon by QR code (public route)', async () => {
         |     ^
      55 |       mockCouponController.validateCoupon = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:54:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should return invalid for expired coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      80 |     });
      81 |
    > 82 |     it('should return invalid for expired coupon', async () => {
         |     ^
      83 |       mockCouponController.validateCoupon = jest.fn((
      84 |         _req: Request,
      85 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:82:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should return invalid for already used coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      102 |     });
      103 |
    > 104 |     it('should return invalid for already used coupon', async () => {
          |     ^
      105 |       mockCouponController.validateCoupon = jest.fn((
      106 |         _req: Request,
      107 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:104:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/my-coupons ‚Ä∫ should get user coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      125 |
      126 |   describe('GET /api/coupons/my-coupons', () => {
    > 127 |     it('should get user coupons', async () => {
          |     ^
      128 |       mockCouponController.getUserCoupons = jest.fn((
      129 |         _req: Request,
      130 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:127:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/my-coupons ‚Ä∫ should return empty array for user with no coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      160 |     });
      161 |
    > 162 |     it('should return empty array for user with no coupons', async () => {
          |     ^
      163 |       mockCouponController.getUserCoupons = jest.fn((
      164 |         _req: Request,
      165 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:162:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/redeem ‚Ä∫ should redeem coupon with valid QR code

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      177 |
      178 |   describe('POST /api/coupons/redeem', () => {
    > 179 |     it('should redeem coupon with valid QR code', async () => {
          |     ^
      180 |       mockCouponController.redeemCoupon = jest.fn((
      181 |         _req: Request,
      182 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:179:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/redeem ‚Ä∫ should handle redemption of percentage discount coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      233 |     });
      234 |
    > 235 |     it('should handle redemption of percentage discount coupon', async () => {
          |     ^
      236 |       mockCouponController.redeemCoupon = jest.fn((
      237 |         _req: Request,
      238 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:235:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons ‚Ä∫ should list all active coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      265 |
      266 |   describe('GET /api/coupons', () => {
    > 267 |     it('should list all active coupons', async () => {
          |     ^
      268 |       mockCouponController.listCoupons = jest.fn((
      269 |         _req: Request,
      270 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:267:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons ‚Ä∫ should support pagination for coupon list

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should support pagination for coupon list', async () => {
          |     ^
      289 |       mockCouponController.listCoupons = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:288:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId ‚Ä∫ should get specific coupon details

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      307 |
      308 |   describe('GET /api/coupons/:couponId', () => {
    > 309 |     it('should get specific coupon details', async () => {
          |     ^
      310 |       mockCouponController.getCoupon = jest.fn((
      311 |         _req: Request,
      312 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:309:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId ‚Ä∫ should handle coupon not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      332 |     });
      333 |
    > 334 |     it('should handle coupon not found', async () => {
          |     ^
      335 |       mockCouponController.getCoupon = jest.fn((
      336 |         _req: Request,
      337 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:334:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons (Admin) ‚Ä∫ should create coupon with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      349 |
      350 |   describe('POST /api/coupons (Admin)', () => {
    > 351 |     it('should create coupon with valid data', async () => {
          |     ^
      352 |       mockCouponController.createCoupon = jest.fn((
      353 |         _req: Request,
      354 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:351:5
      at src/__tests__/integration/routes/coupon.test.ts:350:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ PUT /api/coupons/:couponId (Admin) ‚Ä∫ should update coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      408 |
      409 |   describe('PUT /api/coupons/:couponId (Admin)', () => {
    > 410 |     it('should update coupon', async () => {
          |     ^
      411 |       mockCouponController.updateCoupon = jest.fn((
      412 |         _req: Request,
      413 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:410:5
      at src/__tests__/integration/routes/coupon.test.ts:409:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ DELETE /api/coupons/:couponId (Admin) ‚Ä∫ should delete coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      447 |
      448 |   describe('DELETE /api/coupons/:couponId (Admin)', () => {
    > 449 |     it('should delete coupon', async () => {
          |     ^
      450 |       mockCouponController.deleteCoupon = jest.fn((
      451 |         _req: Request,
      452 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:449:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ DELETE /api/coupons/:couponId (Admin) ‚Ä∫ should handle deletion of non-existent coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      465 |     });
      466 |
    > 467 |     it('should handle deletion of non-existent coupon', async () => {
          |     ^
      468 |       mockCouponController.deleteCoupon = jest.fn((
      469 |         _req: Request,
      470 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:467:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/assign (Admin) ‚Ä∫ should assign coupon to users

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      505 |         });
      506 |
    > 507 |       expect(response.status).toBe(200);
          |                               ^
      508 |       expect(response.body.data.assigned).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:507:31)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) ‚Ä∫ should revoke user coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      535 |
      536 |   describe('POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)', () => {
    > 537 |     it('should revoke user coupon', async () => {
          |     ^
      538 |       mockCouponController.revokeUserCoupon = jest.fn((
      539 |         _req: Request,
      540 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:537:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) ‚Ä∫ should revoke coupon without reason

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      556 |     });
      557 |
    > 558 |     it('should revoke coupon without reason', async () => {
          |     ^
      559 |       mockCouponController.revokeUserCoupon = jest.fn((
      560 |         _req: Request,
      561 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:558:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/analytics/stats (Admin) ‚Ä∫ should get coupon statistics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      573 |
      574 |   describe('GET /api/coupons/analytics/stats (Admin)', () => {
    > 575 |     it('should get coupon statistics', async () => {
          |     ^
      576 |       mockCouponController.getCouponStats = jest.fn((
      577 |         _req: Request,
      578 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:575:5
      at src/__tests__/integration/routes/coupon.test.ts:574:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/analytics/data (Admin) ‚Ä∫ should get coupon analytics data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      599 |
      600 |   describe('GET /api/coupons/analytics/data (Admin)', () => {
    > 601 |     it('should get coupon analytics data', async () => {
          |     ^
      602 |       mockCouponController.getCouponAnalytics = jest.fn((
      603 |         _req: Request,
      604 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:601:5
      at src/__tests__/integration/routes/coupon.test.ts:600:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId/redemptions (Admin) ‚Ä∫ should get coupon redemption history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      625 |
      626 |   describe('GET /api/coupons/:couponId/redemptions (Admin)', () => {
    > 627 |     it('should get coupon redemption history', async () => {
          |     ^
      628 |       mockCouponController.getCouponRedemptions = jest.fn((
      629 |         _req: Request,
      630 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:627:5
      at src/__tests__/integration/routes/coupon.test.ts:626:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId/assignments (Admin) ‚Ä∫ should get coupon assignment history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      652 |
      653 |   describe('GET /api/coupons/:couponId/assignments (Admin)', () => {
    > 654 |     it('should get coupon assignment history', async () => {
          |     ^
      655 |       mockCouponController.getCouponAssignments = jest.fn((
      656 |         _req: Request,
      657 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:654:5
      at src/__tests__/integration/routes/coupon.test.ts:653:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

2025-11-12 09:25:34 [[31merror[39m]: Validation Error Details: {"url":"/coupon-assignments","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["survey_id"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["coupon_id"]}],"requestBody":{"survey_id":"not-a-uuid","coupon_id":"also-not-a-uuid"},"requestParams":{},"requestQuery":{}}
FAIL src/__tests__/integration/routes/survey.test.ts (295.723 s)
  Survey Routes Integration Tests
    POST /api/surveys (Admin)
      ‚úï should create survey with valid data (10004 ms)
      ‚úì should reject survey with invalid question type (12 ms)
      ‚úì should reject survey without questions (5 ms)
      ‚úï should create survey with target segment (10000 ms)
    GET /api/surveys
      ‚úï should get all surveys (10000 ms)
      ‚úï should support pagination (10000 ms)
    GET /api/surveys/:id
      ‚úï should get specific survey (10009 ms)
      ‚úï should handle survey not found (10000 ms)
    PUT /api/surveys/:id (Admin)
      ‚úï should update survey (10001 ms)
      ‚úì should reject invalid status (9 ms)
    DELETE /api/surveys/:id (Admin)
      ‚úï should delete survey (10000 ms)
    POST /api/surveys/responses
      ‚úï should submit survey response (9999 ms)
      ‚úì should reject invalid survey ID (4 ms)
      ‚úï should handle partial response submission (10000 ms)
    GET /api/surveys/responses/:surveyId/user
      ‚úï should get user response for survey (10001 ms)
      ‚úï should return null for survey with no user response (10000 ms)
    GET /api/surveys/:surveyId/responses (Admin)
      ‚úï should get all survey responses (10000 ms)
    GET /api/surveys/available/user
      ‚úï should get available surveys for user (10007 ms)
    GET /api/surveys/public/user
      ‚úï should get public surveys (10001 ms)
    GET /api/surveys/invited/user
      ‚úï should get invited surveys for user (10000 ms)
    GET /api/surveys/:surveyId/analytics (Admin)
      ‚úï should get survey analytics (10001 ms)
    GET /api/surveys/:surveyId/export (Admin)
      ‚úï should export survey responses (20007 ms)
    POST /api/surveys/:surveyId/invitations/send (Admin)
      ‚úï should send survey invitations (20000 ms)
    POST /api/surveys/coupon-assignments (Admin)
      ‚úï should assign coupon to survey (20005 ms)
      ‚úì should reject invalid UUID format (4 ms)
    GET /api/surveys/:surveyId/coupon-assignments (Admin)
      ‚úï should get survey coupon assignments (20000 ms)
    GET /api/surveys/:surveyId/reward-history (Admin)
      ‚úï should get survey reward history (20000 ms)
    GET /api/surveys/admin/coupon-assignments (Admin)
      ‚úï should get all survey coupon assignments (20005 ms)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys (Admin) ‚Ä∫ should create survey with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('POST /api/surveys (Admin)', () => {
    > 54 |     it('should create survey with valid data', async () => {
         |     ^
      55 |       mockSurveyController.createSurvey = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:54:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys (Admin) ‚Ä∫ should create survey with target segment

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |     });
      123 |
    > 124 |     it('should create survey with target segment', async () => {
          |     ^
      125 |       mockSurveyController.createSurvey = jest.fn((
      126 |         _req: Request,
      127 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:124:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys ‚Ä∫ should get all surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      165 |
      166 |   describe('GET /api/surveys', () => {
    > 167 |     it('should get all surveys', async () => {
          |     ^
      168 |       mockSurveyController.getSurveys = jest.fn((
      169 |         _req: Request,
      170 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:167:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys ‚Ä∫ should support pagination

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      186 |     });
      187 |
    > 188 |     it('should support pagination', async () => {
          |     ^
      189 |       mockSurveyController.getSurveys = jest.fn((
      190 |         _req: Request,
      191 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:188:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:id ‚Ä∫ should get specific survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      207 |
      208 |   describe('GET /api/surveys/:id', () => {
    > 209 |     it('should get specific survey', async () => {
          |     ^
      210 |       mockSurveyController.getSurvey = jest.fn((
      211 |         _req: Request,
      212 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:209:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:id ‚Ä∫ should handle survey not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |     });
      231 |
    > 232 |     it('should handle survey not found', async () => {
          |     ^
      233 |       mockSurveyController.getSurvey = jest.fn((
      234 |         _req: Request,
      235 |         _res: Response,

      at src/__tests__/integration/routes/survey.test.ts:232:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ PUT /api/surveys/:id (Admin) ‚Ä∫ should update survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      247 |
      248 |   describe('PUT /api/surveys/:id (Admin)', () => {
    > 249 |     it('should update survey', async () => {
          |     ^
      250 |       mockSurveyController.updateSurvey = jest.fn((
      251 |         _req: Request,
      252 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:249:5
      at src/__tests__/integration/routes/survey.test.ts:248:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ DELETE /api/surveys/:id (Admin) ‚Ä∫ should delete survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |
      287 |   describe('DELETE /api/surveys/:id (Admin)', () => {
    > 288 |     it('should delete survey', async () => {
          |     ^
      289 |       mockSurveyController.deleteSurvey = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:288:5
      at src/__tests__/integration/routes/survey.test.ts:287:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/responses ‚Ä∫ should submit survey response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      306 |
      307 |   describe('POST /api/surveys/responses', () => {
    > 308 |     it('should submit survey response', async () => {
          |     ^
      309 |       mockSurveyController.submitResponse = jest.fn((
      310 |         _req: Request,
      311 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:308:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/responses ‚Ä∫ should handle partial response submission

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      352 |     });
      353 |
    > 354 |     it('should handle partial response submission', async () => {
          |     ^
      355 |       mockSurveyController.submitResponse = jest.fn((
      356 |         _req: Request,
      357 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:354:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/responses/:surveyId/user ‚Ä∫ should get user response for survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      380 |
      381 |   describe('GET /api/surveys/responses/:surveyId/user', () => {
    > 382 |     it('should get user response for survey', async () => {
          |     ^
      383 |       mockSurveyController.getUserResponse = jest.fn((
      384 |         _req: Request,
      385 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:382:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/responses/:surveyId/user ‚Ä∫ should return null for survey with no user response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      403 |     });
      404 |
    > 405 |     it('should return null for survey with no user response', async () => {
          |     ^
      406 |       mockSurveyController.getUserResponse = jest.fn((
      407 |         _req: Request,
      408 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:405:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/responses (Admin) ‚Ä∫ should get all survey responses

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      420 |
      421 |   describe('GET /api/surveys/:surveyId/responses (Admin)', () => {
    > 422 |     it('should get all survey responses', async () => {
          |     ^
      423 |       mockSurveyController.getSurveyResponses = jest.fn((
      424 |         _req: Request,
      425 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:422:5
      at src/__tests__/integration/routes/survey.test.ts:421:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/available/user ‚Ä∫ should get available surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      443 |
      444 |   describe('GET /api/surveys/available/user', () => {
    > 445 |     it('should get available surveys for user', async () => {
          |     ^
      446 |       mockSurveyController.getAvailableSurveys = jest.fn((
      447 |         _req: Request,
      448 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:445:5
      at src/__tests__/integration/routes/survey.test.ts:444:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/public/user ‚Ä∫ should get public surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      466 |
      467 |   describe('GET /api/surveys/public/user', () => {
    > 468 |     it('should get public surveys', async () => {
          |     ^
      469 |       mockSurveyController.getPublicSurveys = jest.fn((
      470 |         _req: Request,
      471 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:468:5
      at src/__tests__/integration/routes/survey.test.ts:467:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/invited/user ‚Ä∫ should get invited surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      488 |
      489 |   describe('GET /api/surveys/invited/user', () => {
    > 490 |     it('should get invited surveys for user', async () => {
          |     ^
      491 |       mockSurveyController.getInvitedSurveys = jest.fn((
      492 |         _req: Request,
      493 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:490:5
      at src/__tests__/integration/routes/survey.test.ts:489:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/analytics (Admin) ‚Ä∫ should get survey analytics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      510 |
      511 |   describe('GET /api/surveys/:surveyId/analytics (Admin)', () => {
    > 512 |     it('should get survey analytics', async () => {
          |     ^
      513 |       mockSurveyController.getSurveyAnalytics = jest.fn((
      514 |         _req: Request,
      515 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:512:5
      at src/__tests__/integration/routes/survey.test.ts:511:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/export (Admin) ‚Ä∫ should export survey responses

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      536 |
      537 |   describe('GET /api/surveys/:surveyId/export (Admin)', () => {
    > 538 |     it('should export survey responses', async () => {
          |     ^
      539 |       mockSurveyController.exportSurveyResponses = jest.fn((
      540 |         _req: Request,
      541 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:538:5
      at src/__tests__/integration/routes/survey.test.ts:537:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/:surveyId/invitations/send (Admin) ‚Ä∫ should send survey invitations

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      554 |
      555 |   describe('POST /api/surveys/:surveyId/invitations/send (Admin)', () => {
    > 556 |     it('should send survey invitations', async () => {
          |     ^
      557 |       mockSurveyController.sendSurveyInvitations = jest.fn((
      558 |         _req: Request,
      559 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:556:5
      at src/__tests__/integration/routes/survey.test.ts:555:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/coupon-assignments (Admin) ‚Ä∫ should assign coupon to survey

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      578 |
      579 |   describe('POST /api/surveys/coupon-assignments (Admin)', () => {
    > 580 |     it('should assign coupon to survey', async () => {
          |     ^
      581 |       mockSurveyController.assignCouponToSurvey = jest.fn((
      582 |         _req: Request,
      583 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:580:5
      at src/__tests__/integration/routes/survey.test.ts:579:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/coupon-assignments (Admin) ‚Ä∫ should get survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      620 |
      621 |   describe('GET /api/surveys/:surveyId/coupon-assignments (Admin)', () => {
    > 622 |     it('should get survey coupon assignments', async () => {
          |     ^
      623 |       mockSurveyController.getSurveyCouponAssignments = jest.fn((
      624 |         _req: Request,
      625 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:622:5
      at src/__tests__/integration/routes/survey.test.ts:621:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/reward-history (Admin) ‚Ä∫ should get survey reward history

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      647 |
      648 |   describe('GET /api/surveys/:surveyId/reward-history (Admin)', () => {
    > 649 |     it('should get survey reward history', async () => {
          |     ^
      650 |       mockSurveyController.getSurveyRewardHistory = jest.fn((
      651 |         _req: Request,
      652 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:649:5
      at src/__tests__/integration/routes/survey.test.ts:648:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/admin/coupon-assignments (Admin) ‚Ä∫ should get all survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      678 |
      679 |   describe('GET /api/surveys/admin/coupon-assignments (Admin)', () => {
    > 680 |     it('should get all survey coupon assignments', async () => {
          |     ^
      681 |       mockSurveyController.getAllSurveyCouponAssignments = jest.fn((
      682 |         _req: Request,
      683 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:680:5
      at src/__tests__/integration/routes/survey.test.ts:679:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/__tests__/unit/middleware/security.test.ts (5.526 s)
  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create basic rate limiter

    TypeError: Cannot read properties of undefined (reading 'rateLimitWindowMs')

      13 | export const createRateLimiter = () => {
      14 |   return rateLimit({
    > 15 |     windowMs: securityConfig.rateLimitWindowMs, // 15 minutes
         |                              ^
      16 |     max: securityConfig.rateLimitMaxRequests, // limit each IP to 100 requests per windowMs
      17 |     message: {
      18 |       error: 'Too many requests',

      at createRateLimiter (src/middleware/security.ts:15:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:83:44)

  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create API rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      54 |   };
      55 |   
    > 56 |   const limits = isProduction() ? productionLimits : developmentLimits;
         |                              ^
      57 |   
      58 |   return rateLimit({
      59 |     windowMs: limits.windowMs,

      at createApiRateLimiter (src/middleware/security.ts:56:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:89:46)

  ‚óè Security Middleware ‚Ä∫ Rate Limiter Creation ‚Ä∫ should create user-specific rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      111 |   };
      112 |   
    > 113 |   const limits = isProduction() ? productionLimits : developmentLimits;
          |                              ^
      114 |   
      115 |   return rateLimit({
      116 |     windowMs: limits.windowMs,

      at createUserRateLimiter (src/middleware/security.ts:113:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:95:48)

  ‚óè Security Middleware ‚Ä∫ Security Headers ‚Ä∫ should set custom security headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:114:28)

  ‚óè Security Middleware ‚Ä∫ Security Headers ‚Ä∫ should set HSTS header with correct max-age

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:124:28)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should validate file upload requests

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:199:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should handle requests without files

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:206:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should validate file types

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:220:25)

  ‚óè Security Middleware ‚Ä∫ File Upload Security ‚Ä∫ should handle multiple file uploads

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:243:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should apply production security

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:290:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should work in development mode

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:296:25)

  ‚óè Security Middleware ‚Ä∫ Production Security ‚Ä∫ should handle missing NODE_ENV

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:302:25)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should set CSRF protection headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:357:28)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should prevent clickjacking

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:362:28)

  ‚óè Security Middleware ‚Ä∫ CSRF Protection Headers ‚Ä∫ should prevent MIME sniffing

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:367:28)

  ‚óè Security Middleware ‚Ä∫ Error Scenarios ‚Ä∫ should handle sanitization errors gracefully

    RangeError: Maximum call stack size exceeded

      258 |         .trim();
      259 |     }
    > 260 |     if (Array.isArray(value)) {
          |     ^
      261 |       return value.map(sanitizeValue);
      262 |     }
      263 |     if (value && typeof value === 'object' && value !== null) {

      at sanitizeValue (src/middleware/security.ts:260:5)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)

  ‚óè Security Middleware ‚Ä∫ Error Scenarios ‚Ä∫ should continue on setHeader errors

    Header error

      394 |     test('should continue on setHeader errors', () => {
      395 |       (mockRes.setHeader as jest.Mock).mockImplementation(() => {
    > 396 |         throw new Error('Header error');
          |               ^
      397 |       });
      398 |
      399 |       // The middleware should continue even if setHeader throws

      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:396:15)
      at customSecurityHeaders (src/middleware/security.ts:227:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:400:28)

FAIL src/__tests__/unit/services/membershipIdService.test.ts
  ‚óè MembershipIdService ‚Ä∫ generateUniqueMembershipId ‚Ä∫ should generate sequential IDs within block boundaries

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not "26900067"

      65 |       expect(firstId).toMatch(/^269\d{5}$/);
      66 |       expect(secondId).toMatch(/^269\d{5}$/);
    > 67 |       expect(firstId).not.toBe(secondId);  // Should be different
         |                           ^
      68 |     });
      69 |
      70 |     test('should handle block boundaries correctly', async () => {

      at Object.<anonymous> (src/__tests__/unit/services/membershipIdService.test.ts:67:27)

FAIL src/__tests__/unit/services/oauthService.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/user.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/translation.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m29[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m29[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m464[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m464[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/unit/services/translationService.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m37[0m:[93m42[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m37[0m       query: jest.fn().mockResolvedValue({ rows: [] } as any)
    [7m  [0m [91m                                         ~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m187[0m:[93m57[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m187[0m       const mockPoolQuery = jest.fn().mockResolvedValue({ rows: [] } as any);
    [7m   [0m [91m                                                        ~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/translationService.test.ts[0m:[93m209[0m:[93m57[0m - [91merror[0m[90m TS2345: [0mArgument of type 'any' is not assignable to parameter of type 'never'.

    [7m209[0m       const mockPoolQuery = jest.fn().mockResolvedValue({ rows: [] } as any);
    [7m   [0m [91m                                                        ~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/storage.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m35[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m39[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m39[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m128[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m128[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m149[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m149[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m345[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m345[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m365[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m365[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/notifications.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m282[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m282[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/oauth.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m51[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m51[0m       req.session = {
    [7m  [0m [91m      ~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m331[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m331[0m         req.session = {
    [7m   [0m [91m        ~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/loyalty.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/membership.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m15[0m - [91merror[0m[90m TS6133: [0m'roles' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m              ~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m45[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                            ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m67[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                                  ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m340[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m340[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/auth.test.ts
  ‚óè Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/analyticsRoutes.test.ts
  ‚óè Test suite failed to run

    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m27[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m31[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m31[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m37[0m:[93m7[0m - [91merror[0m[90m TS6133: [0m'mockAuthorizeMiddleware' is declared but its value is never read.

    [7m37[0m const mockAuthorizeMiddleware = (...allowedRoles: string[]) => {
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m19[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                  ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m41[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                        ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m327[0m:[93m15[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m327[0m       app.use((req, res, next) => {
    [7m   [0m [91m              ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/coupon.test.ts (215.554 s)
  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should validate coupon by QR code (public route)

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('GET /api/coupons/validate/:qrCode', () => {
    > 54 |     it('should validate coupon by QR code (public route)', async () => {
         |     ^
      55 |       mockCouponController.validateCoupon = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:54:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should return invalid for expired coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      80 |     });
      81 |
    > 82 |     it('should return invalid for expired coupon', async () => {
         |     ^
      83 |       mockCouponController.validateCoupon = jest.fn((
      84 |         _req: Request,
      85 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:82:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/validate/:qrCode ‚Ä∫ should return invalid for already used coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      102 |     });
      103 |
    > 104 |     it('should return invalid for already used coupon', async () => {
          |     ^
      105 |       mockCouponController.validateCoupon = jest.fn((
      106 |         _req: Request,
      107 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:104:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/my-coupons ‚Ä∫ should get user coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      125 |
      126 |   describe('GET /api/coupons/my-coupons', () => {
    > 127 |     it('should get user coupons', async () => {
          |     ^
      128 |       mockCouponController.getUserCoupons = jest.fn((
      129 |         _req: Request,
      130 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:127:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/my-coupons ‚Ä∫ should return empty array for user with no coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      160 |     });
      161 |
    > 162 |     it('should return empty array for user with no coupons', async () => {
          |     ^
      163 |       mockCouponController.getUserCoupons = jest.fn((
      164 |         _req: Request,
      165 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:162:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/redeem ‚Ä∫ should redeem coupon with valid QR code

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      177 |
      178 |   describe('POST /api/coupons/redeem', () => {
    > 179 |     it('should redeem coupon with valid QR code', async () => {
          |     ^
      180 |       mockCouponController.redeemCoupon = jest.fn((
      181 |         _req: Request,
      182 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:179:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/redeem ‚Ä∫ should handle redemption of percentage discount coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      233 |     });
      234 |
    > 235 |     it('should handle redemption of percentage discount coupon', async () => {
          |     ^
      236 |       mockCouponController.redeemCoupon = jest.fn((
      237 |         _req: Request,
      238 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:235:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons ‚Ä∫ should list all active coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      265 |
      266 |   describe('GET /api/coupons', () => {
    > 267 |     it('should list all active coupons', async () => {
          |     ^
      268 |       mockCouponController.listCoupons = jest.fn((
      269 |         _req: Request,
      270 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:267:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons ‚Ä∫ should support pagination for coupon list

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should support pagination for coupon list', async () => {
          |     ^
      289 |       mockCouponController.listCoupons = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:288:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId ‚Ä∫ should get specific coupon details

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      307 |
      308 |   describe('GET /api/coupons/:couponId', () => {
    > 309 |     it('should get specific coupon details', async () => {
          |     ^
      310 |       mockCouponController.getCoupon = jest.fn((
      311 |         _req: Request,
      312 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:309:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId ‚Ä∫ should handle coupon not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      332 |     });
      333 |
    > 334 |     it('should handle coupon not found', async () => {
          |     ^
      335 |       mockCouponController.getCoupon = jest.fn((
      336 |         _req: Request,
      337 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:334:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons (Admin) ‚Ä∫ should create coupon with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      349 |
      350 |   describe('POST /api/coupons (Admin)', () => {
    > 351 |     it('should create coupon with valid data', async () => {
          |     ^
      352 |       mockCouponController.createCoupon = jest.fn((
      353 |         _req: Request,
      354 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:351:5
      at src/__tests__/integration/routes/coupon.test.ts:350:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ PUT /api/coupons/:couponId (Admin) ‚Ä∫ should update coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      408 |
      409 |   describe('PUT /api/coupons/:couponId (Admin)', () => {
    > 410 |     it('should update coupon', async () => {
          |     ^
      411 |       mockCouponController.updateCoupon = jest.fn((
      412 |         _req: Request,
      413 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:410:5
      at src/__tests__/integration/routes/coupon.test.ts:409:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ DELETE /api/coupons/:couponId (Admin) ‚Ä∫ should delete coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      447 |
      448 |   describe('DELETE /api/coupons/:couponId (Admin)', () => {
    > 449 |     it('should delete coupon', async () => {
          |     ^
      450 |       mockCouponController.deleteCoupon = jest.fn((
      451 |         _req: Request,
      452 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:449:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ DELETE /api/coupons/:couponId (Admin) ‚Ä∫ should handle deletion of non-existent coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      465 |     });
      466 |
    > 467 |     it('should handle deletion of non-existent coupon', async () => {
          |     ^
      468 |       mockCouponController.deleteCoupon = jest.fn((
      469 |         _req: Request,
      470 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:467:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/assign (Admin) ‚Ä∫ should assign coupon to users

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      505 |         });
      506 |
    > 507 |       expect(response.status).toBe(200);
          |                               ^
      508 |       expect(response.body.data.assigned).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:507:31)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) ‚Ä∫ should revoke user coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      535 |
      536 |   describe('POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)', () => {
    > 537 |     it('should revoke user coupon', async () => {
          |     ^
      538 |       mockCouponController.revokeUserCoupon = jest.fn((
      539 |         _req: Request,
      540 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:537:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) ‚Ä∫ should revoke coupon without reason

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      556 |     });
      557 |
    > 558 |     it('should revoke coupon without reason', async () => {
          |     ^
      559 |       mockCouponController.revokeUserCoupon = jest.fn((
      560 |         _req: Request,
      561 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:558:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/analytics/stats (Admin) ‚Ä∫ should get coupon statistics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      573 |
      574 |   describe('GET /api/coupons/analytics/stats (Admin)', () => {
    > 575 |     it('should get coupon statistics', async () => {
          |     ^
      576 |       mockCouponController.getCouponStats = jest.fn((
      577 |         _req: Request,
      578 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:575:5
      at src/__tests__/integration/routes/coupon.test.ts:574:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/analytics/data (Admin) ‚Ä∫ should get coupon analytics data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      599 |
      600 |   describe('GET /api/coupons/analytics/data (Admin)', () => {
    > 601 |     it('should get coupon analytics data', async () => {
          |     ^
      602 |       mockCouponController.getCouponAnalytics = jest.fn((
      603 |         _req: Request,
      604 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:601:5
      at src/__tests__/integration/routes/coupon.test.ts:600:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId/redemptions (Admin) ‚Ä∫ should get coupon redemption history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      625 |
      626 |   describe('GET /api/coupons/:couponId/redemptions (Admin)', () => {
    > 627 |     it('should get coupon redemption history', async () => {
          |     ^
      628 |       mockCouponController.getCouponRedemptions = jest.fn((
      629 |         _req: Request,
      630 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:627:5
      at src/__tests__/integration/routes/coupon.test.ts:626:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ‚óè Coupon Routes Integration Tests ‚Ä∫ GET /api/coupons/:couponId/assignments (Admin) ‚Ä∫ should get coupon assignment history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      652 |
      653 |   describe('GET /api/coupons/:couponId/assignments (Admin)', () => {
    > 654 |     it('should get coupon assignment history', async () => {
          |     ^
      655 |       mockCouponController.getCouponAssignments = jest.fn((
      656 |         _req: Request,
      657 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:654:5
      at src/__tests__/integration/routes/coupon.test.ts:653:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

FAIL src/__tests__/integration/routes/survey.test.ts (295.723 s)
  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys (Admin) ‚Ä∫ should create survey with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('POST /api/surveys (Admin)', () => {
    > 54 |     it('should create survey with valid data', async () => {
         |     ^
      55 |       mockSurveyController.createSurvey = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:54:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys (Admin) ‚Ä∫ should create survey with target segment

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |     });
      123 |
    > 124 |     it('should create survey with target segment', async () => {
          |     ^
      125 |       mockSurveyController.createSurvey = jest.fn((
      126 |         _req: Request,
      127 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:124:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys ‚Ä∫ should get all surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      165 |
      166 |   describe('GET /api/surveys', () => {
    > 167 |     it('should get all surveys', async () => {
          |     ^
      168 |       mockSurveyController.getSurveys = jest.fn((
      169 |         _req: Request,
      170 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:167:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys ‚Ä∫ should support pagination

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      186 |     });
      187 |
    > 188 |     it('should support pagination', async () => {
          |     ^
      189 |       mockSurveyController.getSurveys = jest.fn((
      190 |         _req: Request,
      191 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:188:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:id ‚Ä∫ should get specific survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      207 |
      208 |   describe('GET /api/surveys/:id', () => {
    > 209 |     it('should get specific survey', async () => {
          |     ^
      210 |       mockSurveyController.getSurvey = jest.fn((
      211 |         _req: Request,
      212 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:209:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:id ‚Ä∫ should handle survey not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |     });
      231 |
    > 232 |     it('should handle survey not found', async () => {
          |     ^
      233 |       mockSurveyController.getSurvey = jest.fn((
      234 |         _req: Request,
      235 |         _res: Response,

      at src/__tests__/integration/routes/survey.test.ts:232:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ PUT /api/surveys/:id (Admin) ‚Ä∫ should update survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      247 |
      248 |   describe('PUT /api/surveys/:id (Admin)', () => {
    > 249 |     it('should update survey', async () => {
          |     ^
      250 |       mockSurveyController.updateSurvey = jest.fn((
      251 |         _req: Request,
      252 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:249:5
      at src/__tests__/integration/routes/survey.test.ts:248:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ DELETE /api/surveys/:id (Admin) ‚Ä∫ should delete survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |
      287 |   describe('DELETE /api/surveys/:id (Admin)', () => {
    > 288 |     it('should delete survey', async () => {
          |     ^
      289 |       mockSurveyController.deleteSurvey = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:288:5
      at src/__tests__/integration/routes/survey.test.ts:287:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/responses ‚Ä∫ should submit survey response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      306 |
      307 |   describe('POST /api/surveys/responses', () => {
    > 308 |     it('should submit survey response', async () => {
          |     ^
      309 |       mockSurveyController.submitResponse = jest.fn((
      310 |         _req: Request,
      311 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:308:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/responses ‚Ä∫ should handle partial response submission

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      352 |     });
      353 |
    > 354 |     it('should handle partial response submission', async () => {
          |     ^
      355 |       mockSurveyController.submitResponse = jest.fn((
      356 |         _req: Request,
      357 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:354:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/responses/:surveyId/user ‚Ä∫ should get user response for survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      380 |
      381 |   describe('GET /api/surveys/responses/:surveyId/user', () => {
    > 382 |     it('should get user response for survey', async () => {
          |     ^
      383 |       mockSurveyController.getUserResponse = jest.fn((
      384 |         _req: Request,
      385 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:382:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/responses/:surveyId/user ‚Ä∫ should return null for survey with no user response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      403 |     });
      404 |
    > 405 |     it('should return null for survey with no user response', async () => {
          |     ^
      406 |       mockSurveyController.getUserResponse = jest.fn((
      407 |         _req: Request,
      408 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:405:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/responses (Admin) ‚Ä∫ should get all survey responses

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      420 |
      421 |   describe('GET /api/surveys/:surveyId/responses (Admin)', () => {
    > 422 |     it('should get all survey responses', async () => {
          |     ^
      423 |       mockSurveyController.getSurveyResponses = jest.fn((
      424 |         _req: Request,
      425 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:422:5
      at src/__tests__/integration/routes/survey.test.ts:421:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/available/user ‚Ä∫ should get available surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      443 |
      444 |   describe('GET /api/surveys/available/user', () => {
    > 445 |     it('should get available surveys for user', async () => {
          |     ^
      446 |       mockSurveyController.getAvailableSurveys = jest.fn((
      447 |         _req: Request,
      448 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:445:5
      at src/__tests__/integration/routes/survey.test.ts:444:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/public/user ‚Ä∫ should get public surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      466 |
      467 |   describe('GET /api/surveys/public/user', () => {
    > 468 |     it('should get public surveys', async () => {
          |     ^
      469 |       mockSurveyController.getPublicSurveys = jest.fn((
      470 |         _req: Request,
      471 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:468:5
      at src/__tests__/integration/routes/survey.test.ts:467:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/invited/user ‚Ä∫ should get invited surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      488 |
      489 |   describe('GET /api/surveys/invited/user', () => {
    > 490 |     it('should get invited surveys for user', async () => {
          |     ^
      491 |       mockSurveyController.getInvitedSurveys = jest.fn((
      492 |         _req: Request,
      493 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:490:5
      at src/__tests__/integration/routes/survey.test.ts:489:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/analytics (Admin) ‚Ä∫ should get survey analytics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      510 |
      511 |   describe('GET /api/surveys/:surveyId/analytics (Admin)', () => {
    > 512 |     it('should get survey analytics', async () => {
          |     ^
      513 |       mockSurveyController.getSurveyAnalytics = jest.fn((
      514 |         _req: Request,
      515 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:512:5
      at src/__tests__/integration/routes/survey.test.ts:511:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/export (Admin) ‚Ä∫ should export survey responses

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      536 |
      537 |   describe('GET /api/surveys/:surveyId/export (Admin)', () => {
    > 538 |     it('should export survey responses', async () => {
          |     ^
      539 |       mockSurveyController.exportSurveyResponses = jest.fn((
      540 |         _req: Request,
      541 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:538:5
      at src/__tests__/integration/routes/survey.test.ts:537:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/:surveyId/invitations/send (Admin) ‚Ä∫ should send survey invitations

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      554 |
      555 |   describe('POST /api/surveys/:surveyId/invitations/send (Admin)', () => {
    > 556 |     it('should send survey invitations', async () => {
          |     ^
      557 |       mockSurveyController.sendSurveyInvitations = jest.fn((
      558 |         _req: Request,
      559 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:556:5
      at src/__tests__/integration/routes/survey.test.ts:555:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ POST /api/surveys/coupon-assignments (Admin) ‚Ä∫ should assign coupon to survey

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      578 |
      579 |   describe('POST /api/surveys/coupon-assignments (Admin)', () => {
    > 580 |     it('should assign coupon to survey', async () => {
          |     ^
      581 |       mockSurveyController.assignCouponToSurvey = jest.fn((
      582 |         _req: Request,
      583 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:580:5
      at src/__tests__/integration/routes/survey.test.ts:579:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/coupon-assignments (Admin) ‚Ä∫ should get survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      620 |
      621 |   describe('GET /api/surveys/:surveyId/coupon-assignments (Admin)', () => {
    > 622 |     it('should get survey coupon assignments', async () => {
          |     ^
      623 |       mockSurveyController.getSurveyCouponAssignments = jest.fn((
      624 |         _req: Request,
      625 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:622:5
      at src/__tests__/integration/routes/survey.test.ts:621:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/:surveyId/reward-history (Admin) ‚Ä∫ should get survey reward history

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      647 |
      648 |   describe('GET /api/surveys/:surveyId/reward-history (Admin)', () => {
    > 649 |     it('should get survey reward history', async () => {
          |     ^
      650 |       mockSurveyController.getSurveyRewardHistory = jest.fn((
      651 |         _req: Request,
      652 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:649:5
      at src/__tests__/integration/routes/survey.test.ts:648:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ‚óè Survey Routes Integration Tests ‚Ä∫ GET /api/surveys/admin/coupon-assignments (Admin) ‚Ä∫ should get all survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      678 |
      679 |   describe('GET /api/surveys/admin/coupon-assignments (Admin)', () => {
    > 680 |     it('should get all survey coupon assignments', async () => {
          |     ^
      681 |       mockSurveyController.getAllSurveyCouponAssignments = jest.fn((
      682 |         _req: Request,
      683 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:680:5
      at src/__tests__/integration/routes/survey.test.ts:679:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)


Test Suites: 15 failed, 13 passed, 28 total
Tests:       63 failed, 358 passed, 421 total
Snapshots:   0 total
Time:        296.87 s, estimated 297 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
