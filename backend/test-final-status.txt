
> loyalty-backend@4.0.1 test
> jest

PASS src/__tests__/unit/middleware/auth.test.ts
  Auth Middleware
    authenticate
      ✓ should authenticate valid Bearer token (7 ms)
      ✓ should reject request without authorization header (1 ms)
      ✓ should reject request with malformed authorization header (1 ms)
      ✓ should handle invalid token (5 ms)
      ✓ should handle expired token (1 ms)
      ✓ should handle token verification service errors (1 ms)
      ✓ should trim Bearer prefix correctly (1 ms)
    authorize
      ✓ should allow access for user with correct role (1 ms)
      ✓ should deny access for user with insufficient role (1 ms)
      ✓ should deny access for unauthenticated user (1 ms)
      ✓ should allow super_admin access to admin routes
      ✓ should handle single role authorization (1 ms)
      ✓ should handle multiple allowed roles
    requireRole
      ✓ should allow access for user with required role
      ✓ should deny access for user without required role
      ✓ should deny access for unauthenticated user (1 ms)
      ✓ should work with single role in array
      ✓ should handle role hierarchy correctly (1 ms)
    middleware integration
      ✓ should chain authenticate and authorize correctly (2 ms)
      ✓ should prevent unauthorized access after failed authentication (2 ms)
    error handling
      ✓ should pass errors to next middleware (1 ms)
      ✓ should handle undefined user gracefully in authorize (1 ms)
      ✓ should handle undefined user gracefully in requireRole (1 ms)

PASS src/__tests__/unit/services/membershipIdService.test.ts
  MembershipIdService
    generateUniqueMembershipId
      ✓ should generate an 8-digit membership ID starting with 269 (3 ms)
      ✓ should generate sequential IDs within block boundaries (1 ms)
      ✓ should handle block boundaries correctly (1 ms)
      ✓ should retry with fallback block if primary block is full
      ✓ should throw error when all fallback blocks are exhausted (23 ms)
      ✓ should handle database errors gracefully (5 ms)
    getUserByMembershipId
      ✓ should return user data for valid membership ID (1 ms)
      ✓ should throw error for non-existent membership ID (1 ms)
      ✓ should validate membership ID format (4 ms)
    getMembershipIdByUserId
      ✓ should return membership ID for valid user ID (1 ms)
      ✓ should return null for user with null membership ID (1 ms)
      ✓ should handle empty result for non-existent user (1 ms)
    regenerateMembershipId
      ✓ should generate new membership ID for existing user
      ✓ should throw error for non-existent user (1 ms)
      ✓ should handle database errors during regeneration (2 ms)
    getMembershipIdStats
      ✓ should return comprehensive membership ID statistics
      ✓ should handle zero users correctly
      ✓ should handle missing sequence information (1 ms)
      ✓ should calculate block boundaries correctly for different user counts (1 ms)
    Error Handling
      ✓ should handle malformed database responses (1 ms)
      ✓ should handle database connection errors (1 ms)
      ✓ should handle SQL syntax errors (1 ms)

PASS src/__tests__/unit/services/analyticsService.test.ts
  AnalyticsService
    Coupon Usage Tracking
      ✓ should track coupon view event (2 ms)
      ✓ should track coupon assignment event
      ✓ should track coupon redemption attempt (1 ms)
      ✓ should track successful redemption
      ✓ should track failed redemption (1 ms)
      ✓ should track coupon expiration
      ✓ should track coupon revocation (1 ms)
      ✓ should store event metadata (1 ms)
      ✓ should handle database errors gracefully
    Profile Change Tracking
      ✓ should track single profile change (1 ms)
      ✓ should track email change (1 ms)
      ✓ should track phone number change
      ✓ should track date of birth change (1 ms)
      ✓ should track gender change
      ✓ should track avatar URL change (1 ms)
      ✓ should track multiple profile changes (1 ms)
      ✓ should handle profile change with metadata
      ✓ should handle empty changes array (1 ms)
    Event Querying
      ✓ should query events by user
      ✓ should query events by coupon
      ✓ should query events by type
    Error Handling
      ✓ should handle invalid user ID
      ✓ should handle invalid coupon ID (1 ms)
      ✓ should handle database connection errors
    Performance
      ✓ should handle bulk event tracking (1 ms)
      ✓ should handle concurrent tracking requests

PASS src/__tests__/unit/services/authService.test.ts (5.477 s)
  AuthService
    Password Security
      ✓ should hash passwords securely (83 ms)
      ✓ should verify passwords correctly (192 ms)
      ✓ should not store plain text passwords (3 ms)
    JWT Token Management
      ✓ should generate valid JWT tokens (6 ms)
      ✓ should verify JWT tokens correctly (3 ms)
      ✓ should reject invalid JWT tokens (14 ms)
      ✓ should reject expired JWT tokens (3 ms)
      ✓ should handle different JWT secrets (1 ms)
    User Role Management
      ✓ should handle customer role
      ✓ should support different user roles (1 ms)
    User Data Validation
      ✓ should require valid email format (2 ms)
      ✓ should enforce email uniqueness
      ✓ should validate required user fields
    Security Features
      ✓ should handle password reset token generation
      ✓ should generate secure membership IDs (1 ms)
      ✓ should handle session management data (1 ms)
    User Profile Management
      ✓ should maintain complete user profile data
      ✓ should handle optional profile fields
      ✓ should support user metadata (1 ms)
    Error Handling
      ✓ should handle database constraint violations gracefully
      ✓ should validate data types
      ✓ should handle missing required relationships (1 ms)
    Performance and Scalability
      ✓ should efficiently query user data
      ✓ should handle batch user operations

FAIL src/__tests__/unit/middleware/security.test.ts (5.553 s)
  Security Middleware
    Rate Limiter Creation
      ✕ should create basic rate limiter (4 ms)
      ✕ should create API rate limiter (1 ms)
      ✕ should create user-specific rate limiter (1 ms)
      ✓ should create authentication rate limiter (4 ms)
    Security Headers
      ✓ should apply security headers middleware (1 ms)
      ✕ should set custom security headers (1 ms)
      ✕ should set HSTS header with correct max-age (1 ms)
    Input Sanitization
      ✓ should sanitize request body (1 ms)
      ✓ should sanitize query parameters
      ✓ should sanitize URL parameters (2 ms)
      ✓ should handle empty request objects (1 ms)
      ✓ should handle nested objects in body (1 ms)
    File Upload Security
      ✕ should validate file upload requests (1 ms)
      ✕ should handle requests without files (1 ms)
      ✕ should validate file types (1 ms)
      ✕ should handle multiple file uploads (1 ms)
    Security Monitoring
      ✓ should monitor requests (1 ms)
      ✓ should track request metadata
      ✓ should handle requests without IP
      ✓ should monitor different HTTP methods (1 ms)
    Production Security
      ✕ should apply production security (1 ms)
      ✕ should work in development mode (1 ms)
      ✕ should handle missing NODE_ENV
    XSS Protection
      ✓ should sanitize script tags (1 ms)
      ✓ should sanitize event handlers (1 ms)
      ✓ should sanitize javascript: URLs (1 ms)
      ✓ should preserve safe HTML (1 ms)
    SQL Injection Protection
      ✓ should handle SQL-like inputs in query (1 ms)
      ✓ should handle SQL-like inputs in body (1 ms)
      ✓ should handle UNION attacks (1 ms)
    CSRF Protection Headers
      ✕ should set CSRF protection headers (4 ms)
      ✕ should prevent clickjacking
      ✕ should prevent MIME sniffing
    Error Scenarios
      ✕ should handle sanitization errors gracefully (14 ms)
      ✓ should handle malformed headers (1 ms)
      ✕ should continue on setHeader errors

  ● Security Middleware › Rate Limiter Creation › should create basic rate limiter

    TypeError: Cannot read properties of undefined (reading 'rateLimitWindowMs')

      13 | export const createRateLimiter = () => {
      14 |   return rateLimit({
    > 15 |     windowMs: securityConfig.rateLimitWindowMs, // 15 minutes
         |                              ^
      16 |     max: securityConfig.rateLimitMaxRequests, // limit each IP to 100 requests per windowMs
      17 |     message: {
      18 |       error: 'Too many requests',

      at createRateLimiter (src/middleware/security.ts:15:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:83:44)

  ● Security Middleware › Rate Limiter Creation › should create API rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      54 |   };
      55 |   
    > 56 |   const limits = isProduction() ? productionLimits : developmentLimits;
         |                              ^
      57 |   
      58 |   return rateLimit({
      59 |     windowMs: limits.windowMs,

      at createApiRateLimiter (src/middleware/security.ts:56:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:89:46)

  ● Security Middleware › Rate Limiter Creation › should create user-specific rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      111 |   };
      112 |   
    > 113 |   const limits = isProduction() ? productionLimits : developmentLimits;
          |                              ^
      114 |   
      115 |   return rateLimit({
      116 |     windowMs: limits.windowMs,

      at createUserRateLimiter (src/middleware/security.ts:113:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:95:48)

  ● Security Middleware › Security Headers › should set custom security headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:114:28)

  ● Security Middleware › Security Headers › should set HSTS header with correct max-age

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:124:28)

  ● Security Middleware › File Upload Security › should validate file upload requests

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:199:25)

  ● Security Middleware › File Upload Security › should handle requests without files

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:206:25)

  ● Security Middleware › File Upload Security › should validate file types

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:220:25)

  ● Security Middleware › File Upload Security › should handle multiple file uploads

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:243:25)

  ● Security Middleware › Production Security › should apply production security

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:290:25)

  ● Security Middleware › Production Security › should work in development mode

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:296:25)

  ● Security Middleware › Production Security › should handle missing NODE_ENV

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:302:25)

  ● Security Middleware › CSRF Protection Headers › should set CSRF protection headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:357:28)

  ● Security Middleware › CSRF Protection Headers › should prevent clickjacking

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:362:28)

  ● Security Middleware › CSRF Protection Headers › should prevent MIME sniffing

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:367:28)

  ● Security Middleware › Error Scenarios › should handle sanitization errors gracefully

    RangeError: Maximum call stack size exceeded

      258 |         .trim();
      259 |     }
    > 260 |     if (Array.isArray(value)) {
          |     ^
      261 |       return value.map(sanitizeValue);
      262 |     }
      263 |     if (value && typeof value === 'object' && value !== null) {

      at sanitizeValue (src/middleware/security.ts:260:5)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)

  ● Security Middleware › Error Scenarios › should continue on setHeader errors

    Header error

      394 |     test('should continue on setHeader errors', () => {
      395 |       (mockRes.setHeader as jest.Mock).mockImplementation(() => {
    > 396 |         throw new Error('Header error');
          |               ^
      397 |       });
      398 |
      399 |       // The middleware should continue even if setHeader throws

      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:396:15)
      at customSecurityHeaders (src/middleware/security.ts:227:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:400:28)

PASS src/__tests__/unit/services/surveyService.test.ts
  SurveyService
    Survey Basic Operations
      ✓ should be properly instantiated (4 ms)
      ✓ should have required methods
    getSurveyById
      ✓ should return survey data for valid ID (1 ms)
      ✓ should return null for non-existent survey
    getSurveyAnalytics
      ✓ should return analytics for valid survey (1 ms)
      ✓ should return null for non-existent survey analytics (1 ms)
    Error Handling
      ✓ should handle database connection errors (10 ms)
      ✓ should handle SQL errors (1 ms)
    Survey Response Handling
      ✓ should handle survey submission responses (1 ms)
    Survey Coupon Assignment
      ✓ should handle coupon assignment structure
    Survey Question Types
      ✓ should support all question types (1 ms)

FAIL src/__tests__/unit/services/translationService.test.ts (5.616 s)
  TranslationService
    Azure Translation Provider
      ✕ should translate text using Azure (5 ms)
      ✕ should translate multiple texts (1 ms)
      ✓ should handle Azure translation errors (4 ms)
      ✕ should include Azure headers
    Google Translation Provider
      ✕ should translate text using Google (1 ms)
      ✓ should handle Google translation errors (2 ms)
    LibreTranslate Provider
      ✕ should translate text using LibreTranslate (1 ms)
      ✓ should handle LibreTranslate errors (1 ms)
    Translation Job Tracking
      ✕ should create translation job for survey (1 ms)
      ✕ should track translation job status (1 ms)
      ✓ should handle failed translation job (1 ms)
    Language Support
      ✕ should support Thai translation
      ✕ should support Chinese translation (1 ms)
      ✕ should support multiple target languages
    Edge Cases
      ✓ should handle empty text array (1 ms)
      ✕ should handle very long texts (1 ms)
      ✕ should handle special characters
      ✕ should handle same source and target language (1 ms)
    Provider Fallback
      ✓ should handle missing provider configuration (1 ms)
      ✓ should handle invalid provider (2 ms)
    Performance
      ✕ should handle batch translation efficiently (1 ms)
      ✕ should handle concurrent translation requests (1 ms)
    Error Recovery
      ✕ should handle network timeout (17 ms)
      ✓ should handle rate limiting (1 ms)
      ✓ should handle authentication errors (1 ms)
    Character Counting
      ✕ should count characters correctly (1 ms)
      ✕ should aggregate character counts for multiple texts (1 ms)

  ● TranslationService › Azure Translation Provider › should translate text using Azure

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:46:47)

  ● TranslationService › Azure Translation Provider › should translate multiple texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:64:47)

  ● TranslationService › Azure Translation Provider › should include Azure headers

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:92:32)

  ● TranslationService › Google Translation Provider › should translate text using Google

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:118:47)

  ● TranslationService › LibreTranslate Provider › should translate text using LibreTranslate

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:153:47)

  ● TranslationService › Translation Job Tracking › should create translation job for survey

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:199:32)

  ● TranslationService › Translation Job Tracking › should track translation job status

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:222:32)

  ● TranslationService › Language Support › should support Thai translation

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:263:47)

  ● TranslationService › Language Support › should support Chinese translation

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:279:47)

  ● TranslationService › Language Support › should support multiple target languages

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:301:47)

  ● TranslationService › Edge Cases › should handle very long texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:336:47)

  ● TranslationService › Edge Cases › should handle special characters

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:352:47)

  ● TranslationService › Edge Cases › should handle same source and target language

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:368:47)

  ● TranslationService › Performance › should handle batch translation efficiently

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:418:47)

  ● TranslationService › Performance › should handle concurrent translation requests

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at src/__tests__/unit/services/translationService.test.ts:435:28
          at Array.from (<anonymous>)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:434:30)

  ● TranslationService › Error Recovery › should handle network timeout

    expect(received).rejects.toThrow(expected)

    Expected substring: "ETIMEDOUT"
    Received message:   "Azure Translator API key not configured"

          90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
          91 |     if (!this.azureConfig.apiKey) {
        > 92 |       throw new Error('Azure Translator API key not configured');
             |             ^
          93 |     }
          94 |
          95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:460:28)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:465:17)

  ● TranslationService › Character Counting › should count characters correctly

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:509:47)

  ● TranslationService › Character Counting › should aggregate character counts for multiple texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:526:47)

PASS src/__tests__/unit/middleware/requestLogger.test.ts
  RequestLogger Middleware
    Basic Logging
      ✓ should call next middleware (2 ms)
      ✓ should register finish event listener (1 ms)
      ✓ should log successful request (2 ms)
      ✓ should include request method in log (1 ms)
      ✓ should include request URL in log (1 ms)
    Status Code Handling
      ✓ should log info for 2xx status codes (1 ms)
      ✓ should log info for 3xx status codes (1 ms)
      ✓ should log warn for 4xx status codes (1 ms)
      ✓ should log warn for 5xx status codes (1 ms)
    Performance Tracking
      ✓ should track request duration (1 ms)
      ✓ should include duration in log data (1 ms)
      ✓ should handle very fast requests (1 ms)
      ✓ should handle slow requests (1 ms)
    Request Metadata
      ✓ should log IP address
      ✓ should log user agent (1 ms)
      ✓ should handle missing user agent
      ✓ should handle missing IP address (2 ms)
    Different HTTP Methods
      ✓ should log GET requests (1 ms)
      ✓ should log POST requests (1 ms)
      ✓ should log PUT requests (1 ms)
      ✓ should log DELETE requests (1 ms)
      ✓ should log PATCH requests (1 ms)
    Different Routes
      ✓ should log API routes (1 ms)
      ✓ should log health check routes (1 ms)
      ✓ should log routes with query parameters
      ✓ should log routes with URL parameters
    Error Scenarios
      ✓ should continue logging even if finish event fails
      ✓ should handle malformed requests

PASS src/__tests__/unit/middleware/errorHandler.test.ts
  ErrorHandler Middleware
    AppError class
      ✓ should create AppError with status code and message (4 ms)
      ✓ should set isOperational flag
      ✓ should maintain proper prototype chain (1 ms)
      ✓ should have error message accessible (1 ms)
    ZodError handling
      ✓ should handle ZodError with validation details (6 ms)
      ✓ should format ZodError details correctly (1 ms)
      ✓ should handle multiple validation errors (2 ms)
      ✓ should handle nested field validation errors (1 ms)
    AppError handling
      ✓ should handle 401 Unauthorized error
      ✓ should handle 403 Forbidden error (2 ms)
      ✓ should handle 404 Not Found error (1 ms)
      ✓ should handle 409 Conflict error (1 ms)
      ✓ should handle custom status codes
    unexpected error handling
      ✓ should log unexpected errors (13 ms)
      ✓ should include stack trace in logs (1 ms)
      ✓ should return 500 for unexpected errors (1 ms)
      ✓ should hide error details in production (1 ms)
      ✓ should expose error details in development (1 ms)
    error type precedence
      ✓ should handle ZodError before generic Error (31 ms)
      ✓ should handle AppError before generic Error
    edge cases
      ✓ should handle errors without message (2 ms)
      ✓ should handle errors without stack trace (1 ms)
      ✓ should handle null or undefined request properties (2 ms)
      ✓ should not call next function (terminal middleware) (1 ms)
    response consistency
      ✓ should always return JSON responses (3 ms)
      ✓ should include error field in all responses (2 ms)
      ✓ should return appropriate HTTP status codes (2 ms)

PASS src/__tests__/unit/middleware/validateRequest.test.ts
  validateRequest Middleware
    single schema validation (backward compatibility)
      ✓ should validate valid request body (9 ms)
      ✓ should reject invalid email format (3 ms)
      ✓ should reject password too short (2 ms)
      ✓ should reject missing required fields (1 ms)
      ✓ should allow optional fields (1 ms)
    multi-part validation (body, params, query)
      ✓ should validate request body (1 ms)
      ✓ should validate request params (1 ms)
      ✓ should validate request query (2 ms)
      ✓ should validate all parts simultaneously (1 ms)
      ✓ should reject invalid params (1 ms)
      ✓ should reject invalid query parameters (1 ms)
    complex validation scenarios
      ✓ should validate nested objects (1 ms)
      ✓ should validate arrays (3 ms)
      ✓ should reject arrays with invalid items (1 ms)
      ✓ should validate enums (1 ms)
      ✓ should reject invalid enum values (1 ms)
      ✓ should validate dates (2 ms)
      ✓ should validate numbers with constraints (1 ms)
    error logging
      ✓ should log validation errors with request details (2 ms)
      ✓ should include error details in log (1 ms)
      ✓ should log params and query in validation errors (1 ms)
    edge cases
      ✓ should handle empty body validation (1 ms)
      ✓ should reject extra fields in strict mode (1 ms)
      ✓ should allow extra fields in non-strict mode (1 ms)
      ✓ should handle undefined body gracefully (1 ms)
      ✓ should handle null values

PASS src/__tests__/unit/services/loyaltyService.test.ts
  LoyaltyService
    User Loyalty Initialization
      ✓ should create user with zero points initially (3 ms)
      ✓ should have valid user structure (1 ms)
    Points Management
      ✓ should award points correctly (1 ms)
      ✓ should handle negative points (deductions) (1 ms)
      ✓ should calculate total points correctly from transactions (1 ms)
    Transaction Types
      ✓ should support earned_stay transactions
      ✓ should support bonus transactions (1 ms)
      ✓ should support admin transactions
      ✓ should support redemption transactions (1 ms)
    Data Integrity
      ✓ should require valid user ID for transactions (15 ms)
      ✓ should require transaction type (6 ms)
      ✓ should validate points as number (2 ms)
    Edge Cases
      ✓ should handle zero points transaction (4 ms)
      ✓ should handle very large point values (1 ms)
      ✓ should handle transactions without description (2 ms)
    Query Performance
      ✓ should efficiently query user transactions (2 ms)
      ✓ should efficiently calculate user total points (2 ms)
    Business Logic Validation
      ✓ should support different transaction types with correct semantics (4 ms)
      ✓ should maintain transaction chronological order (31 ms)

PASS src/__tests__/integration/database/schema.test.ts
  Database Schema Integration
    User Table Constraints
      ✓ should enforce email uniqueness (31 ms)
      ✓ should enforce membership ID uniqueness (1 ms)
      ✓ should require valid email format in application layer (2 ms)
      ✓ should have proper timestamps (1 ms)
    Loyalty Transaction Relationships
      ✓ should enforce foreign key constraint to users
      ✓ should allow multiple transactions per user
      ✓ should maintain transaction integrity during user deletion (1 ms)
    Coupon Relationships
      ✓ should enforce foreign key constraint to users (2 ms)
      ✓ should enforce QR code uniqueness (1 ms)
      ✓ should support different coupon statuses
    Data Integrity Constraints
      ✓ should prevent negative loyalty points in business logic
      ✓ should handle concurrent user creation (1 ms)
      ✓ should handle transaction rollback on constraint violation (2 ms)
    Database Performance
      ✓ should efficiently query users by email
      ✓ should efficiently query loyalty transactions by user (1 ms)
      ✓ should efficiently aggregate loyalty points (1 ms)
    Schema Evolution
      ✓ should support adding new fields without breaking existing data (1 ms)
      ✓ should handle nullable fields appropriately

PASS src/__tests__/unit/services/storageService.test.ts (5.72 s)
  StorageService
    Storage Initialization
      ✓ should initialize storage service with backup scheduling (7 ms)
      ✓ should schedule backup for 2 AM next day (5 ms)
    Backup Operations
      ✓ should perform backup successfully (1 ms)
      ✓ should log backup duration (1 ms)
      ✓ should handle backup errors gracefully (20 ms)
      ✓ should continue operations after backup failure (2 ms)
    Storage Reports
      ✓ should generate storage report with all metrics (1 ms)
      ✓ should calculate usage percentage correctly
      ✓ should handle zero files scenario (1 ms)
      ✓ should handle maximum storage usage
      ✓ should return consistent data structure (1 ms)
      ✓ should handle getStorageStats errors (1 ms)
    Storage Metrics Validation
      ✓ should calculate average size correctly (2 ms)
      ✓ should handle large file counts (1 ms)
      ✓ should handle very small files (1 ms)
    Storage Limits
      ✓ should warn when approaching storage limit (2 ms)
      ✓ should detect storage overflow
    Backup Scheduling
      ✓ should schedule daily backups (2 ms)
      ✓ should calculate correct time until next backup
    Error Recovery
      ✓ should recover from temporary storage errors (1 ms)
      ✓ should handle concurrent report requests (1 ms)
    Performance
      ✓ should generate report quickly (7 ms)
      ✓ should handle rapid successive calls (6 ms)

2025-11-12 09:04:07 [[32minfo[39m]: Prisma client initialized
PASS src/__tests__/unit/services/userService.test.ts
  UserService
    getProfile
      ✓ should return user profile successfully (4 ms)
      ✓ should throw error if profile not found (24 ms)
    updateProfile
      ✓ should update profile fields successfully (2 ms)
      ✓ should handle partial profile updates (2 ms)
      ✓ should handle emoji avatar updates (1 ms)
    getAllUsers
      ✓ should return paginated users list (2 ms)
      ✓ should apply search filter (1 ms)
    deleteUser
      ✓ should delete user successfully (1 ms)
      ✓ should not throw error if user not found (idempotent delete) (2 ms)
      ✓ should handle cascade deletion (2 ms)
    updateUserRole
      ✓ should update user role successfully (3 ms)
      ✓ should validate role enum (6 ms)
    updateUserStatus
      ✓ should activate inactive user (1 ms)
      ✓ should deactivate active user (1 ms)
    getUserStats
      ✓ should return user statistics (2 ms)
    completeProfile
      ✓ should mark profile as completed (1 ms)
      ✓ should handle profile updates with rewards (2 ms)
    error handling
      ✓ should handle database connection errors (2 ms)
      ✓ should handle invalid data format (2 ms)

FAIL src/__tests__/integration/routes/user.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/unit/services/notificationService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m49[0m:[93m67[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m49[0m       const result = await notificationService.createNotification(notificationData);
    [7m  [0m [91m                                                                  ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m85[0m:[93m67[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "coupon"; data: { couponId: string; code: string; }; expiresAt: Date; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'expiresAt' are incompatible.
        Type 'Date' is not assignable to type 'string'.

    [7m85[0m       const result = await notificationService.createNotification(notificationData);
    [7m  [0m [91m                                                                  ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m112[0m:[93m59[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m112[0m       await expect(notificationService.createNotification(notificationData))
    [7m   [0m [91m                                                          ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m114[0m:[93m59[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m114[0m       await expect(notificationService.createNotification(notificationData))
    [7m   [0m [91m                                                          ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m440[0m:[93m85[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ id: string; code: string; name: string; type: string; value: number; }' is not assignable to parameter of type 'Coupon'.
      Type '{ id: string; code: string; name: string; type: string; value: number; }' is missing the following properties from type 'Coupon': currency, validFrom, usageLimitPerUser, usedCount, and 5 more.

    [7m440[0m       const result = await notificationService.createCouponNotification('user-123', mockCoupon);
    [7m   [0m [91m                                                                                    ~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m500[0m:[93m72[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }[]' is not assignable to parameter of type 'CreateNotificationData[]'.
      Type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to type 'CreateNotificationData'.
        Types of property 'type' are incompatible.
          Type '"general"' is not assignable to type 'NotificationType'.

    [7m500[0m       const result = await notificationService.createBulkNotifications(notifications);
    [7m   [0m [91m                                                                       ~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m557[0m:[93m69[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general" | "reward" | "coupon"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general" | "reward" | "coupon"' is not assignable to type 'NotificationType'.
          Type '"general"' is not assignable to type 'NotificationType'.

    [7m557[0m         const result = await notificationService.createNotification(notificationData);
    [7m   [0m [91m                                                                    ~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/unit/services/oauthService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/oauthService.test.ts[0m:[93m487[0m:[93m76[0m - [91merror[0m[90m TS2345: [0mArgument of type '(email: string) => string | null' is not assignable to parameter of type 'UnknownFunction'.
      Types of parameters 'email' and 'args' are incompatible.
        Type 'unknown' is not assignable to type 'string'.

    [7m487[0m       (adminConfigService.getRequiredRole as jest.Mock).mockImplementation((email: string): string | null => {
    [7m   [0m [91m                                                                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/unit/services/couponService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m63[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m63[0m       // @ts-expect-error Mock typing
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m111[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m111[0m       // @ts-expect-error Mock typing
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m113[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m113[0m         .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m140[0m:[93m34[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m140[0m           .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m141[0m:[93m34[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; code: string; type: "percentage" | "fixed_amount" | "bogo"; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m141[0m           .mockResolvedValueOnce({
    [7m   [0m [91m                                 ~[0m
    [7m142[0m             rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m148[0m             command: 'INSERT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m149[0m           })
    [7m   [0m [91m~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m300[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m300[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-1' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m302[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m302[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m303[0m           rows: [{ id: 'uc-1', userId: 'user-1', couponId: 'coupon-123', qrCode: 'QR1', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m304[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m305[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m307[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m307[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-2' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m309[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m309[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m310[0m           rows: [{ id: 'uc-2', userId: 'user-2', couponId: 'coupon-123', qrCode: 'QR2', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m311[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m312[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m314[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m314[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-3' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m316[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m316[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m317[0m           rows: [{ id: 'uc-3', userId: 'user-3', couponId: 'coupon-123', qrCode: 'QR3', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m318[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m319[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m326[0m:[93m14[0m - [91merror[0m[90m TS2532: [0mObject is possibly 'undefined'.

    [7m326[0m       expect(result[0].couponId).toBe('coupon-123');
    [7m   [0m [91m             ~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m340[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type 'AppError' is not assignable to parameter of type 'never'.

    [7m340[0m         .mockRejectedValueOnce(new AppError(404, 'Coupon not found'))
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m360[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type 'AppError' is not assignable to parameter of type 'never'.

    [7m360[0m         .mockRejectedValueOnce(new AppError(400, 'Coupon is not active'))
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m384[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: number; finalAmount: number; userCouponId: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m384[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m385[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m392[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m393[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m436[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m436[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m437[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m444[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m445[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m465[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: number; finalAmount: number; userCouponId: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m465[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m466[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m473[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m474[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m650[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m650[0m       // @ts-expect-error Mock typing
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m652[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m652[0m         .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m674[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m674[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m675[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m682[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m683[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m704[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m704[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m705[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m712[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m713[0m         })
    [7m   [0m [91m~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/translation.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m29[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m29[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m464[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m464[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/notifications.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m282[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m282[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/membership.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m15[0m - [91merror[0m[90m TS6133: [0m'roles' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m              ~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m45[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                            ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m67[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                                  ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m340[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m340[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/oauth.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m51[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m51[0m       req.session = {
    [7m  [0m [91m      ~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m331[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m331[0m         req.session = {
    [7m   [0m [91m        ~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/storage.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m35[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m39[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m39[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m128[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m128[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m149[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m149[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m345[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m345[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m365[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m365[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/loyalty.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/auth.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/analyticsRoutes.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m27[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m31[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m31[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m37[0m:[93m7[0m - [91merror[0m[90m TS6133: [0m'mockAuthorizeMiddleware' is declared but its value is never read.

    [7m37[0m const mockAuthorizeMiddleware = (...allowedRoles: string[]) => {
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m19[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                  ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m41[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                        ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m327[0m:[93m15[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m327[0m       app.use((req, res, next) => {
    [7m   [0m [91m              ~~~~~~~~~~~~~~~~~~~~~[0m

2025-11-12 09:04:17 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"received":"invalid_type","code":"invalid_enum_value","options":["multiple_choice","single_choice","text","textarea","rating_5","rating_10","yes_no"],"path":["questions",0,"type"],"message":"Invalid enum value. Expected 'multiple_choice' | 'single_choice' | 'text' | 'textarea' | 'rating_5' | 'rating_10' | 'yes_no', received 'invalid_type'"}],"requestBody":{"title":"Invalid Survey","questions":[{"id":"q1","type":"invalid_type","text":"Question","required":true,"order":1}],"access_type":"public"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:04:17 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"code":"too_small","minimum":1,"type":"array","inclusive":true,"exact":false,"message":"Array must contain at least 1 element(s)","path":["questions"]}],"requestBody":{"title":"Empty Survey","questions":[],"access_type":"public"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:05:07 [[31merror[39m]: Validation Error Details: {"url":"/redeem","method":"POST","errors":[{"code":"invalid_type","expected":"number","received":"undefined","path":["originalAmount"],"message":"Required"}],"requestBody":{"qrCode":"QR-CODE-123"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:05:07 [[31merror[39m]: Validation Error Details: {"url":"/redeem","method":"POST","errors":[{"code":"too_small","minimum":0.01,"type":"number","inclusive":true,"exact":false,"message":"Number must be greater than or equal to 0.01","path":["originalAmount"]}],"requestBody":{"qrCode":"QR-CODE-123","originalAmount":0},"requestParams":{},"requestQuery":{}}
2025-11-12 09:05:17 [[31merror[39m]: Validation Error Details: {"url":"/survey-123","method":"PUT","errors":[{"received":"invalid_status","code":"invalid_enum_value","options":["draft","active","paused","completed","archived"],"path":["status"],"message":"Invalid enum value. Expected 'draft' | 'active' | 'paused' | 'completed' | 'archived', received 'invalid_status'"}],"requestBody":{"status":"invalid_status"},"requestParams":{"id":"survey-123"},"requestQuery":{}}
2025-11-12 09:05:37 [[31merror[39m]: Validation Error Details: {"url":"/responses","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["survey_id"]}],"requestBody":{"survey_id":"not-a-uuid","answers":{"q1":"answer"}},"requestParams":{},"requestQuery":{}}
2025-11-12 09:06:07 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"validation":"regex","code":"invalid_string","message":"Code must contain only uppercase letters, numbers, underscores, and hyphens","path":["code"]}],"requestBody":{"code":"invalid code","name":"Invalid Coupon","type":"percentage","value":10},"requestParams":{},"requestQuery":{}}
2025-11-12 09:06:07 [[31merror[39m]: Validation Error Details: {"url":"/","method":"POST","errors":[{"code":"invalid_type","expected":"string","received":"undefined","path":["name"],"message":"Required"},{"expected":"'percentage' | 'fixed_amount' | 'bogo' | 'free_upgrade' | 'free_service'","received":"undefined","code":"invalid_type","path":["type"],"message":"Required"}],"requestBody":{"code":"INCOMPLETE"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:06:17 [[31merror[39m]: Validation Error Details: {"url":"/coupon-123","method":"PUT","errors":[{"validation":"regex","code":"invalid_string","message":"Invalid","path":["code"]}],"requestBody":{"code":"invalid code"},"requestParams":{"couponId":"coupon-123"},"requestQuery":{}}
2025-11-12 09:06:37 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["couponId"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",1]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",2]}],"requestBody":{"couponId":"coupon-uuid","userIds":["user-1","user-2","user-3"],"assignedReason":"Loyalty reward"},"requestParams":{},"requestQuery":{}}
2025-11-12 09:06:37 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["couponId"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]}],"requestBody":{"couponId":"not-a-uuid","userIds":["user-1"]},"requestParams":{},"requestQuery":{}}
2025-11-12 09:06:37 [[31merror[39m]: Validation Error Details: {"url":"/assign","method":"POST","errors":[{"code":"too_big","maximum":100,"type":"array","inclusive":true,"exact":false,"message":"Array must contain at most 100 element(s)","path":["userIds"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",0]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",1]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",2]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",3]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",4]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",5]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",6]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",7]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",8]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",9]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",10]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",11]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",12]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",13]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",14]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",15]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",16]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",17]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",18]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",19]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",20]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",21]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",22]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",23]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",24]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",25]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",26]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",27]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",28]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",29]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",30]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",31]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",32]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",33]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",34]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",35]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",36]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",37]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",38]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",39]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",40]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",41]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",42]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",43]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",44]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",45]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",46]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",47]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",48]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",49]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",50]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",51]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",52]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",53]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",54]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",55]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",56]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",57]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",58]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",59]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",60]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",61]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",62]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",63]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",64]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",65]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",66]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",67]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",68]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",69]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",70]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",71]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",72]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",73]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",74]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",75]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",76]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",77]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",78]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",79]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",80]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",81]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",82]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",83]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",84]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",85]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",86]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",87]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",88]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",89]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",90]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",91]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",92]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",93]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",94]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",95]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",96]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",97]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",98]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",99]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["userIds",100]}],"requestBody":{"couponId":"550e8400-e29b-41d4-a716-446655440000","userIds":["user-0","user-1","user-2","user-3","user-4","user-5","user-6","user-7","user-8","user-9","user-10","user-11","user-12","user-13","user-14","user-15","user-16","user-17","user-18","user-19","user-20","user-21","user-22","user-23","user-24","user-25","user-26","user-27","user-28","user-29","user-30","user-31","user-32","user-33","user-34","user-35","user-36","user-37","user-38","user-39","user-40","user-41","user-42","user-43","user-44","user-45","user-46","user-47","user-48","user-49","user-50","user-51","user-52","user-53","user-54","user-55","user-56","user-57","user-58","user-59","user-60","user-61","user-62","user-63","user-64","user-65","user-66","user-67","user-68","user-69","user-70","user-71","user-72","user-73","user-74","user-75","user-76","user-77","user-78","user-79","user-80","user-81","user-82","user-83","user-84","user-85","user-86","user-87","user-88","user-89","user-90","user-91","user-92","user-93","user-94","user-95","user-96","user-97","user-98","user-99","user-100"]},"requestParams":{},"requestQuery":{}}
FAIL src/__tests__/integration/routes/coupon.test.ts (215.4 s)
  Coupon Routes Integration Tests
    GET /api/coupons/validate/:qrCode
      ✕ should validate coupon by QR code (public route) (10005 ms)
      ✕ should return invalid for expired coupon (10001 ms)
      ✕ should return invalid for already used coupon (10006 ms)
    GET /api/coupons/my-coupons
      ✕ should get user coupons (10004 ms)
      ✕ should return empty array for user with no coupons (10000 ms)
    POST /api/coupons/redeem
      ✕ should redeem coupon with valid QR code (10004 ms)
      ✓ should reject redemption with missing required fields (14 ms)
      ✓ should reject redemption with invalid amount (5 ms)
      ✕ should handle redemption of percentage discount coupon (9999 ms)
    GET /api/coupons
      ✕ should list all active coupons (10000 ms)
      ✕ should support pagination for coupon list (10001 ms)
    GET /api/coupons/:couponId
      ✕ should get specific coupon details (10001 ms)
      ✕ should handle coupon not found (10001 ms)
    POST /api/coupons (Admin)
      ✕ should create coupon with valid data (10000 ms)
      ✓ should reject invalid coupon code format (9 ms)
      ✓ should reject missing required fields (4 ms)
    PUT /api/coupons/:couponId (Admin)
      ✕ should update coupon (10001 ms)
      ✓ should reject invalid update data (5 ms)
    DELETE /api/coupons/:couponId (Admin)
      ✕ should delete coupon (10001 ms)
      ✕ should handle deletion of non-existent coupon (10001 ms)
    POST /api/coupons/assign (Admin)
      ✕ should assign coupon to users (6 ms)
      ✓ should reject assignment with invalid coupon ID (4 ms)
      ✓ should reject assignment with too many users (7 ms)
    POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)
      ✕ should revoke user coupon (9999 ms)
      ✕ should revoke coupon without reason (10000 ms)
    GET /api/coupons/analytics/stats (Admin)
      ✕ should get coupon statistics (10001 ms)
    GET /api/coupons/analytics/data (Admin)
      ✕ should get coupon analytics data (10001 ms)
    GET /api/coupons/:couponId/redemptions (Admin)
      ✕ should get coupon redemption history (10000 ms)
    GET /api/coupons/:couponId/assignments (Admin)
      ✕ should get coupon assignment history (10000 ms)

  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should validate coupon by QR code (public route)

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('GET /api/coupons/validate/:qrCode', () => {
    > 54 |     it('should validate coupon by QR code (public route)', async () => {
         |     ^
      55 |       mockCouponController.validateCoupon = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:54:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should return invalid for expired coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      80 |     });
      81 |
    > 82 |     it('should return invalid for expired coupon', async () => {
         |     ^
      83 |       mockCouponController.validateCoupon = jest.fn((
      84 |         _req: Request,
      85 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:82:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should return invalid for already used coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      102 |     });
      103 |
    > 104 |     it('should return invalid for already used coupon', async () => {
          |     ^
      105 |       mockCouponController.validateCoupon = jest.fn((
      106 |         _req: Request,
      107 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:104:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/my-coupons › should get user coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      125 |
      126 |   describe('GET /api/coupons/my-coupons', () => {
    > 127 |     it('should get user coupons', async () => {
          |     ^
      128 |       mockCouponController.getUserCoupons = jest.fn((
      129 |         _req: Request,
      130 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:127:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/my-coupons › should return empty array for user with no coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      160 |     });
      161 |
    > 162 |     it('should return empty array for user with no coupons', async () => {
          |     ^
      163 |       mockCouponController.getUserCoupons = jest.fn((
      164 |         _req: Request,
      165 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:162:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/redeem › should redeem coupon with valid QR code

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      177 |
      178 |   describe('POST /api/coupons/redeem', () => {
    > 179 |     it('should redeem coupon with valid QR code', async () => {
          |     ^
      180 |       mockCouponController.redeemCoupon = jest.fn((
      181 |         _req: Request,
      182 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:179:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/redeem › should handle redemption of percentage discount coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      233 |     });
      234 |
    > 235 |     it('should handle redemption of percentage discount coupon', async () => {
          |     ^
      236 |       mockCouponController.redeemCoupon = jest.fn((
      237 |         _req: Request,
      238 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:235:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons › should list all active coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      265 |
      266 |   describe('GET /api/coupons', () => {
    > 267 |     it('should list all active coupons', async () => {
          |     ^
      268 |       mockCouponController.listCoupons = jest.fn((
      269 |         _req: Request,
      270 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:267:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons › should support pagination for coupon list

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should support pagination for coupon list', async () => {
          |     ^
      289 |       mockCouponController.listCoupons = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:288:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId › should get specific coupon details

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      307 |
      308 |   describe('GET /api/coupons/:couponId', () => {
    > 309 |     it('should get specific coupon details', async () => {
          |     ^
      310 |       mockCouponController.getCoupon = jest.fn((
      311 |         _req: Request,
      312 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:309:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId › should handle coupon not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      332 |     });
      333 |
    > 334 |     it('should handle coupon not found', async () => {
          |     ^
      335 |       mockCouponController.getCoupon = jest.fn((
      336 |         _req: Request,
      337 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:334:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons (Admin) › should create coupon with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      349 |
      350 |   describe('POST /api/coupons (Admin)', () => {
    > 351 |     it('should create coupon with valid data', async () => {
          |     ^
      352 |       mockCouponController.createCoupon = jest.fn((
      353 |         _req: Request,
      354 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:351:5
      at src/__tests__/integration/routes/coupon.test.ts:350:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › PUT /api/coupons/:couponId (Admin) › should update coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      408 |
      409 |   describe('PUT /api/coupons/:couponId (Admin)', () => {
    > 410 |     it('should update coupon', async () => {
          |     ^
      411 |       mockCouponController.updateCoupon = jest.fn((
      412 |         _req: Request,
      413 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:410:5
      at src/__tests__/integration/routes/coupon.test.ts:409:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › DELETE /api/coupons/:couponId (Admin) › should delete coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      447 |
      448 |   describe('DELETE /api/coupons/:couponId (Admin)', () => {
    > 449 |     it('should delete coupon', async () => {
          |     ^
      450 |       mockCouponController.deleteCoupon = jest.fn((
      451 |         _req: Request,
      452 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:449:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › DELETE /api/coupons/:couponId (Admin) › should handle deletion of non-existent coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      465 |     });
      466 |
    > 467 |     it('should handle deletion of non-existent coupon', async () => {
          |     ^
      468 |       mockCouponController.deleteCoupon = jest.fn((
      469 |         _req: Request,
      470 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:467:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/assign (Admin) › should assign coupon to users

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      505 |         });
      506 |
    > 507 |       expect(response.status).toBe(200);
          |                               ^
      508 |       expect(response.body.data.assigned).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:507:31)

  ● Coupon Routes Integration Tests › POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) › should revoke user coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      535 |
      536 |   describe('POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)', () => {
    > 537 |     it('should revoke user coupon', async () => {
          |     ^
      538 |       mockCouponController.revokeUserCoupon = jest.fn((
      539 |         _req: Request,
      540 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:537:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) › should revoke coupon without reason

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      556 |     });
      557 |
    > 558 |     it('should revoke coupon without reason', async () => {
          |     ^
      559 |       mockCouponController.revokeUserCoupon = jest.fn((
      560 |         _req: Request,
      561 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:558:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/analytics/stats (Admin) › should get coupon statistics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      573 |
      574 |   describe('GET /api/coupons/analytics/stats (Admin)', () => {
    > 575 |     it('should get coupon statistics', async () => {
          |     ^
      576 |       mockCouponController.getCouponStats = jest.fn((
      577 |         _req: Request,
      578 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:575:5
      at src/__tests__/integration/routes/coupon.test.ts:574:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/analytics/data (Admin) › should get coupon analytics data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      599 |
      600 |   describe('GET /api/coupons/analytics/data (Admin)', () => {
    > 601 |     it('should get coupon analytics data', async () => {
          |     ^
      602 |       mockCouponController.getCouponAnalytics = jest.fn((
      603 |         _req: Request,
      604 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:601:5
      at src/__tests__/integration/routes/coupon.test.ts:600:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId/redemptions (Admin) › should get coupon redemption history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      625 |
      626 |   describe('GET /api/coupons/:couponId/redemptions (Admin)', () => {
    > 627 |     it('should get coupon redemption history', async () => {
          |     ^
      628 |       mockCouponController.getCouponRedemptions = jest.fn((
      629 |         _req: Request,
      630 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:627:5
      at src/__tests__/integration/routes/coupon.test.ts:626:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId/assignments (Admin) › should get coupon assignment history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      652 |
      653 |   describe('GET /api/coupons/:couponId/assignments (Admin)', () => {
    > 654 |     it('should get coupon assignment history', async () => {
          |     ^
      655 |       mockCouponController.getCouponAssignments = jest.fn((
      656 |         _req: Request,
      657 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:654:5
      at src/__tests__/integration/routes/coupon.test.ts:653:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

2025-11-12 09:07:57 [[31merror[39m]: Validation Error Details: {"url":"/coupon-assignments","method":"POST","errors":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["survey_id"]},{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["coupon_id"]}],"requestBody":{"survey_id":"not-a-uuid","coupon_id":"also-not-a-uuid"},"requestParams":{},"requestQuery":{}}
FAIL src/__tests__/integration/routes/survey.test.ts (296.13 s)
  Survey Routes Integration Tests
    POST /api/surveys (Admin)
      ✕ should create survey with valid data (10005 ms)
      ✓ should reject survey with invalid question type (12 ms)
      ✓ should reject survey without questions (5 ms)
      ✕ should create survey with target segment (10000 ms)
    GET /api/surveys
      ✕ should get all surveys (10001 ms)
      ✕ should support pagination (10008 ms)
    GET /api/surveys/:id
      ✕ should get specific survey (10000 ms)
      ✕ should handle survey not found (10000 ms)
    PUT /api/surveys/:id (Admin)
      ✕ should update survey (10008 ms)
      ✓ should reject invalid status (7 ms)
    DELETE /api/surveys/:id (Admin)
      ✕ should delete survey (10001 ms)
    POST /api/surveys/responses
      ✕ should submit survey response (10000 ms)
      ✓ should reject invalid survey ID (5 ms)
      ✕ should handle partial response submission (10001 ms)
    GET /api/surveys/responses/:surveyId/user
      ✕ should get user response for survey (10001 ms)
      ✕ should return null for survey with no user response (10001 ms)
    GET /api/surveys/:surveyId/responses (Admin)
      ✕ should get all survey responses (10000 ms)
    GET /api/surveys/available/user
      ✕ should get available surveys for user (10000 ms)
    GET /api/surveys/public/user
      ✕ should get public surveys (10000 ms)
    GET /api/surveys/invited/user
      ✕ should get invited surveys for user (10003 ms)
    GET /api/surveys/:surveyId/analytics (Admin)
      ✕ should get survey analytics (10001 ms)
    GET /api/surveys/:surveyId/export (Admin)
      ✕ should export survey responses (20008 ms)
    POST /api/surveys/:surveyId/invitations/send (Admin)
      ✕ should send survey invitations (20000 ms)
    POST /api/surveys/coupon-assignments (Admin)
      ✕ should assign coupon to survey (20010 ms)
      ✓ should reject invalid UUID format (6 ms)
    GET /api/surveys/:surveyId/coupon-assignments (Admin)
      ✕ should get survey coupon assignments (20002 ms)
    GET /api/surveys/:surveyId/reward-history (Admin)
      ✕ should get survey reward history (20000 ms)
    GET /api/surveys/admin/coupon-assignments (Admin)
      ✕ should get all survey coupon assignments (20004 ms)

  ● Survey Routes Integration Tests › POST /api/surveys (Admin) › should create survey with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('POST /api/surveys (Admin)', () => {
    > 54 |     it('should create survey with valid data', async () => {
         |     ^
      55 |       mockSurveyController.createSurvey = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:54:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys (Admin) › should create survey with target segment

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |     });
      123 |
    > 124 |     it('should create survey with target segment', async () => {
          |     ^
      125 |       mockSurveyController.createSurvey = jest.fn((
      126 |         _req: Request,
      127 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:124:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys › should get all surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      165 |
      166 |   describe('GET /api/surveys', () => {
    > 167 |     it('should get all surveys', async () => {
          |     ^
      168 |       mockSurveyController.getSurveys = jest.fn((
      169 |         _req: Request,
      170 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:167:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys › should support pagination

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      186 |     });
      187 |
    > 188 |     it('should support pagination', async () => {
          |     ^
      189 |       mockSurveyController.getSurveys = jest.fn((
      190 |         _req: Request,
      191 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:188:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:id › should get specific survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      207 |
      208 |   describe('GET /api/surveys/:id', () => {
    > 209 |     it('should get specific survey', async () => {
          |     ^
      210 |       mockSurveyController.getSurvey = jest.fn((
      211 |         _req: Request,
      212 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:209:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:id › should handle survey not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |     });
      231 |
    > 232 |     it('should handle survey not found', async () => {
          |     ^
      233 |       mockSurveyController.getSurvey = jest.fn((
      234 |         _req: Request,
      235 |         _res: Response,

      at src/__tests__/integration/routes/survey.test.ts:232:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › PUT /api/surveys/:id (Admin) › should update survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      247 |
      248 |   describe('PUT /api/surveys/:id (Admin)', () => {
    > 249 |     it('should update survey', async () => {
          |     ^
      250 |       mockSurveyController.updateSurvey = jest.fn((
      251 |         _req: Request,
      252 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:249:5
      at src/__tests__/integration/routes/survey.test.ts:248:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › DELETE /api/surveys/:id (Admin) › should delete survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |
      287 |   describe('DELETE /api/surveys/:id (Admin)', () => {
    > 288 |     it('should delete survey', async () => {
          |     ^
      289 |       mockSurveyController.deleteSurvey = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:288:5
      at src/__tests__/integration/routes/survey.test.ts:287:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/responses › should submit survey response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      306 |
      307 |   describe('POST /api/surveys/responses', () => {
    > 308 |     it('should submit survey response', async () => {
          |     ^
      309 |       mockSurveyController.submitResponse = jest.fn((
      310 |         _req: Request,
      311 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:308:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/responses › should handle partial response submission

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      352 |     });
      353 |
    > 354 |     it('should handle partial response submission', async () => {
          |     ^
      355 |       mockSurveyController.submitResponse = jest.fn((
      356 |         _req: Request,
      357 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:354:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/responses/:surveyId/user › should get user response for survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      380 |
      381 |   describe('GET /api/surveys/responses/:surveyId/user', () => {
    > 382 |     it('should get user response for survey', async () => {
          |     ^
      383 |       mockSurveyController.getUserResponse = jest.fn((
      384 |         _req: Request,
      385 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:382:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/responses/:surveyId/user › should return null for survey with no user response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      403 |     });
      404 |
    > 405 |     it('should return null for survey with no user response', async () => {
          |     ^
      406 |       mockSurveyController.getUserResponse = jest.fn((
      407 |         _req: Request,
      408 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:405:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/responses (Admin) › should get all survey responses

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      420 |
      421 |   describe('GET /api/surveys/:surveyId/responses (Admin)', () => {
    > 422 |     it('should get all survey responses', async () => {
          |     ^
      423 |       mockSurveyController.getSurveyResponses = jest.fn((
      424 |         _req: Request,
      425 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:422:5
      at src/__tests__/integration/routes/survey.test.ts:421:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/available/user › should get available surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      443 |
      444 |   describe('GET /api/surveys/available/user', () => {
    > 445 |     it('should get available surveys for user', async () => {
          |     ^
      446 |       mockSurveyController.getAvailableSurveys = jest.fn((
      447 |         _req: Request,
      448 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:445:5
      at src/__tests__/integration/routes/survey.test.ts:444:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/public/user › should get public surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      466 |
      467 |   describe('GET /api/surveys/public/user', () => {
    > 468 |     it('should get public surveys', async () => {
          |     ^
      469 |       mockSurveyController.getPublicSurveys = jest.fn((
      470 |         _req: Request,
      471 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:468:5
      at src/__tests__/integration/routes/survey.test.ts:467:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/invited/user › should get invited surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      488 |
      489 |   describe('GET /api/surveys/invited/user', () => {
    > 490 |     it('should get invited surveys for user', async () => {
          |     ^
      491 |       mockSurveyController.getInvitedSurveys = jest.fn((
      492 |         _req: Request,
      493 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:490:5
      at src/__tests__/integration/routes/survey.test.ts:489:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/analytics (Admin) › should get survey analytics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      510 |
      511 |   describe('GET /api/surveys/:surveyId/analytics (Admin)', () => {
    > 512 |     it('should get survey analytics', async () => {
          |     ^
      513 |       mockSurveyController.getSurveyAnalytics = jest.fn((
      514 |         _req: Request,
      515 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:512:5
      at src/__tests__/integration/routes/survey.test.ts:511:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/export (Admin) › should export survey responses

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      536 |
      537 |   describe('GET /api/surveys/:surveyId/export (Admin)', () => {
    > 538 |     it('should export survey responses', async () => {
          |     ^
      539 |       mockSurveyController.exportSurveyResponses = jest.fn((
      540 |         _req: Request,
      541 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:538:5
      at src/__tests__/integration/routes/survey.test.ts:537:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/:surveyId/invitations/send (Admin) › should send survey invitations

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      554 |
      555 |   describe('POST /api/surveys/:surveyId/invitations/send (Admin)', () => {
    > 556 |     it('should send survey invitations', async () => {
          |     ^
      557 |       mockSurveyController.sendSurveyInvitations = jest.fn((
      558 |         _req: Request,
      559 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:556:5
      at src/__tests__/integration/routes/survey.test.ts:555:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/coupon-assignments (Admin) › should assign coupon to survey

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      578 |
      579 |   describe('POST /api/surveys/coupon-assignments (Admin)', () => {
    > 580 |     it('should assign coupon to survey', async () => {
          |     ^
      581 |       mockSurveyController.assignCouponToSurvey = jest.fn((
      582 |         _req: Request,
      583 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:580:5
      at src/__tests__/integration/routes/survey.test.ts:579:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/coupon-assignments (Admin) › should get survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      620 |
      621 |   describe('GET /api/surveys/:surveyId/coupon-assignments (Admin)', () => {
    > 622 |     it('should get survey coupon assignments', async () => {
          |     ^
      623 |       mockSurveyController.getSurveyCouponAssignments = jest.fn((
      624 |         _req: Request,
      625 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:622:5
      at src/__tests__/integration/routes/survey.test.ts:621:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/reward-history (Admin) › should get survey reward history

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      647 |
      648 |   describe('GET /api/surveys/:surveyId/reward-history (Admin)', () => {
    > 649 |     it('should get survey reward history', async () => {
          |     ^
      650 |       mockSurveyController.getSurveyRewardHistory = jest.fn((
      651 |         _req: Request,
      652 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:649:5
      at src/__tests__/integration/routes/survey.test.ts:648:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/admin/coupon-assignments (Admin) › should get all survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      678 |
      679 |   describe('GET /api/surveys/admin/coupon-assignments (Admin)', () => {
    > 680 |     it('should get all survey coupon assignments', async () => {
          |     ^
      681 |       mockSurveyController.getAllSurveyCouponAssignments = jest.fn((
      682 |         _req: Request,
      683 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:680:5
      at src/__tests__/integration/routes/survey.test.ts:679:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/__tests__/unit/middleware/security.test.ts (5.553 s)
  ● Security Middleware › Rate Limiter Creation › should create basic rate limiter

    TypeError: Cannot read properties of undefined (reading 'rateLimitWindowMs')

      13 | export const createRateLimiter = () => {
      14 |   return rateLimit({
    > 15 |     windowMs: securityConfig.rateLimitWindowMs, // 15 minutes
         |                              ^
      16 |     max: securityConfig.rateLimitMaxRequests, // limit each IP to 100 requests per windowMs
      17 |     message: {
      18 |       error: 'Too many requests',

      at createRateLimiter (src/middleware/security.ts:15:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:83:44)

  ● Security Middleware › Rate Limiter Creation › should create API rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      54 |   };
      55 |   
    > 56 |   const limits = isProduction() ? productionLimits : developmentLimits;
         |                              ^
      57 |   
      58 |   return rateLimit({
      59 |     windowMs: limits.windowMs,

      at createApiRateLimiter (src/middleware/security.ts:56:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:89:46)

  ● Security Middleware › Rate Limiter Creation › should create user-specific rate limiter

    TypeError: (0 , environment_1.isProduction) is not a function

      111 |   };
      112 |   
    > 113 |   const limits = isProduction() ? productionLimits : developmentLimits;
          |                              ^
      114 |   
      115 |   return rateLimit({
      116 |     windowMs: limits.windowMs,

      at createUserRateLimiter (src/middleware/security.ts:113:30)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:95:48)

  ● Security Middleware › Security Headers › should set custom security headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:114:28)

  ● Security Middleware › Security Headers › should set HSTS header with correct max-age

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:124:28)

  ● Security Middleware › File Upload Security › should validate file upload requests

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:199:25)

  ● Security Middleware › File Upload Security › should handle requests without files

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:206:25)

  ● Security Middleware › File Upload Security › should validate file types

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:220:25)

  ● Security Middleware › File Upload Security › should handle multiple file uploads

    TypeError: Cannot read properties of undefined (reading 'maxFileSize')

      296 |   // Check file size
      297 |   const contentLength = parseInt(req.get('content-length') ?? '0', 10);
    > 298 |   if (contentLength > securityConfig.maxFileSize) {
          |                                      ^
      299 |     return res.status(413).json({
      300 |       error: 'File too large',
      301 |       message: `File size exceeds the maximum allowed size of ${securityConfig.maxFileSize} bytes`,

      at fileUploadSecurity (src/middleware/security.ts:298:38)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:243:25)

  ● Security Middleware › Production Security › should apply production security

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:290:25)

  ● Security Middleware › Production Security › should work in development mode

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:296:25)

  ● Security Middleware › Production Security › should handle missing NODE_ENV

    TypeError: (0 , environment_1.isProduction) is not a function

      341 | // Production-specific security middleware
      342 | export const productionSecurity = (req: Request, res: Response, next: NextFunction) => {
    > 343 |   if (!isProduction()) {
          |                    ^
      344 |     return next();
      345 |   }
      346 |   

      at productionSecurity (src/middleware/security.ts:343:20)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:302:25)

  ● Security Middleware › CSRF Protection Headers › should set CSRF protection headers

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:357:28)

  ● Security Middleware › CSRF Protection Headers › should prevent clickjacking

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:362:28)

  ● Security Middleware › CSRF Protection Headers › should prevent MIME sniffing

    TypeError: res.removeHeader is not a function

      232 |   
      233 |   // Remove potentially sensitive headers
    > 234 |   res.removeHeader('X-Powered-By');
          |       ^
      235 |   res.removeHeader('Server');
      236 |   
      237 |   // Add security headers for API responses

      at customSecurityHeaders (src/middleware/security.ts:234:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:367:28)

  ● Security Middleware › Error Scenarios › should handle sanitization errors gracefully

    RangeError: Maximum call stack size exceeded

      258 |         .trim();
      259 |     }
    > 260 |     if (Array.isArray(value)) {
          |     ^
      261 |       return value.map(sanitizeValue);
      262 |     }
      263 |     if (value && typeof value === 'object' && value !== null) {

      at sanitizeValue (src/middleware/security.ts:260:5)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)
      at sanitizeValue (src/middleware/security.ts:271:28)

  ● Security Middleware › Error Scenarios › should continue on setHeader errors

    Header error

      394 |     test('should continue on setHeader errors', () => {
      395 |       (mockRes.setHeader as jest.Mock).mockImplementation(() => {
    > 396 |         throw new Error('Header error');
          |               ^
      397 |       });
      398 |
      399 |       // The middleware should continue even if setHeader throws

      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:396:15)
      at customSecurityHeaders (src/middleware/security.ts:227:7)
      at Object.<anonymous> (src/__tests__/unit/middleware/security.test.ts:400:28)

FAIL src/__tests__/unit/services/translationService.test.ts (5.616 s)
  ● TranslationService › Azure Translation Provider › should translate text using Azure

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:46:47)

  ● TranslationService › Azure Translation Provider › should translate multiple texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:64:47)

  ● TranslationService › Azure Translation Provider › should include Azure headers

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:92:32)

  ● TranslationService › Google Translation Provider › should translate text using Google

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:118:47)

  ● TranslationService › LibreTranslate Provider › should translate text using LibreTranslate

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:153:47)

  ● TranslationService › Translation Job Tracking › should create translation job for survey

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:199:32)

  ● TranslationService › Translation Job Tracking › should track translation job status

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:222:32)

  ● TranslationService › Language Support › should support Thai translation

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:263:47)

  ● TranslationService › Language Support › should support Chinese translation

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:279:47)

  ● TranslationService › Language Support › should support multiple target languages

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:301:47)

  ● TranslationService › Edge Cases › should handle very long texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:336:47)

  ● TranslationService › Edge Cases › should handle special characters

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:352:47)

  ● TranslationService › Edge Cases › should handle same source and target language

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:368:47)

  ● TranslationService › Performance › should handle batch translation efficiently

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:418:47)

  ● TranslationService › Performance › should handle concurrent translation requests

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at src/__tests__/unit/services/translationService.test.ts:435:28
          at Array.from (<anonymous>)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:434:30)

  ● TranslationService › Error Recovery › should handle network timeout

    expect(received).rejects.toThrow(expected)

    Expected substring: "ETIMEDOUT"
    Received message:   "Azure Translator API key not configured"

          90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
          91 |     if (!this.azureConfig.apiKey) {
        > 92 |       throw new Error('Azure Translator API key not configured');
             |             ^
          93 |     }
          94 |
          95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:460:28)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:465:17)

  ● TranslationService › Character Counting › should count characters correctly

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:509:47)

  ● TranslationService › Character Counting › should aggregate character counts for multiple texts

    Azure Translator API key not configured

      90 |   private async translateWithAzure(request: TranslationRequest): Promise<TranslationResponse> {
      91 |     if (!this.azureConfig.apiKey) {
    > 92 |       throw new Error('Azure Translator API key not configured');
         |             ^
      93 |     }
      94 |
      95 |     const { texts, sourceLanguage, targetLanguages } = request;

      at TranslationService.translateWithAzure (src/services/translationService.ts:92:13)
      at TranslationService.translateTexts (src/services/translationService.ts:77:21)
      at Object.<anonymous> (src/__tests__/unit/services/translationService.test.ts:526:47)

FAIL src/__tests__/integration/routes/user.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/unit/services/notificationService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m49[0m:[93m67[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m49[0m       const result = await notificationService.createNotification(notificationData);
    [7m  [0m [91m                                                                  ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m85[0m:[93m67[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "coupon"; data: { couponId: string; code: string; }; expiresAt: Date; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'expiresAt' are incompatible.
        Type 'Date' is not assignable to type 'string'.

    [7m85[0m       const result = await notificationService.createNotification(notificationData);
    [7m  [0m [91m                                                                  ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m112[0m:[93m59[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m112[0m       await expect(notificationService.createNotification(notificationData))
    [7m   [0m [91m                                                          ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m114[0m:[93m59[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general"' is not assignable to type 'NotificationType'.

    [7m114[0m       await expect(notificationService.createNotification(notificationData))
    [7m   [0m [91m                                                          ~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m440[0m:[93m85[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ id: string; code: string; name: string; type: string; value: number; }' is not assignable to parameter of type 'Coupon'.
      Type '{ id: string; code: string; name: string; type: string; value: number; }' is missing the following properties from type 'Coupon': currency, validFrom, usageLimitPerUser, usedCount, and 5 more.

    [7m440[0m       const result = await notificationService.createCouponNotification('user-123', mockCoupon);
    [7m   [0m [91m                                                                                    ~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m500[0m:[93m72[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general"; }[]' is not assignable to parameter of type 'CreateNotificationData[]'.
      Type '{ userId: string; title: string; message: string; type: "general"; }' is not assignable to type 'CreateNotificationData'.
        Types of property 'type' are incompatible.
          Type '"general"' is not assignable to type 'NotificationType'.

    [7m500[0m       const result = await notificationService.createBulkNotifications(notifications);
    [7m   [0m [91m                                                                       ~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/notificationService.test.ts[0m:[93m557[0m:[93m69[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ userId: string; title: string; message: string; type: "general" | "reward" | "coupon"; }' is not assignable to parameter of type 'CreateNotificationData'.
      Types of property 'type' are incompatible.
        Type '"general" | "reward" | "coupon"' is not assignable to type 'NotificationType'.
          Type '"general"' is not assignable to type 'NotificationType'.

    [7m557[0m         const result = await notificationService.createNotification(notificationData);
    [7m   [0m [91m                                                                    ~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/unit/services/oauthService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/oauthService.test.ts[0m:[93m487[0m:[93m76[0m - [91merror[0m[90m TS2345: [0mArgument of type '(email: string) => string | null' is not assignable to parameter of type 'UnknownFunction'.
      Types of parameters 'email' and 'args' are incompatible.
        Type 'unknown' is not assignable to type 'string'.

    [7m487[0m       (adminConfigService.getRequiredRole as jest.Mock).mockImplementation((email: string): string | null => {
    [7m   [0m [91m                                                                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/unit/services/couponService.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m63[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m63[0m       // @ts-expect-error Mock typing
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m111[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m111[0m       // @ts-expect-error Mock typing
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m113[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m113[0m         .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m140[0m:[93m34[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m140[0m           .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m141[0m:[93m34[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; code: string; type: "percentage" | "fixed_amount" | "bogo"; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m141[0m           .mockResolvedValueOnce({
    [7m   [0m [91m                                 ~[0m
    [7m142[0m             rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m148[0m             command: 'INSERT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m149[0m           })
    [7m   [0m [91m~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m300[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m300[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-1' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m302[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m302[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m303[0m           rows: [{ id: 'uc-1', userId: 'user-1', couponId: 'coupon-123', qrCode: 'QR1', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m304[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m305[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m307[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m307[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-2' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m309[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m309[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m310[0m           rows: [{ id: 'uc-2', userId: 'user-2', couponId: 'coupon-123', qrCode: 'QR2', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m311[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m312[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m314[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { assign_coupon_to_user: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m314[0m         .mockResolvedValueOnce({ rows: [{ assign_coupon_to_user: 'uc-3' }], command: 'SELECT' })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m316[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { id: string; userId: string; couponId: string; qrCode: string; status: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m316[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m317[0m           rows: [{ id: 'uc-3', userId: 'user-3', couponId: 'coupon-123', qrCode: 'QR3', status: 'available' }],
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m318[0m           command: 'SELECT'
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m319[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m326[0m:[93m14[0m - [91merror[0m[90m TS2532: [0mObject is possibly 'undefined'.

    [7m326[0m       expect(result[0].couponId).toBe('coupon-123');
    [7m   [0m [91m             ~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m340[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type 'AppError' is not assignable to parameter of type 'never'.

    [7m340[0m         .mockRejectedValueOnce(new AppError(404, 'Coupon not found'))
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m360[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type 'AppError' is not assignable to parameter of type 'never'.

    [7m360[0m         .mockRejectedValueOnce(new AppError(400, 'Coupon is not active'))
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m384[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: number; finalAmount: number; userCouponId: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m384[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m385[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m392[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m393[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m436[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m436[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m437[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m444[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m445[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m465[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: number; finalAmount: number; userCouponId: string; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m465[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m466[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m473[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m474[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m650[0m:[93m7[0m - [91merror[0m[90m TS2578: [0mUnused '@ts-expect-error' directive.

    [7m650[0m       // @ts-expect-error Mock typing
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m652[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: unknown[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m652[0m         .mockResolvedValueOnce({ rows: [], command: 'BEGIN' }as { rows: unknown[]; command: string })
    [7m   [0m [91m                               ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m674[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m674[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m675[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m682[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m683[0m         })
    [7m   [0m [91m~~~~~~~~~[0m
    [96msrc/__tests__/unit/services/couponService.test.ts[0m:[93m704[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ rows: { success: boolean; message: string; discountAmount: null; finalAmount: null; userCouponId: null; }[]; command: string; }' is not assignable to parameter of type 'never'.

    [7m704[0m         .mockResolvedValueOnce({
    [7m   [0m [91m                               ~[0m
    [7m705[0m           rows: [{
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~[0m
    [7m...[0m 
    [7m712[0m           command: 'SELECT',
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m713[0m         })
    [7m   [0m [91m~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/translation.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m29[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m29[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m42[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m42[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/translation.test.ts[0m:[93m464[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m464[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/notifications.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/notifications.test.ts[0m:[93m282[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m282[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/membership.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m27[0m:[93m40[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   authenticate: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                       ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m15[0m - [91merror[0m[90m TS6133: [0m'roles' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m              ~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m45[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                            ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m35[0m:[93m67[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   authorize: (roles: string | string[]) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                                  ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m21[0m - [91merror[0m[90m TS6133: [0m'schema' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                    ~~~~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m38[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                     ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m43[0m:[93m60[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m43[0m   validateRequest: (schema: any) => (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                                           ~~~[0m
    [96msrc/__tests__/integration/routes/membership.test.ts[0m:[93m340[0m:[93m13[0m - [91merror[0m[90m TS6133: [0m'response' is declared but its value is never read.

    [7m340[0m       const response = await request(app)
    [7m   [0m [91m            ~~~~~~~~[0m

FAIL src/__tests__/integration/routes/oauth.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m51[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m51[0m       req.session = {
    [7m  [0m [91m      ~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/oauth.test.ts[0m:[93m331[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType 'Record<string, Mock<any, any, any>>' is not assignable to type 'Session & Partial<SessionData>'.
      Type 'Record<string, Mock<any, any, any>>' is missing the following properties from type 'Session': id, cookie, regenerate, destroy, and 4 more.

    [7m331[0m         req.session = {
    [7m   [0m [91m        ~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/storage.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m35[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m35[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m39[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m39[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m128[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m128[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m149[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m149[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m345[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m345[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/storage.test.ts[0m:[93m365[0m:[93m17[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m365[0m         app.use((req, res, next) => {
    [7m   [0m [91m                ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/loyalty.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/auth.test.ts
  ● Test suite failed to run

    [96msrc/services/authService.ts[0m:[93m74[0m:[93m54[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m74[0m       const tokens = await this.generateTokens(user, client);
    [7m  [0m [91m                                                     ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m77[0m:[93m76[0m - [91merror[0m[90m TS2559: [0mType 'PoolClient' has no properties in common with type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m77[0m       await this.logUserAction(user.id, 'register', { email: data.email }, client);
    [7m  [0m [91m                                                                           ~~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m326[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m326[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m
    [96msrc/services/authService.ts[0m:[93m349[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'query' does not exist on type '{ id?: string | undefined; userAgent?: string | undefined; }'.

    [7m349[0m       await client.query(
    [7m   [0m [91m                   ~~~~~[0m

FAIL src/__tests__/integration/routes/analyticsRoutes.test.ts
  ● Test suite failed to run

    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m27[0m:[93m33[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m27[0m   return (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m31[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'string' is not assignable to type '"customer" | "admin" | "super_admin"'.

    [7m31[0m       role: role
    [7m  [0m [91m      ~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m37[0m:[93m7[0m - [91merror[0m[90m TS6133: [0m'mockAuthorizeMiddleware' is declared but its value is never read.

    [7m37[0m const mockAuthorizeMiddleware = (...allowedRoles: string[]) => {
    [7m  [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m19[0m - [91merror[0m[90m TS6133: [0m'req' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                  ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m49[0m:[93m41[0m - [91merror[0m[90m TS6133: [0m'res' is declared but its value is never read.

    [7m49[0m   requestLogger: (req: express.Request, res: express.Response, next: express.NextFunction) => {
    [7m  [0m [91m                                        ~~~[0m
    [96msrc/__tests__/integration/routes/analyticsRoutes.test.ts[0m:[93m327[0m:[93m15[0m - [91merror[0m[90m TS7030: [0mNot all code paths return a value.

    [7m327[0m       app.use((req, res, next) => {
    [7m   [0m [91m              ~~~~~~~~~~~~~~~~~~~~~[0m

FAIL src/__tests__/integration/routes/coupon.test.ts (215.4 s)
  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should validate coupon by QR code (public route)

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('GET /api/coupons/validate/:qrCode', () => {
    > 54 |     it('should validate coupon by QR code (public route)', async () => {
         |     ^
      55 |       mockCouponController.validateCoupon = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:54:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should return invalid for expired coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      80 |     });
      81 |
    > 82 |     it('should return invalid for expired coupon', async () => {
         |     ^
      83 |       mockCouponController.validateCoupon = jest.fn((
      84 |         _req: Request,
      85 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:82:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/validate/:qrCode › should return invalid for already used coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      102 |     });
      103 |
    > 104 |     it('should return invalid for already used coupon', async () => {
          |     ^
      105 |       mockCouponController.validateCoupon = jest.fn((
      106 |         _req: Request,
      107 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:104:5
      at src/__tests__/integration/routes/coupon.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/my-coupons › should get user coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      125 |
      126 |   describe('GET /api/coupons/my-coupons', () => {
    > 127 |     it('should get user coupons', async () => {
          |     ^
      128 |       mockCouponController.getUserCoupons = jest.fn((
      129 |         _req: Request,
      130 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:127:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/my-coupons › should return empty array for user with no coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      160 |     });
      161 |
    > 162 |     it('should return empty array for user with no coupons', async () => {
          |     ^
      163 |       mockCouponController.getUserCoupons = jest.fn((
      164 |         _req: Request,
      165 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:162:5
      at src/__tests__/integration/routes/coupon.test.ts:126:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/redeem › should redeem coupon with valid QR code

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      177 |
      178 |   describe('POST /api/coupons/redeem', () => {
    > 179 |     it('should redeem coupon with valid QR code', async () => {
          |     ^
      180 |       mockCouponController.redeemCoupon = jest.fn((
      181 |         _req: Request,
      182 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:179:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/redeem › should handle redemption of percentage discount coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      233 |     });
      234 |
    > 235 |     it('should handle redemption of percentage discount coupon', async () => {
          |     ^
      236 |       mockCouponController.redeemCoupon = jest.fn((
      237 |         _req: Request,
      238 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:235:5
      at src/__tests__/integration/routes/coupon.test.ts:178:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons › should list all active coupons

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      265 |
      266 |   describe('GET /api/coupons', () => {
    > 267 |     it('should list all active coupons', async () => {
          |     ^
      268 |       mockCouponController.listCoupons = jest.fn((
      269 |         _req: Request,
      270 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:267:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons › should support pagination for coupon list

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should support pagination for coupon list', async () => {
          |     ^
      289 |       mockCouponController.listCoupons = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:288:5
      at src/__tests__/integration/routes/coupon.test.ts:266:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId › should get specific coupon details

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      307 |
      308 |   describe('GET /api/coupons/:couponId', () => {
    > 309 |     it('should get specific coupon details', async () => {
          |     ^
      310 |       mockCouponController.getCoupon = jest.fn((
      311 |         _req: Request,
      312 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:309:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId › should handle coupon not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      332 |     });
      333 |
    > 334 |     it('should handle coupon not found', async () => {
          |     ^
      335 |       mockCouponController.getCoupon = jest.fn((
      336 |         _req: Request,
      337 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:334:5
      at src/__tests__/integration/routes/coupon.test.ts:308:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons (Admin) › should create coupon with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      349 |
      350 |   describe('POST /api/coupons (Admin)', () => {
    > 351 |     it('should create coupon with valid data', async () => {
          |     ^
      352 |       mockCouponController.createCoupon = jest.fn((
      353 |         _req: Request,
      354 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:351:5
      at src/__tests__/integration/routes/coupon.test.ts:350:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › PUT /api/coupons/:couponId (Admin) › should update coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      408 |
      409 |   describe('PUT /api/coupons/:couponId (Admin)', () => {
    > 410 |     it('should update coupon', async () => {
          |     ^
      411 |       mockCouponController.updateCoupon = jest.fn((
      412 |         _req: Request,
      413 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:410:5
      at src/__tests__/integration/routes/coupon.test.ts:409:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › DELETE /api/coupons/:couponId (Admin) › should delete coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      447 |
      448 |   describe('DELETE /api/coupons/:couponId (Admin)', () => {
    > 449 |     it('should delete coupon', async () => {
          |     ^
      450 |       mockCouponController.deleteCoupon = jest.fn((
      451 |         _req: Request,
      452 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:449:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › DELETE /api/coupons/:couponId (Admin) › should handle deletion of non-existent coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      465 |     });
      466 |
    > 467 |     it('should handle deletion of non-existent coupon', async () => {
          |     ^
      468 |       mockCouponController.deleteCoupon = jest.fn((
      469 |         _req: Request,
      470 |         _res: Response,

      at src/__tests__/integration/routes/coupon.test.ts:467:5
      at src/__tests__/integration/routes/coupon.test.ts:448:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/assign (Admin) › should assign coupon to users

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      505 |         });
      506 |
    > 507 |       expect(response.status).toBe(200);
          |                               ^
      508 |       expect(response.body.data.assigned).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:507:31)

  ● Coupon Routes Integration Tests › POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) › should revoke user coupon

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      535 |
      536 |   describe('POST /api/coupons/user-coupons/:userCouponId/revoke (Admin)', () => {
    > 537 |     it('should revoke user coupon', async () => {
          |     ^
      538 |       mockCouponController.revokeUserCoupon = jest.fn((
      539 |         _req: Request,
      540 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:537:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › POST /api/coupons/user-coupons/:userCouponId/revoke (Admin) › should revoke coupon without reason

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      556 |     });
      557 |
    > 558 |     it('should revoke coupon without reason', async () => {
          |     ^
      559 |       mockCouponController.revokeUserCoupon = jest.fn((
      560 |         _req: Request,
      561 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:558:5
      at src/__tests__/integration/routes/coupon.test.ts:536:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/analytics/stats (Admin) › should get coupon statistics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      573 |
      574 |   describe('GET /api/coupons/analytics/stats (Admin)', () => {
    > 575 |     it('should get coupon statistics', async () => {
          |     ^
      576 |       mockCouponController.getCouponStats = jest.fn((
      577 |         _req: Request,
      578 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:575:5
      at src/__tests__/integration/routes/coupon.test.ts:574:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/analytics/data (Admin) › should get coupon analytics data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      599 |
      600 |   describe('GET /api/coupons/analytics/data (Admin)', () => {
    > 601 |     it('should get coupon analytics data', async () => {
          |     ^
      602 |       mockCouponController.getCouponAnalytics = jest.fn((
      603 |         _req: Request,
      604 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:601:5
      at src/__tests__/integration/routes/coupon.test.ts:600:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId/redemptions (Admin) › should get coupon redemption history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      625 |
      626 |   describe('GET /api/coupons/:couponId/redemptions (Admin)', () => {
    > 627 |     it('should get coupon redemption history', async () => {
          |     ^
      628 |       mockCouponController.getCouponRedemptions = jest.fn((
      629 |         _req: Request,
      630 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:627:5
      at src/__tests__/integration/routes/coupon.test.ts:626:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

  ● Coupon Routes Integration Tests › GET /api/coupons/:couponId/assignments (Admin) › should get coupon assignment history

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      652 |
      653 |   describe('GET /api/coupons/:couponId/assignments (Admin)', () => {
    > 654 |     it('should get coupon assignment history', async () => {
          |     ^
      655 |       mockCouponController.getCouponAssignments = jest.fn((
      656 |         _req: Request,
      657 |         res: Response

      at src/__tests__/integration/routes/coupon.test.ts:654:5
      at src/__tests__/integration/routes/coupon.test.ts:653:3
      at Object.<anonymous> (src/__tests__/integration/routes/coupon.test.ts:36:1)

FAIL src/__tests__/integration/routes/survey.test.ts (296.13 s)
  ● Survey Routes Integration Tests › POST /api/surveys (Admin) › should create survey with valid data

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      52 |
      53 |   describe('POST /api/surveys (Admin)', () => {
    > 54 |     it('should create survey with valid data', async () => {
         |     ^
      55 |       mockSurveyController.createSurvey = jest.fn((
      56 |         _req: Request,
      57 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:54:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys (Admin) › should create survey with target segment

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |     });
      123 |
    > 124 |     it('should create survey with target segment', async () => {
          |     ^
      125 |       mockSurveyController.createSurvey = jest.fn((
      126 |         _req: Request,
      127 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:124:5
      at src/__tests__/integration/routes/survey.test.ts:53:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys › should get all surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      165 |
      166 |   describe('GET /api/surveys', () => {
    > 167 |     it('should get all surveys', async () => {
          |     ^
      168 |       mockSurveyController.getSurveys = jest.fn((
      169 |         _req: Request,
      170 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:167:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys › should support pagination

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      186 |     });
      187 |
    > 188 |     it('should support pagination', async () => {
          |     ^
      189 |       mockSurveyController.getSurveys = jest.fn((
      190 |         _req: Request,
      191 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:188:5
      at src/__tests__/integration/routes/survey.test.ts:166:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:id › should get specific survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      207 |
      208 |   describe('GET /api/surveys/:id', () => {
    > 209 |     it('should get specific survey', async () => {
          |     ^
      210 |       mockSurveyController.getSurvey = jest.fn((
      211 |         _req: Request,
      212 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:209:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:id › should handle survey not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |     });
      231 |
    > 232 |     it('should handle survey not found', async () => {
          |     ^
      233 |       mockSurveyController.getSurvey = jest.fn((
      234 |         _req: Request,
      235 |         _res: Response,

      at src/__tests__/integration/routes/survey.test.ts:232:5
      at src/__tests__/integration/routes/survey.test.ts:208:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › PUT /api/surveys/:id (Admin) › should update survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      247 |
      248 |   describe('PUT /api/surveys/:id (Admin)', () => {
    > 249 |     it('should update survey', async () => {
          |     ^
      250 |       mockSurveyController.updateSurvey = jest.fn((
      251 |         _req: Request,
      252 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:249:5
      at src/__tests__/integration/routes/survey.test.ts:248:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › DELETE /api/surveys/:id (Admin) › should delete survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |
      287 |   describe('DELETE /api/surveys/:id (Admin)', () => {
    > 288 |     it('should delete survey', async () => {
          |     ^
      289 |       mockSurveyController.deleteSurvey = jest.fn((
      290 |         _req: Request,
      291 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:288:5
      at src/__tests__/integration/routes/survey.test.ts:287:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/responses › should submit survey response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      306 |
      307 |   describe('POST /api/surveys/responses', () => {
    > 308 |     it('should submit survey response', async () => {
          |     ^
      309 |       mockSurveyController.submitResponse = jest.fn((
      310 |         _req: Request,
      311 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:308:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/responses › should handle partial response submission

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      352 |     });
      353 |
    > 354 |     it('should handle partial response submission', async () => {
          |     ^
      355 |       mockSurveyController.submitResponse = jest.fn((
      356 |         _req: Request,
      357 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:354:5
      at src/__tests__/integration/routes/survey.test.ts:307:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/responses/:surveyId/user › should get user response for survey

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      380 |
      381 |   describe('GET /api/surveys/responses/:surveyId/user', () => {
    > 382 |     it('should get user response for survey', async () => {
          |     ^
      383 |       mockSurveyController.getUserResponse = jest.fn((
      384 |         _req: Request,
      385 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:382:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/responses/:surveyId/user › should return null for survey with no user response

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      403 |     });
      404 |
    > 405 |     it('should return null for survey with no user response', async () => {
          |     ^
      406 |       mockSurveyController.getUserResponse = jest.fn((
      407 |         _req: Request,
      408 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:405:5
      at src/__tests__/integration/routes/survey.test.ts:381:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/responses (Admin) › should get all survey responses

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      420 |
      421 |   describe('GET /api/surveys/:surveyId/responses (Admin)', () => {
    > 422 |     it('should get all survey responses', async () => {
          |     ^
      423 |       mockSurveyController.getSurveyResponses = jest.fn((
      424 |         _req: Request,
      425 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:422:5
      at src/__tests__/integration/routes/survey.test.ts:421:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/available/user › should get available surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      443 |
      444 |   describe('GET /api/surveys/available/user', () => {
    > 445 |     it('should get available surveys for user', async () => {
          |     ^
      446 |       mockSurveyController.getAvailableSurveys = jest.fn((
      447 |         _req: Request,
      448 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:445:5
      at src/__tests__/integration/routes/survey.test.ts:444:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/public/user › should get public surveys

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      466 |
      467 |   describe('GET /api/surveys/public/user', () => {
    > 468 |     it('should get public surveys', async () => {
          |     ^
      469 |       mockSurveyController.getPublicSurveys = jest.fn((
      470 |         _req: Request,
      471 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:468:5
      at src/__tests__/integration/routes/survey.test.ts:467:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/invited/user › should get invited surveys for user

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      488 |
      489 |   describe('GET /api/surveys/invited/user', () => {
    > 490 |     it('should get invited surveys for user', async () => {
          |     ^
      491 |       mockSurveyController.getInvitedSurveys = jest.fn((
      492 |         _req: Request,
      493 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:490:5
      at src/__tests__/integration/routes/survey.test.ts:489:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/analytics (Admin) › should get survey analytics

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      510 |
      511 |   describe('GET /api/surveys/:surveyId/analytics (Admin)', () => {
    > 512 |     it('should get survey analytics', async () => {
          |     ^
      513 |       mockSurveyController.getSurveyAnalytics = jest.fn((
      514 |         _req: Request,
      515 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:512:5
      at src/__tests__/integration/routes/survey.test.ts:511:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/export (Admin) › should export survey responses

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      536 |
      537 |   describe('GET /api/surveys/:surveyId/export (Admin)', () => {
    > 538 |     it('should export survey responses', async () => {
          |     ^
      539 |       mockSurveyController.exportSurveyResponses = jest.fn((
      540 |         _req: Request,
      541 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:538:5
      at src/__tests__/integration/routes/survey.test.ts:537:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/:surveyId/invitations/send (Admin) › should send survey invitations

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      554 |
      555 |   describe('POST /api/surveys/:surveyId/invitations/send (Admin)', () => {
    > 556 |     it('should send survey invitations', async () => {
          |     ^
      557 |       mockSurveyController.sendSurveyInvitations = jest.fn((
      558 |         _req: Request,
      559 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:556:5
      at src/__tests__/integration/routes/survey.test.ts:555:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › POST /api/surveys/coupon-assignments (Admin) › should assign coupon to survey

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      578 |
      579 |   describe('POST /api/surveys/coupon-assignments (Admin)', () => {
    > 580 |     it('should assign coupon to survey', async () => {
          |     ^
      581 |       mockSurveyController.assignCouponToSurvey = jest.fn((
      582 |         _req: Request,
      583 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:580:5
      at src/__tests__/integration/routes/survey.test.ts:579:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/coupon-assignments (Admin) › should get survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      620 |
      621 |   describe('GET /api/surveys/:surveyId/coupon-assignments (Admin)', () => {
    > 622 |     it('should get survey coupon assignments', async () => {
          |     ^
      623 |       mockSurveyController.getSurveyCouponAssignments = jest.fn((
      624 |         _req: Request,
      625 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:622:5
      at src/__tests__/integration/routes/survey.test.ts:621:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/:surveyId/reward-history (Admin) › should get survey reward history

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      647 |
      648 |   describe('GET /api/surveys/:surveyId/reward-history (Admin)', () => {
    > 649 |     it('should get survey reward history', async () => {
          |     ^
      650 |       mockSurveyController.getSurveyRewardHistory = jest.fn((
      651 |         _req: Request,
      652 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:649:5
      at src/__tests__/integration/routes/survey.test.ts:648:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)

  ● Survey Routes Integration Tests › GET /api/surveys/admin/coupon-assignments (Admin) › should get all survey coupon assignments

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      678 |
      679 |   describe('GET /api/surveys/admin/coupon-assignments (Admin)', () => {
    > 680 |     it('should get all survey coupon assignments', async () => {
          |     ^
      681 |       mockSurveyController.getAllSurveyCouponAssignments = jest.fn((
      682 |         _req: Request,
      683 |         res: Response

      at src/__tests__/integration/routes/survey.test.ts:680:5
      at src/__tests__/integration/routes/survey.test.ts:679:3
      at Object.<anonymous> (src/__tests__/integration/routes/survey.test.ts:36:1)


Test Suites: 16 failed, 12 passed, 28 total
Tests:       80 failed, 306 passed, 386 total
Snapshots:   0 total
Time:        297.335 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
