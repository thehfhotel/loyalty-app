#!/bin/bash

# Loyalty App Pre-Push Quality Gate
# This hook runs comprehensive quality checks before allowing push to remote
# All checks must pass for the push to succeed

set -e  # Exit on any error

echo "ðŸš€ Pre-Push Quality Gate Starting..."
echo "================================================"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print status
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to run a check and handle errors
run_check() {
    local check_name="$1"
    local command="$2"
    
    print_status "Running $check_name..."
    
    if eval "$command"; then
        print_success "$check_name passed âœ…"
        return 0
    else
        print_error "$check_name failed âŒ"
        echo "Fix the issues above before pushing to remote."
        return 1
    fi
}

# Check if we're in the project root
if [ ! -f "package.json" ] || [ ! -d "backend" ] || [ ! -d "frontend" ]; then
    print_error "Must be run from project root directory"
    exit 1
fi

# 1. TypeScript Type Checking
echo ""
print_status "=== TypeScript Type Checking ==="
run_check "Backend TypeScript" "cd backend && npm run typecheck" || exit 1
run_check "Frontend TypeScript" "cd frontend && npm run typecheck" || exit 1

# 2. ESLint Checks
echo ""
print_status "=== ESLint Code Quality Checks ==="
run_check "Backend ESLint" "cd backend && npm run lint" || exit 1
run_check "Frontend ESLint" "cd frontend && npm run lint" || exit 1

# 3. Unit Tests
echo ""
print_status "=== Unit Tests ==="
run_check "Backend Unit Tests" "cd backend && npm run test:unit" || exit 1
print_warning "Frontend unit tests not yet implemented"

# 4. Integration Tests
echo ""
print_status "=== Integration Tests ==="
run_check "Backend Integration Tests" "cd backend && npm run test:integration" || exit 1

# 5. Build Tests
echo ""
print_status "=== Build Verification ==="
run_check "Backend Build" "cd backend && npm run build" || exit 1
run_check "Frontend Build" "cd frontend && npm run build" || exit 1

# 6. Security Audit (allow warnings, fail on vulnerabilities)
echo ""
print_status "=== Security Audit ==="
print_status "Checking for security vulnerabilities..."

# Backend security check
if cd backend && npm audit --audit-level=moderate --silent; then
    print_success "Backend security audit passed âœ…"
else
    print_warning "Backend has security warnings - please review"
fi

# Frontend security check  
if cd ../frontend && npm audit --audit-level=moderate --silent; then
    print_success "Frontend security audit passed âœ…"
else
    print_warning "Frontend has security warnings - please review"
fi

cd ..

# 7. E2E Tests (Optional - only if app is running)
echo ""
print_status "=== End-to-End Tests ==="
if curl -s http://localhost:4001/api/health > /dev/null 2>&1; then
    print_status "App is running, executing E2E tests..."
    if npx playwright test --reporter=line; then
        print_success "E2E tests passed âœ…"
    else
        print_warning "E2E tests failed - continuing push (E2E failures are warnings)"
    fi
else
    print_warning "App not running locally - skipping E2E tests"
fi

# Summary
echo ""
echo "================================================"
print_success "ðŸŽ‰ All quality checks passed!"
print_success "âœ… TypeScript compilation successful"
print_success "âœ… ESLint checks passed"
print_success "âœ… Unit tests passed"
print_success "âœ… Integration tests passed"
print_success "âœ… Build verification successful"
print_success "âœ… Security audit completed"
echo ""
print_status "ðŸš€ Push to remote is approved!"
echo "================================================"

exit 0