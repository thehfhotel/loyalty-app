version: '3.8'

services:
  # API Gateway
  api-gateway:
    image: kong:latest
    container_name: loyalty-api-gateway
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8443:8443"
      - "8444:8444"
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=postgres
      - KONG_PG_PORT=5432
      - KONG_PG_DATABASE=kong
      - KONG_PG_USER=kong
      - KONG_PG_PASSWORD=kong
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
    depends_on:
      - postgres
    networks:
      - loyalty-network
    restart: unless-stopped

  # User Service
  user-service:
    build: ./services/user-service
    container_name: loyalty-user-service
    ports:
      - "3011:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-jwt-secret-key
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Loyalty Service
  loyalty-service:
    build: ./services/loyalty-service
    container_name: loyalty-loyalty-service
    ports:
      - "3012:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Campaign Service
  campaign-service:
    build: ./services/campaign-service
    container_name: loyalty-campaign-service
    ports:
      - "3013:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - FIREBASE_PROJECT_ID=your-firebase-project-id
      - FIREBASE_PRIVATE_KEY=your-firebase-private-key
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Survey Service
  survey-service:
    build: ./services/survey-service
    container_name: loyalty-survey-service
    ports:
      - "3014:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Coupon Service
  coupon-service:
    build: ./services/coupon-service
    container_name: loyalty-coupon-service
    ports:
      - "3015:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build: ./services/notification-service
    container_name: loyalty-notification-service
    ports:
      - "3016:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - FIREBASE_PROJECT_ID=your-firebase-project-id
      - FIREBASE_PRIVATE_KEY=your-firebase-private-key
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USER=your-email@gmail.com
      - SMTP_PASS=your-app-password
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    build: ./services/analytics-service
    container_name: loyalty-analytics-service
    ports:
      - "3017:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - GOOGLE_ANALYTICS_ID=your-ga-id
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Integration Service
  integration-service:
    build: ./services/integration-service
    container_name: loyalty-integration-service
    ports:
      - "3018:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loyalty_user:password@postgres:5432/loyalty_db?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - PMS_API_URL=https://your-pms-api.com
      - PMS_API_KEY=your-pms-api-key
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # PWA Frontend
  pwa-frontend:
    build: 
      context: ./frontend
      args:
        REACT_APP_API_URL: http://192.168.100.228:3011
        REACT_APP_FIREBASE_CONFIG: your-firebase-config
        REACT_APP_DOMAIN: saichon.com
    container_name: loyalty-pwa-frontend
    ports:
      - "3010:3000"
    environment:
      - NODE_ENV=development
    depends_on:
      - api-gateway
    networks:
      - loyalty-network
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: loyalty-postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=loyalty_db
      - POSTGRES_USER=loyalty_user
      - POSTGRES_PASSWORD=password
      - POSTGRES_MULTIPLE_DATABASES=kong
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
      - ./database/schemas:/docker-entrypoint-initdb.d/schemas
    networks:
      - loyalty-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: loyalty-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - loyalty-network
    restart: unless-stopped

  # RabbitMQ Message Queue
  rabbitmq:
    image: rabbitmq:3-management
    container_name: loyalty-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - loyalty-network
    restart: unless-stopped

  # Monitoring (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: loyalty-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - loyalty-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: loyalty-grafana
    ports:
      - "3019:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=https://monitoring.saichon.com
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - loyalty-network
    restart: unless-stopped

  # Note: Cloudflare Tunnel is already running on this server
  # No need to include it in this docker-compose

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  prometheus_data:
  grafana_data:

networks:
  loyalty-network:
    driver: bridge