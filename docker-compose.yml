services:
  postgres:
    image: postgres:15-alpine
    container_name: loyalty_postgres
    environment:
      POSTGRES_USER: loyalty
      POSTGRES_PASSWORD: loyalty_pass
      POSTGRES_DB: loyalty_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Removed old SQL migrations - Prisma handles schema migrations now
      # - ./database/migrations:/docker-entrypoint-initdb.d
      # - ./database/seeds:/docker-entrypoint-initdb.d/seeds
      # - ./database/init-db.sh:/docker-entrypoint-initdb.d/zzz-init-db.sh
    # PORTS: Defined in environment-specific override files (dev/prod)
    # to prevent port conflicts when both environments run on same machine
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U loyalty -d loyalty_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: loyalty_redis
    # PORTS: Defined in environment-specific override files (dev/prod)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: loyalty_backend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${BACKEND_PORT:-4000}
      DATABASE_URL: postgresql://loyalty:loyalty_pass@postgres:5432/loyalty_db
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?JWT_REFRESH_SECRET is required}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:?GOOGLE_CLIENT_ID is required}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:?GOOGLE_CLIENT_SECRET is required}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:?GOOGLE_CALLBACK_URL is required}
      LINE_CHANNEL_ID: ${LINE_CHANNEL_ID:?LINE_CHANNEL_ID is required}
      LINE_CHANNEL_SECRET: ${LINE_CHANNEL_SECRET:?LINE_CHANNEL_SECRET is required}
      LINE_CALLBACK_URL: ${LINE_CALLBACK_URL:?LINE_CALLBACK_URL is required}
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL is required}
      LOYALTY_USERNAME: ${LOYALTY_USERNAME:?LOYALTY_USERNAME is required}
      LOYALTY_PASSWORD: ${LOYALTY_PASSWORD:?LOYALTY_PASSWORD is required}
      TRANSLATION_FEATURE_ENABLED: ${TRANSLATION_FEATURE_ENABLED:-false}
      AZURE_TRANSLATION_TEXT_URI: ${AZURE_TRANSLATION_TEXT_URI:-}
      AZURE_TRANSLATION_KEY_1: ${AZURE_TRANSLATION_KEY_1:-}
      AZURE_TRANSLATION_KEY_2: ${AZURE_TRANSLATION_KEY_2:-}
      AZURE_TRANSLATION_REGION: ${AZURE_TRANSLATION_REGION:-global}
    volumes:
      - ./backend:/app
      - /app/node_modules
      - backend_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Command defined in override files (dev: npm run dev, prod: uses Dockerfile CMD)

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: loyalty_frontend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      VITE_API_URL: ${VITE_API_URL:?VITE_API_URL is required}
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - frontend_logs:/app/logs
    depends_on:
      - backend
    # Command defined in override files (dev: npm run dev, prod: build & preview)

  nginx:
    image: nginx:alpine
    container_name: loyalty_nginx
    # PORTS: Defined in environment-specific override files (dev/prod)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data:
  backend_logs:
  backend_storage:
  frontend_logs:
  nginx_logs:
