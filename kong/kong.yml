_format_version: "3.0"

services:
  - name: user-service
    url: http://user-service:3000
    protocol: http
    host: user-service
    port: 3000
    path: /
    
  - name: loyalty-service
    url: http://loyalty-service:3000
    protocol: http
    host: loyalty-service
    port: 3000
    path: /
    
  - name: campaign-service
    url: http://campaign-service:3000
    protocol: http
    host: campaign-service
    port: 3000
    path: /
    
  - name: survey-service
    url: http://survey-service:3000
    protocol: http
    host: survey-service
    port: 3000
    path: /
    
  - name: coupon-service
    url: http://coupon-service:3000
    protocol: http
    host: coupon-service
    port: 3000
    path: /
    
  - name: notification-service
    url: http://notification-service:3000
    protocol: http
    host: notification-service
    port: 3000
    path: /
    
  - name: analytics-service
    url: http://analytics-service:3000
    protocol: http
    host: analytics-service
    port: 3000
    path: /
    
  - name: integration-service
    url: http://integration-service:3000
    protocol: http
    host: integration-service
    port: 3000
    path: /

routes:
  # User Service Routes
  - name: user-auth
    service: user-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/auth
    strip_path: false
    
  - name: user-profile
    service: user-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/profile
    strip_path: false
    
  # Loyalty Service Routes
  - name: loyalty-points
    service: loyalty-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/loyalty
    strip_path: false
    
  - name: loyalty-tiers
    service: loyalty-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/tiers
    strip_path: false
    
  - name: loyalty-rewards
    service: loyalty-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/rewards
    strip_path: false
    
  # Campaign Service Routes
  - name: campaigns
    service: campaign-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/campaigns
    strip_path: false
    
  # Survey Service Routes
  - name: surveys
    service: survey-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/surveys
    strip_path: false
    
  # Coupon Service Routes
  - name: coupons
    service: coupon-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/coupons
    strip_path: false
    
  # Notification Service Routes
  - name: notifications
    service: notification-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/notifications
    strip_path: false
    
  # Analytics Service Routes
  - name: analytics
    service: analytics-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/analytics
    strip_path: false
    
  # Integration Service Routes
  - name: integrations
    service: integration-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /api/v1/integrations
    strip_path: false
    
  # Health Check Routes
  - name: health-checks
    service: user-service
    hosts:
      - api.saichon.com
      - localhost
    paths:
      - /health
    strip_path: false

plugins:
  # Global rate limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 6000
      policy: redis
      redis_host: redis
      redis_port: 6379
      
  # Global CORS
  - name: cors
    config:
      origins:
        - "https://loyalty.saichon.com"
        - "http://localhost:3010"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600
      
  # Global request/response logging
  - name: file-log
    config:
      path: /tmp/access.log
      
  # Global security headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Strict-Transport-Security: max-age=31536000; includeSubDomains"

# JWT Authentication for protected routes
consumers:
  - username: loyalty-app-user
    jwt_secrets:
      - key: loyalty-app
        secret: your-jwt-secret-key

# Apply JWT authentication to protected routes
- name: jwt
  route: user-profile
  config:
    key_claim_name: iss
    
- name: jwt
  route: loyalty-points
  config:
    key_claim_name: iss
    
- name: jwt
  route: loyalty-tiers
  config:
    key_claim_name: iss
    
- name: jwt
  route: loyalty-rewards
  config:
    key_claim_name: iss
    
- name: jwt
  route: campaigns
  config:
    key_claim_name: iss
    
- name: jwt
  route: surveys
  config:
    key_claim_name: iss
    
- name: jwt
  route: coupons
  config:
    key_claim_name: iss
    
- name: jwt
  route: notifications
  config:
    key_claim_name: iss
    
- name: jwt
  route: analytics
  config:
    key_claim_name: iss