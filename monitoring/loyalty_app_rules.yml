groups:
  - name: loyalty_app_alerts
    rules:
      # Service Health Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."

      # High Error Rate
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.job }}"
          description: "Error rate is {{ $value }} errors per second on {{ $labels.job }}."

      # High Response Time
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time on {{ $labels.job }}"
          description: "95th percentile response time is {{ $value }}s on {{ $labels.job }}."

      # Database Connection Issues
      - alert: DatabaseConnectionHigh
        expr: database_connections_active / database_connections_max > 0.8
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Database connection usage high"
          description: "Database connection usage is {{ $value }}% of maximum."

      # Memory Usage High
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes / process_virtual_memory_max_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.job }}"
          description: "Memory usage is {{ $value }}% on {{ $labels.job }}."

      # Disk Usage High
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes > 0.85
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High disk usage"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }}."

  - name: loyalty_business_alerts
    rules:
      # Low App Adoption Rate
      - alert: LowAppAdoption
        expr: (app_installations_total / registered_users_total) < 0.3
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low app adoption rate"
          description: "App adoption rate is {{ $value }}% which is below the 30% threshold."

      # High Campaign Unsubscribe Rate
      - alert: HighUnsubscribeRate
        expr: rate(campaign_unsubscribes_total[1h]) / rate(campaign_deliveries_total[1h]) > 0.05
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "High campaign unsubscribe rate"
          description: "Campaign unsubscribe rate is {{ $value }}% in the last hour."

      # Low Survey Response Rate
      - alert: LowSurveyResponseRate
        expr: rate(survey_responses_completed_total[24h]) / rate(survey_invitations_sent_total[24h]) < 0.1
        for: 1h
        labels:
          severity: info
        annotations:
          summary: "Low survey response rate"
          description: "Survey response rate is {{ $value }}% in the last 24 hours."

      # Points Liability High
      - alert: HighPointsLiability
        expr: loyalty_points_outstanding_total > 1000000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "High points liability"
          description: "Outstanding loyalty points liability is {{ $value }} points."

  - name: loyalty_app_recording_rules
    rules:
      # Request Rate
      - record: loyalty:http_requests_per_second
        expr: rate(http_requests_total[5m])

      # Error Rate
      - record: loyalty:http_error_rate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

      # Response Time 95th percentile
      - record: loyalty:http_response_time_95th
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      # Active Users (last hour)
      - record: loyalty:active_users_1h
        expr: count(increase(user_activity_total[1h]) > 0)

      # Daily Registration Rate
      - record: loyalty:daily_registrations
        expr: increase(user_registrations_total[24h])

      # Campaign Engagement Rate
      - record: loyalty:campaign_engagement_rate
        expr: rate(campaign_clicks_total[1h]) / rate(campaign_deliveries_total[1h])

      # Survey Completion Rate
      - record: loyalty:survey_completion_rate
        expr: rate(survey_responses_completed_total[24h]) / rate(survey_invitations_sent_total[24h])

      # Points Redemption Rate
      - record: loyalty:points_redemption_rate
        expr: rate(loyalty_points_redeemed_total[24h]) / rate(loyalty_points_earned_total[24h])

      # Booking Conversion Rate
      - record: loyalty:booking_conversion_rate
        expr: rate(bookings_completed_total[24h]) / rate(user_sessions_total[24h])

      # App Performance Score
      - record: loyalty:app_performance_score
        expr: (
          (1 - loyalty:http_error_rate) * 0.4 +
          (1 / loyalty:http_response_time_95th) * 0.3 +
          (up) * 0.3
        ) * 100