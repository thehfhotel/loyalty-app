# Production docker-compose override
# Used for production deployments via GitHub Actions
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# version: '3.8'  # Version is inherited from docker-compose.yml

services:
  backend:
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      # All secrets will be injected via environment variables by GitHub Actions
    volumes:
      # Remove development volume mounts for production
      - backend_logs:/app/logs
      - backend_storage:/app/storage
    command: sh -c "if [ -f dist/index.js ]; then npm start; else npx tsx src/index.ts; fi"  # Use compiled version if available, otherwise run with tsx
    restart: unless-stopped

  frontend:
    environment:
      NODE_ENV: production
    volumes:
      # Remove development volume mounts for production
      - frontend_logs:/app/logs
    command: sh -c "if [ -d dist ]; then serve -s dist -l 3000; else npm run build && serve -s dist -l 3000; fi"
    restart: unless-stopped

  postgres:
    restart: unless-stopped
    # Remove port exposure for production security
    ports: []

  redis:
    restart: unless-stopped
    # Remove port exposure for production security  
    ports: []

  nginx:
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx

# Add production-specific volumes
volumes:
  backend_logs:
  backend_storage:
  frontend_logs:
  nginx_logs: