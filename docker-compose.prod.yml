# Production docker-compose override
# Used for production deployments via GitHub Actions
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# version: '3.8'  # Version is inherited from docker-compose.yml

services:
  backend:
    build:
      target: runner  # Use production-optimized runner stage instead of development
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL}
      CORS_ORIGINS: ${CORS_ORIGINS}

      # Core secrets
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      BACKEND_URL: ${BACKEND_URL}

      # OAuth Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET}
      FACEBOOK_CALLBACK_URL: ${FACEBOOK_CALLBACK_URL}
      LINE_CHANNEL_ID: ${LINE_CHANNEL_ID}
      LINE_CHANNEL_SECRET: ${LINE_CHANNEL_SECRET}
      LINE_CALLBACK_URL: ${LINE_CALLBACK_URL}

      # Azure Translation Service
      AZURE_TRANSLATION_TEXT_URI: ${AZURE_TRANSLATION_TEXT_URI}
      AZURE_TRANSLATION_KEY_1: ${AZURE_TRANSLATION_KEY_1}
      AZURE_TRANSLATION_KEY_2: ${AZURE_TRANSLATION_KEY_2}
      AZURE_TRANSLATION_REGION: ${AZURE_TRANSLATION_REGION}

      # Loyalty System Configuration
      LOYALTY_USERNAME: ${LOYALTY_USERNAME}
      LOYALTY_PASSWORD: ${LOYALTY_PASSWORD}
    volumes:
      # Remove development volume mounts for production
      - backend_logs:/app/logs
      - backend_storage:/app/storage
    command: sh -c "if [ -f dist/index.js ]; then npm start; else npx tsx src/index.ts; fi"  # Use compiled version if available, otherwise run with tsx
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  frontend:
    environment:
      NODE_ENV: production
      VITE_API_URL: ${VITE_API_URL}
    volumes:
      # Remove development volume mounts for production
      - frontend_logs:/app/logs
    command: sh -c "echo 'Building frontend for production...' && npm run build && echo 'Starting preview server...' && npm run preview -- --host 0.0.0.0 --port 3000"
    restart: unless-stopped

  postgres:
    restart: unless-stopped
    # Remove port exposure for production security
    ports: []

  redis:
    restart: unless-stopped
    # Remove port exposure for production security  
    ports: []

  nginx:
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx

# Add production-specific volumes
volumes:
  backend_logs:
  backend_storage:
  frontend_logs:
  nginx_logs: