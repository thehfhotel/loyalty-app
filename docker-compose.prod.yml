# Production docker-compose override
# Used for production deployments via GitHub Actions
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# SECURITY: All secrets loaded from .env.production file (NOT committed to git)
# Never commit secrets directly to this file - use env_file or GitHub Secrets

services:
  backend:
    build:
      target: runner  # Use production-optimized runner stage instead of development
    env_file:
      - .env.production  # Load all secrets from .env.production (gitignored)
    environment:
      # Non-sensitive configuration (safe to commit)
      NODE_ENV: production
      LOG_LEVEL: info
      CORS_ORIGINS: ""
      FRONTEND_URL: "https://loyalty.saichon.com"
      BACKEND_URL: "https://loyalty.saichon.com/api"

      # Database URLs (container-internal, safe to commit)
      DATABASE_URL: "postgresql://loyalty:loyalty_pass@postgres:5432/loyalty_db"
      REDIS_URL: "redis://redis:6379"

      # OAuth Callback URLs (public URLs, safe to commit)
      GOOGLE_CALLBACK_URL: "https://loyalty.saichon.com/api/oauth/google/callback"
      FACEBOOK_CALLBACK_URL: "https://loyalty.saichon.com/api/oauth/facebook/callback"
      LINE_CALLBACK_URL: "https://loyalty.saichon.com/api/oauth/line/callback"

      # Azure Translation Service URI (public endpoint, safe to commit)
      AZURE_TRANSLATION_TEXT_URI: "https://api.cognitive.microsofttranslator.com"
      AZURE_TRANSLATION_REGION: "global"

      # All secrets (JWT_SECRET, GOOGLE_CLIENT_SECRET, etc.) loaded from .env.production via env_file above
    volumes:
      # Remove development volume mounts for production
      - backend_logs:/app/logs
      - backend_storage:/app/storage
    command: ["npm", "run", "dev"]  # Use tsx (runner stage has dev deps until Dockerfile is fixed)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  frontend:
    environment:
      NODE_ENV: production
      VITE_API_URL: "https://loyalty.saichon.com/api"
    volumes:
      # Remove development volume mounts for production
      - frontend_logs:/app/logs
    command: sh -c "echo 'Building frontend for production...' && npm run build && echo 'Starting preview server...' && npm run preview -- --host 0.0.0.0 --port 3000"
    restart: unless-stopped

  postgres:
    restart: unless-stopped
    # Remove port exposure for production security
    ports: []

  redis:
    restart: unless-stopped
    # Remove port exposure for production security
    ports: []

  nginx:
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx

# Add production-specific volumes
volumes:
  backend_logs:
  backend_storage:
  frontend_logs:
  nginx_logs:
