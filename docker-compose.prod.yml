# Production docker-compose override
# Used for production deployments via GitHub Actions
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# SECURITY: All secrets injected from GitHub Secrets via workflow
# GitHub Actions workflow sets environment variables in .env file
# This file does NOT hardcode any secrets - all loaded from .env at runtime

services:
  postgres:
    container_name: loyalty_postgres_production
    restart: unless-stopped
    ports:
      - "5434:5432"  # Production PostgreSQL port

  redis:
    container_name: loyalty_redis_production
    restart: unless-stopped
    ports:
      - "6379:6379"  # Production Redis port

  backend:
    container_name: loyalty_backend_production
    build:
      target: runner  # Use production-optimized runner stage with Rust binary
    environment:
      # Environment variables are loaded from .env file created by GitHub Actions
      # The workflow injects secrets from GitHub Secrets into .env
      # Non-sensitive defaults only (all secrets come from .env)

      RUST_ENV: ${RUST_ENV:-production}
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${BACKEND_PORT:-4001}
      RUST_LOG: ${RUST_LOG:-info}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Secrets (loaded from .env created by GitHub Actions)
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}

      # Database & Redis
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}

      # URLs
      FRONTEND_URL: ${FRONTEND_URL}
      BACKEND_URL: ${BACKEND_URL}

      # OAuth Secrets
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      LINE_CLIENT_ID: ${LINE_CHANNEL_ID}
      LINE_CLIENT_SECRET: ${LINE_CHANNEL_SECRET}
      LINE_CALLBACK_URL: ${LINE_CALLBACK_URL}

      # Email Service (SMTP/IMAP)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      IMAP_HOST: ${IMAP_HOST:-}
      IMAP_PORT: ${IMAP_PORT:-993}
      IMAP_USER: ${IMAP_USER:-}
      IMAP_PASS: ${IMAP_PASS:-}
    volumes:
      # Remove development volume mounts for production
      - backend_logs:/app/logs
      - backend_storage:/app/storage
    # Use Dockerfile CMD (/app/loyalty-backend) - no override needed
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  frontend:
    container_name: loyalty_frontend_production
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      VITE_API_URL: ${VITE_API_URL}
    volumes:
      # GHCR frontend uses nginx:alpine with logs at /var/log/nginx
      - frontend_logs:/var/log/nginx
    # Command is set in docker-compose.ghcr.yml for GHCR deployments
    # For local builds without GHCR, use: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
    restart: unless-stopped

  nginx:
    container_name: loyalty_nginx_production
    restart: unless-stopped
    ports:
      - "4001:80"  # Production Nginx port
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx

# Add production-specific volumes
volumes:
  backend_logs:
  backend_storage:
  frontend_logs:
  nginx_logs:
