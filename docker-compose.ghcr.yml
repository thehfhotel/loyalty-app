# GHCR Image Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.ghcr.yml -f docker-compose.prod.yml up -d
#
# This file overrides the build: directives with image: directives to use pre-built
# images from GitHub Container Registry instead of building locally.
#
# When both 'build:' and 'image:' are specified, Docker Compose uses 'image:' for pulling
# and only builds if the image doesn't exist. With pre-built GHCR images, this works correctly.
#
# Environment variable IMAGE_TAG specifies the image tag (commit SHA or 'latest')
# Example: IMAGE_TAG=abc1234 docker compose -f ... up -d

services:
  backend:
    image: ghcr.io/thehfhotel/loyalty-app/backend:${IMAGE_TAG:-latest}
    # Rust binary runs directly from Dockerfile CMD (/app/loyalty-backend)
    # No entrypoint/command override needed - the Dockerfile sets the correct CMD
    # Clear volume mounts that would override container contents with empty local directories
    volumes:
      - backend_logs:/app/logs
      - backend_storage:/app/storage

  frontend:
    image: ghcr.io/thehfhotel/loyalty-app/frontend:${IMAGE_TAG:-latest}
    # Override command to listen on port 3000 (main nginx expects frontend:3000)
    # The GHCR production image uses internal nginx on port 80, so we modify the config
    command: ["/bin/sh", "-c", "sed -i 's/listen 80/listen 3000/' /etc/nginx/nginx.conf && nginx -g 'daemon off;'"]
    # Clear volume mounts for frontend too
    volumes:
      - frontend_logs:/var/log/nginx

volumes:
  backend_logs:
  backend_storage:
  frontend_logs:
